<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS - Contact Center Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script src="workforceManagement.js"></script>

    <style>
        /* ... (styles remain the same) ... */
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        </div>

    <div id="appContainer" class="page">
        <aside class="sidebar">
            </aside>

        <main class="main-content">
            <div id="adminPage" class="content-module">
                <h2>Create System User Account</h2>
                <p>Use this section to create new user accounts that can log in to the Attendance Management System. These users can then be assigned roles and added as staff members to be managed in the attendance register.</p>
                <hr>
                <form id="addMemberForm">
                    <div class="input-group">
                        <label for="fullName">Full Name:</label>
                        <input type="text" id="fullName" placeholder="e.g., Alice Johnson" required>
                    </div>
                    <div class="input-group">
                        <label for="newEmail">Email:</label>
                        <input type="email" id="newEmail" placeholder="e.g., alice@example.com" required>
                    </div>
                    <div class="input-group">
                        <label for="newPassword">Password:</label>
                        <input type="password" id="newPassword" placeholder="********" required>
                    </div>
                    <div class="input-group">
                        <label for="memberRole">Role:</label>
                        <select id="memberRole" required>
                            <option value="">Select Role</option>
                            <option value="Agent">Agent</option>
                            <option value="QA">QA</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Admin">Admin</option>
                            <option value="Team Leader">Team Leader</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> Create System User</button>
                    <p id="addMemberMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                </form>

                <div class="staff-management-section">
                    <h2>Manage Attendance Roster</h2>
                    <p>This table lists all staff members who appear in the daily attendance marking and reports. You can add new staff or manage existing ones here.</p>
                    <hr>

                    <h3>Add New Staff Member</h3>
                    <form id="addStaffForm">
                        <div class="input-group">
                            <label for="staffFullName">Full Name:</label>
                            <input type="text" id="staffFullName" placeholder="e.g., Bob Williams" required>
                        </div>
                        <div class="input-group">
                            <label for="staffRole">Role:</label>
                            <select id="staffRole" required>
                                <option value="">Select Role</option>
                                <option value="Agent">Agent</option>
                                <option value="QA">QA</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Team Leader">Team Leader</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="staffSecondaryRole">Secondary Role:</label>
                            <select id="staffSecondaryRole">
                                <option value="">None</option>
                                <option value="Inbound">Inbound</option>
                                <option value="Inbound / Email">Inbound / Email</option>
                                <option value="Social Media">Social Media</option>
                                <option value="LiveChat">LiveChat</option>
                                <option value="Sales">Sales</option>
                                <option value="Onboarding">Onboarding</option>
                                <option value="Level 1 Escalations">Level 1 Escalations</option>
                                <option value="Email">Email</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add Staff Member</button>
                        <p id="addStaffMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                    </form>

                    <h3>Existing Staff Members</h3>
                    <div class="staff-list-table-container">
                        <table class="staff-list-table">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Secondary Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffListTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig ={
            // ... (Firebase config) ...
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global Variables / Caches ---
        let loggedInUser = null;
        let loggedInUserRole = 'Agent';
        let usersData = {}; // User login accounts
        const staffData = {}; // Staff members for attendance
        const attendanceData = {};
        const markedDates = new Set();
        let activeAgents = []; // Now based on `staffData`

        const todayGlobal = new Date();

        // --- DOM Element References ---
        let DOM = {};

        // --- Constants and Utility Data ---
        const ATTENDANCE_STATUSES = [
            // ... (statuses) ...
        ];
        const ALL_ROLES = ["Agent", "QA", "Supervisor", "Team Leader", "Admin"];
        const ALL_SECONDARY_ROLES = ['Inbound', 'Inbound / Email', 'Social Media', 'LiveChat', 'Sales', 'Onboarding', 'Level 1 Escalations', 'Email', 'None'];

        // --- Core Helper Functions ---

        /**
         * Updates the global activeAgents list based on the current staffData cache.
         */
        function updateActiveAgentsList() {
            activeAgents = Object.values(staffData)
                .filter(staff => staff.isActive)
                .sort((a, b) => a.fullName.localeCompare(b.fullName));
            console.log("Active agents list updated:", activeAgents.length, "active agents.");
        }

        /**
         * Fetches all user profiles from Firestore and populates the usersData cache.
         * This now fetches system users.
         * @returns {Promise<void>}
         */
        async function fetchAllUsersData() {
            usersData = {};
            try {
                const usersSnapshot = await db.collection('users').get();
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersData[userData.email] = {
                        uid: doc.id,
                        fullName: userData.fullName,
                        role: userData.role,
                        email: userData.email,
                        isActive: userData.isActive
                    };
                });
                console.log("All system user data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching users from Firestore:", error.code, error.message);
                alert("Critical: Could not load user list from database. Check console and Firebase rules.");
            }
        }

        /**
         * Fetches all staff members from Firestore and populates the staffData cache.
         * This is the new source for the attendance roster.
         * @returns {Promise<void>}
         */
        async function fetchAllStaffData() {
            staffData = {};
            try {
                const staffSnapshot = await db.collection('staff').get();
                staffSnapshot.forEach(doc => {
                    const staffMember = doc.data();
                    staffData[doc.id] = {
                        staffId: doc.id,
                        fullName: staffMember.fullName,
                        role: staffMember.role,
                        secondaryRole: staffMember.secondaryRole,
                        isActive: staffMember.isActive
                    };
                });
                updateActiveAgentsList();
                console.log("All staff data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching staff from Firestore:", error.code, error.message);
                alert("Critical: Could not load staff list from database. Check console and Firebase rules.");
            }
        }

        /**
         * Fetches all attendance records from Firestore and populates the attendanceData and markedDates caches.
         * @returns {Promise<void>}
         */
        async function fetchAttendanceData() {
            // ... (unchanged logic) ...
        }

        /**
         * Sets the logged-in state of the application and updates UI visibility.
         */
        function setLoggedInState(loggedIn, user = null, userProfile = null) {
            // ... (unchanged logic for login state and page switching) ...

            if (loggedIn && user && userProfile) {
                // ... (existing logic) ...
                if (Object.keys(usersData).length === 0 || Object.keys(staffData).length === 0 || Object.keys(attendanceData).length === 0) {
                    Promise.all([
                        fetchAllUsersData(),
                        fetchAllStaffData(),
                        fetchAttendanceData(),
                        fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth()),
                        fetchShiftScheduleData(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth())
                    ]).then(() => {
                        // ... (existing logic for rendering after fetch) ...
                    }).catch(err => {
                        console.error("Error during initial data fetch:", err);
                        alert("Failed to load initial application data.");
                    });
                } else {
                    // ... (existing logic for rendering from cache) ...
                }
            } else {
                // ... (logout logic) ...
            }
        }

        /**
         * Shows the specified content page and updates navigation links.
         * @param {string} pageId - The ID of the page to show (e.g., 'homePage').
         */
        function showPage(pageId) {
            // ... (existing logic for page switching) ...
            
            switch (pageId) {
                // ... (existing cases) ...
                case 'adminPage':
                    renderUserList(); // Render system users
                    renderStaffList(); // Render staff members
                    break;
                // ... (existing cases) ...
            }
        }

        // --- Admin Add/Manage User & Staff Logic ---

        /**
         * Renders the system user list table in the Admin page.
         */
        function renderUserList() {
            // ... (existing logic, updated to use usersData) ...
        }
        
        /**
         * Renders the staff member list table in the Admin page.
         */
        function renderStaffList() {
            DOM.staffListTableBody.innerHTML = '';

            const sortedStaff = Object.values(staffData).sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (sortedStaff.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align: center;">No staff members found.</td>`;
                DOM.staffListTableBody.appendChild(tr);
                return;
            }

            sortedStaff.forEach(staff => {
                const tr = document.createElement('tr');

                const statusSelect = document.createElement('select');
                // ... (status select logic) ...

                const deleteButton = document.createElement('button');
                // ... (delete button logic) ...
                deleteButton.addEventListener('click', () => {
                    deleteStaff(staff.staffId);
                });

                tr.innerHTML = `
                    <td>${staff.fullName}</td>
                    <td>${staff.role}</td>
                    <td>${staff.secondaryRole}</td>
                    <td></td>
                    <td></td>
                `;
                tr.children[3].appendChild(statusSelect);
                tr.children[4].appendChild(deleteButton);

                DOM.staffListTableBody.appendChild(tr);
            });
        }
        
        // ... (other functions) ...
    </script>
</body>
</html>
