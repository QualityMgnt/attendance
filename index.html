<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS - Contact Center Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <style>
        /* Basic styles for demonstration, ideally these would be in style.css */
        body {
            font-family: 'Garamond', serif; /* Changed to Garamond */
            margin: 0;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        /* Login page specific background color */
        #loginPage.active {
            background-color: #800080; /* Purple for login page */
        }

        /* Re-apply Poppins to specific elements where it enhances readability (e.g., buttons, smaller text) */
        .btn, .main-nav a, .input-group label, .input-group input, .input-group select, .stat-card h3, .user-role, .dashboard-header-card .label, .dashboard-header-card .value, .dashboard-section-title, .dashboard-card-new h3, .gauge-label, .bar-chart-month-labels div, .chart-grid .label, .donut-chart-label, .donut-legend-item, .employee-bar-item, .summary-stat-card h4, .summary-stat-card .count, .monthly-bar-label, .chart-legend {
            font-family: 'Poppins', sans-serif;
        }


        .page {
            display: none;
            width: 100%;
            height: 100vh;
        }

        .page.active {
            display: flex;
        }

        /* Login Page */
        .login-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 380px;
            max-width: 90%;
            margin: auto; /* Center it */
        }

        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group select,
        .input-group input[type="date"],
        .input-group input[type="time"] { /* Added time input */
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
        }

        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
        }

        .success-message {
            color: #28a745;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
        }

        /* App Container Layout */
        .app-container {
            display: flex;
            width: 100%;
            max-width: 1400px; /* Max width for the whole app */
            height: 100vh;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: #800080; /* Changed to purple */
            color: white;
            padding: 25px 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar .logo {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 40px;
            color: white; /* Changed to white as requested */
        }

        .main-nav ul {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .main-nav li {
            margin-bottom: 10px;
        }

        .main-nav a {
            display: flex;
            align-items: center;
            color: #ecf0f1;
            text-decoration: none;
            padding: 15px 30px;
            font-size: 17px;
            transition: background-color 0.3s, color 0.3s;
        }

        .main-nav a i {
            margin-right: 15px;
            font-size: 20px;
        }

        .main-nav a:hover,
        .main-nav a.active {
            background-color: #9932CC; /* Darker purple on hover/active */
            color: #ffffff;
            border-left: 5px solid #007bff;
            padding-left: 25px; /* Adjust for border */
        }

        .logout-btn {
            margin-top: auto; /* Pushes it to the bottom */
            width: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn i {
            margin-right: 10px;
        }


        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
        }

        .top-system-bar {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            font-size: 28px; /* Changed font size */
            font-weight: 500;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .app-header {
            background-color: #ffffff;
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .app-header h1 {
            margin: 0;
            font-size: 26px;
            color: #2c3e50;
            font-weight: 600;
        }

        .user-info {
            font-size: 16px;
            color: #555;
        }

        .user-info strong {
            color: #2c3e50;
            margin-right: 5px;
        }

        .user-role {
            background-color: #e9ecef;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
            color: #6c757d;
        }

        .content-module {
            padding: 30px;
            flex-grow: 1;
            overflow-y: auto; /* Enable scrolling for content */
            display: none; /* Hidden by default */
        }

        .content-module.active {
            display: block; /* Shown when active */
        }

        .content-module h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 24px;
            font-weight: 600;
        }

        .content-module hr {
            border: 0;
            height: 1px;
            background-color: #eee;
            margin-bottom: 25px;
        }

        /* Home Page Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #007bff;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        /* Notifications */
        .notifications-list {
            margin-top: 20px;
        }

        .notification-item {
            background-color: #ffffff;
            border-left: 5px solid;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }

        .notification-item:hover {
            transform: translateY(-2px);
        }

        .notification-item.success { border-color: #28a745; }
        .notification-item.info { border-color: #17a2b8; }
        .notification-item.warning { border-color: #ffc107; }
        .notification-item.danger { border-color: #dc3545; }

        .notification-icon {
            font-size: 24px;
            margin-right: 15px;
            line-height: 1; /* Aligns icon better */
        }

        .notification-item.success .notification-icon { color: #28a745; }
        .notification-item.info .notification-icon { color: #17a2b8; }
        .notification-item.warning .notification-icon { color: #ffc107; }
        .notification-item.danger .notification-icon { color: #dc3545; }

        .notification-item p {
            margin: 0;
            color: #495057;
            line-height: 1.4;
        }

        /* Styles for Attendance Marking Section */
        .mark-attendance-section {
            display: flex;
            align-items: flex-end; /* Align button to bottom of input */
            gap: 20px;
            margin-bottom: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .mark-attendance-section .input-group {
            margin-bottom: 0; /* Remove default margin from input group */
            flex-grow: 1; /* Allow input group to take available space */
        }

        /* Modal Styles (General for both attendance and calendar) */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            padding-top: 50px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 22px;
        }

        .modal-table-container {
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            flex-grow: 1;
        }

        #modalAttendanceTable {
            width: 100%;
            border-collapse: collapse;
        }

        #modalAttendanceTable th,
        #modalAttendanceTable td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        #modalAttendanceTable th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        #modalAttendanceTable td:last-child select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }
        .modal-buttons .btn {
            margin-left: 10px;
        }

        /* Calendar Modal Specific Styles */
        #calendarModal .modal-content {
            max-width: 400px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header button {
            background: none;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .calendar-header button:hover {
            background-color: #e9ecef;
        }

        .calendar-header h3 {
            margin: 0;
            font-size: 20px;
            color: #2c3e50;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .calendar-weekdays div {
            padding: 8px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .calendar-day {
            padding: 10px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
            color: #495057;
        }

        .calendar-day:hover:not(.empty):not(.disabled):not(.selected) {
            background-color: #e9ecef;
        }

        .calendar-day.empty {
            visibility: hidden;
        }

        .calendar-day.today {
            background-color: #007bff;
            color: white;
            font-weight: 700;
        }

        .calendar-day.selected {
            background-color: #28a745;
            color: white;
            font-weight: 700;
        }

        .calendar-day.disabled {
            background-color: #f0f0f0;
            color: #a0a0a0;
            cursor: not-allowed;
            text-decoration: line-through;
        }


        /* Toolbar for Attendance Table */
        .attendance-table-toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        /* Attendance Table */
        .attendance-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .attendance-overview-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1000px;
        }

        .attendance-overview-table th,
        .attendance-overview-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }

        .attendance-overview-table th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .attendance-overview-table td:last-child,
        .attendance-overview-table th:last-child {
            border-right: none;
        }

        .attendance-overview-table tr:last-child td {
            border-bottom: none;
        }

        .attendance-overview-table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .attendance-cell {
            position: relative;
            padding: 0;
            background-color: #fcfcfc;
        }

        .attendance-status-select {
            width: 100%;
            height: 100%;
            padding: 8px 10px;
            border: none;
            background-color: transparent;
            font-size: 15px;
            color: #333;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            outline: none;
        }


        /* Status Guide */
        .attendance-status-guide {
            background-color: #f1f7fe;
            border: 1px solid #d0e7ff;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-top: 20px;
        }

        .attendance-status-guide h3 {
            width: 100%;
            margin-top: 0;
            margin-bottom: 15px;
            color: #007bff;
            font-size: 18px;
        }

        .attendance-status-guide p {
            margin: 0;
            display: flex;
            align-items: center;
            color: #555;
            font-size: 15px;
        }

        .status-indicator-guide {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Status Colors for table cells and guide */
        .status-WFO { background-color: #28a745; color: white; } /* Present, Work From Office */
        .status-WFH { background-color: #17a2b8; color: white; } /* Present, Work From Home (changed from info to match UI) */
        .status-SO { background-color: #6f42c1; color: white; }
        .status-L { background-color: #ffc107; color: #333; } /* Leave (changed from info to warning) */
        .status-DO { background-color: #6c757d; color: white; }
        .status-UL { background-color: #dc3545; color: white; }
        .status-NCNS { background-color: #fd7e14; color: white; } /* No Call No Show (changed from warning to orange) */
        .status-CL { background-color: #20c997; color: white; } /* Compassionate Leave (changed to a different green) */
        .status-SOF { background-color: #dc3545; color: white; } /* Sick Off (changed from danger for consistency) */


        /* Dashboard Styles (New) */
        .dashboard-container {
            padding: 20px;
            background-color: #f4f7f6;
            display: grid;
            gap: 2mm; /* Changed to 2mm as requested */
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            align-items: start;
        }

        .dashboard-header-row {
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .dashboard-header-card {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header-card.employee-name {
            background-color: #28a745;
        }

        .dashboard-header-card i {
            font-size: 30px;
        }

        .dashboard-header-card div {
            display: flex;
            flex-direction: column;
        }

        .dashboard-header-card .label {
            font-size: 14px;
            opacity: 0.8;
        }

        .dashboard-header-card .value {
            font-size: 22px;
            font-weight: 600;
        }

        .dashboard-header-card select {
            /* Styles for the Employee Name dropdown to look presentable */
            background-color: rgba(255, 255, 255, 0.3); /* Slightly transparent white */
            border: 1px solid rgba(255, 255, 255, 0.5); /* Lighter border */
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            outline: none;
            appearance: none; /* Remove default arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            flex-grow: 1;
            /* Custom arrow for select (optional, but makes it look nicer) */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.9c-3.2%2C3.2-8.3%2C3.2-11.5%2C0L146.2%2C68.9L16.9%2C197.9c-3.2%2C3.2-8.3%2C3.2-11.5%2C0c-3.2-3.2-3.2-8.3%2C0-11.5l135.5-135.5c3.2-3.2%2C8.3-3.2%2C11.5%2C0l135.5%2C135.5C290.2%2C189.6%2C290.2%2C194.7%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
        }

        .dashboard-header-card select option {
            background-color: #28a745; /* Background for options in the dropdown */
            color: white;
        }

        .dashboard-section-title {
            grid-column: 1 / -1;
            font-size: 22px;
            color: #2c3e50;
            margin-top: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .dashboard-card-new {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }

        .dashboard-card-new h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Gauge styles (simplified static representation) */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 15px;
        }

        .gauge {
            width: 100px;
            height: 50px;
            border-radius: 100px 100px 0 0;
            border: 5px solid #e0e0e0;
            border-bottom: none;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: bottom center;
            transition: transform 0.5s ease-in-out;
            background-color: #007bff;
            border-radius: 100px 100px 0 0;
        }

        .gauge-label {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }

        /* Specific gauge colors */
        /* These transforms will be set dynamically by JS based on calculated percentage */
        .gauge-overall .gauge-fill { background-color: #007bff; }


        /* Bar Chart styles (simplified static representation) */
        .bar-chart-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 5px;
            height: 200px;
            padding-top: 10px;
            position: relative;
        }

        .bar-chart-month-labels {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
            color: #777;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }

        .bar-chart-month-labels > div {
            flex: 1;
            text-align: center;
        }

        .bar-group {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            border-left: 1px solid #eee;
            padding-left: 5px;
        }

        .bar {
            width: 15px;
            background-color: #007bff;
            margin: 0 2px;
            transition: height 0.3s ease;
            position: relative;
        }

        .bar.late { background-color: #dc3545; }
        .bar.absent { background-color: #ffc107; }
        .bar.on-time-bar { background-color: #007bff; }


        /* Specific chart layouts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .chart-grid > div {
            text-align: center;
        }
        .chart-grid .value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        .chart-grid .label {
            font-size: 14px;
            color: #6c757d;
        }

        /* Donut Chart (simplified static representation) */
        .donut-chart-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            /* background will be set dynamically by JS */
            margin: 0 auto 15px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        .donut-chart-center {
            position: absolute;
            width: 70px;
            height: 70px;
            background-color: #fff;
            border-radius: 50%;
        }
        .donut-chart-label {
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 14px;
            margin-top: 10px;
        }
        .donut-legend-item {
            display: flex;
            align-items: center;
        }
        .donut-legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
        }

        /* Top Employees Bar Chart */
        .top-employees-chart {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding-top: 10px;
        }
        .employee-bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 15px;
            color: #495057;
        }
        .employee-name-label {
            width: 100px;
            text-align: right;
            margin-right: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .employee-bar-track {
            flex-grow: 1;
            height: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            width: 0%; /* Will be set by JS */
            transition: width 0.5s ease-out;
        }
        .employee-bar-value {
            margin-left: 10px;
            font-weight: 600;
            color: #2c3e50;
            min-width: 30px;
        }
        /* Remove hardcoded percentages, will be dynamic */


        /* Leave Tracker Specific Styles */
        .leave-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leave-tracker-header h3 {
            margin: 0;
            font-size: 22px;
            color: #2c3e50;
        }

        .leave-tracker-table-container {
            overflow-x: auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
        }

        .leave-planner-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 1200px; /* Ensure enough width for all days */
        }

        .leave-planner-table th,
        .leave-planner-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 5px;
            text-align: center;
            white-space: nowrap; /* Prevent wrapping in date cells */
            position: relative; /* For overlay */
        }

        .leave-planner-table thead th {
            background-color: #f0f0f0;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .leave-planner-table tbody td {
            background-color: #fff;
            color: #555;
        }

        .leave-planner-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .leave-planner-table td:first-child, /* No. column */
        .leave-planner-table td:nth-child(2), /* Name column */
        .leave-planner-table td:nth-child(3), /* Opening Balance */
        .leave-planner-table td:nth-child(4) { /* Leave Balance */
            text-align: left;
            padding-left: 10px;
            font-weight: 500;
            background-color: #e9f5ff; /* Light blue for fixed columns */
            position: sticky;
            left: 0;
            z-index: 1;
        }
        .leave-planner-table th:first-child,
        .leave-planner-table th:nth-child(2),
        .leave-planner-table th:nth-child(3),
        .leave-planner-table th:nth-child(4) {
            text-align: left;
            padding-left: 10px;
            background-color: #d0e7ff; /* Darker blue for fixed headers */
            position: sticky;
            left: 0;
            z-index: 3; /* Higher z-index to stay on top of scrolling content */
        }

        /* Specific styling for 'L' cells */
        .leave-planner-table td.leave-cell {
            background-color: #d4edda; /* Light green for leave */
            font-weight: bold;
            color: #155724;
        }
        /* Styling for total leaves row */
        .leave-planner-table tfoot td {
            background-color: #f0f0f0;
            font-weight: 600;
            color: #333;
            border-top: 2px solid #ccc;
        }
        .leave-planner-table tfoot td:nth-child(-n+4) {
            background-color: #d0e7ff; /* Match fixed header background */
        }

        /* Leave Approval Overlay */
        .leave-approval-overlay {
            position: absolute;
            top: -35px; /* Position above the cell */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: flex;
            gap: 10px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 10; /* Above table content */
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            pointer-events: auto; /* Allow interaction */
        }
        .leave-approval-overlay button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .leave-approval-overlay button:hover {
            background-color: white;
            color: #000;
        }
        .leave-approval-overlay .approve-btn { border-color: #28a745; color: #28a45; }
        .leave-approval-overlay .approve-btn:hover { background-color: #28a745; color: white; }
        .leave-approval-overlay .decline-btn { border-color: #dc3545; color: #dc3545; }
        .leave-approval-overlay .decline-btn:hover { background-color: #dc3545; color: white; }

        .leave-planner-table td.approved-leave {
            background-color: #c3e6cb; /* Lighter green for approved */
            color: #155724;
            font-weight: bold;
            cursor: not-allowed;
        }
        .leave-planner-table td.declined-leave {
            background-color: #f8d7da; /* Light red for declined */
            color: #721c24;
            font-weight: bold;
            cursor: not-allowed;
        }
        .leave-planner-table td.pending-leave {
            background-color: #ffeeba; /* Light yellow for pending */
            color: #856404;
        }


        /* Admin Staff Management */
        .staff-management-section {
            margin-top: 40px;
        }

        .staff-list-table-container {
            overflow-x: auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
        }

        .staff-list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        .staff-list-table th,
        .staff-list-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
        }

        .staff-list-table th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
        }

        .staff-list-table td select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .staff-list-table td .btn {
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
        .staff-status-active { color: #28a745; font-weight: 600;}
        .staff-status-inactive { color: #dc3545; font-weight: 600;}

        /* Individual Summary Page */
        .individual-summary-controls {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .individual-summary-controls .input-group {
            margin-bottom: 0;
            flex-grow: 1;
        }

        .summary-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-stat-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        .summary-stat-card h4 {
            margin: 0;
            font-size: 16px;
            color: #555;
        }
        .summary-stat-card .count {
            font-size: 36px;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 10px;
        }

        .individual-summary-chart-container {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .individual-summary-chart-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
        }
        .monthly-bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            width: 100%;
            height: 200px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            gap: 10px;
        }
        .monthly-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            flex: 1;
        }
        .monthly-bar {
            width: 25px;
            margin-bottom: 2px;
            transition: height 0.3s ease-out;
        }
        .monthly-bar.wfo { background-color: #007bff; }
        .monthly-bar.wfh { background-color: #28a745; }
        .monthly-bar-label {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            text-align: center;
        }
        .chart-legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .report-filters .input-group {
            margin-bottom: 0;
            flex-basis: 180px; /* Adjust as needed for layout */
            flex-grow: 1;
        }

        .report-filters button {
            align-self: flex-end; /* Align buttons to the bottom of the flex container */
            padding: 10px 20px;
            height: fit-content;
        }

        .report-results table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden; /* Ensures rounded corners apply to content */
        }

        .report-results th,
        .report-results td {
            border: 1px solid #eee;
            padding: 12px 15px;
            text-align: left;
        }

        .report-results th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
        }

        .report-results tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .report-results tbody tr:hover {
            background-color: #f1f1f1;
        }

        /* Shift Schedule Specific Styles */
        .shift-schedule-controls { /* Renamed from filters */
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            flex-wrap: wrap;
        }

        .shift-schedule-controls .input-group {
            margin-bottom: 0;
            flex-grow: 1;
            min-width: 150px;
        }

        .shift-schedule-table-container {
            overflow-x: auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
            margin-bottom: 30px;
        }

        .shift-schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 1200px; /* Ensure horizontal scroll if many columns */
        }

        .shift-schedule-table th,
        .shift-schedule-table td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }

        .shift-schedule-table thead th {
            background-color: #f0f0f0;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 2;
        }
        /* Specific styling for the monthly headers (July, August etc.) */
        .shift-schedule-table th.month-header {
            text-align: center;
            background-color: #e9f5ff; /* Light blue for monthly headers */
            font-size: 15px;
        }
         /* Specific styling for nested headers within a month (Shift Start, Break etc.) */
        .shift-schedule-table th.sub-header {
            background-color: #d0e7ff; /* Darker blue for sub headers */
            font-weight: 500;
            font-size: 13px;
            text-align: center;
        }

        .shift-schedule-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        /* Styles for shift cells */
        .shift-schedule-table td .shift-details-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            min-width: 150px; /* Ensure some width for dropdowns */
        }
        .shift-schedule-table td .shift-details-group select,
        .shift-schedule-table td .shift-details-group input {
            width: 100%;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .shift-schedule-table td .shift-details-group span {
            font-size: 13px;
            color: #555;
            padding: 5px;
            background-color: #f5f5f5;
            border-radius: 4px;
        }


        .shift-schedule-table td.overtime {
            background-color: #ffcccc; /* Light red for overtime */
            color: #cc0000;
            font-weight: bold;
        }

        .shift-schedule-table td.compliant {
            background-color: #d4edda; /* Light green for compliant */
            color: #155724;
        }

        .shift-schedule-table td.swap-requested {
            background-color: #ffeeba; /* Light yellow for pending swap */
            color: #856404;
            cursor: pointer;
        }

        .shift-schedule-table td.swapped {
            background-color: #e2f0fb; /* Light blue for swapped */
            color: #0056b3;
            text-decoration: line-through;
        }

        .shift-schedule-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .shift-schedule-dashboard .dashboard-card-new {
            min-height: 200px; /* Ensure cards have some height */
        }
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <div class="login-container">
            <h2>AMS Login</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="your.email@example.com" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="********" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="loginError" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="appContainer" class="page">
        <aside class="sidebar">
            <div class="logo">AMS</div>
            <nav class="main-nav">
                <ul>
                    <li><a href="#" data-page="home"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#" data-page="attendance"><i class="fas fa-user-check"></i> Attendance Marking</a></li>
                    <li><a href="#" data-page="leaveTracker"><i class="fas fa-calendar-alt"></i> Leave Tracker</a></li>
                    <li><a href="#" data-page="shiftSchedule"><i class="fas fa-clock"></i> Shift Schedule</a></li> <!-- New Tab -->
                    <li><a href="#" data-page="individualSummary"><i class="fas fa-user"></i> Individual Summary</a></li>
                    <li><a href="#" data-page="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="#" data-page="reports"><i class="fas fa-file-alt"></i> Reports</a></li>
                    <li id="adminNavLink" style="display:none;"><a href="#" data-page="admin"><i class="fas fa-user-plus"></i> Admin</a></li>
                </ul>
            </nav>
            <button id="logoutBtn" class="btn btn-secondary logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </aside>

        <main class="main-content">
            <div class="top-system-bar">
                ICEA LION Contact Centre Attendance Management
            </div>
            <header class="app-header">
                <h1>Welcome to Attendance Management System</h1>
                <div class="user-info">
                    <span>Hello, <strong id="loggedInUserName"></strong></span>
                    <span class="user-role" id="loggedInUserRole"></span>
                </div>
            </header>

            <div id="homePage" class="content-module active">
                <h2>Today's Statistics</h2>
                <hr>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Present</h3>
                        <p id="statTotalPresent" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Staff</h3>
                        <p id="statTotalStaff" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Agents on Leave (Week)</h3>
                        <p id="statAgentsOnLeaveWeek" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Agents on Sick Off (Week)</h3>
                        <p id="statAgentsOnSickOffWeek" class="stat-value">0</p>
                    </div>
                </div>

                <h3>Notifications</h3>
                <div class="notifications-list">
                    <div class="notification-item info">
                        <span class="notification-icon"><i class="fas fa-calendar-alt"></i></span>
                        <p>Staff on Leave This Week: <strong id="staffOnLeaveNames">No agents on leave.</strong></p>
                    </div>
                    <div class="notification-item warning">
                        <span class="notification-icon"><i class="fas fa-bed"></i></span>
                        <p>Agents on Sick Off This Week: <strong id="agentsOnSickOffNames">No agents on sick off.</strong></p>
                    </div>
                </div>
            </div>

            <div id="attendancePage" class="content-module">
                <h2>Mark Attendance</h2>
                <hr>
                <div class="mark-attendance-section">
                    <!-- Moved button to the left -->
                    <button id="openAttendanceCalendarBtn" class="btn btn-primary"><i class="fas fa-calendar-alt"></i> Select Date</button>
                    <div class="input-group">
                        <label for="attendanceDateInput">Selected Date:</label>
                        <input type="text" id="attendanceDateInput" placeholder="No date selected" readonly>
                    </div>
                    <p id="attendanceMarkingMessage" class="success-message" style="display:none; margin-top:10px;"></p>
                </div>

                <h2 style="margin-top: 40px;">Team Attendance Overview</h2>
                <hr>
                <div class="attendance-table-toolbar">
                    <button id="deleteAttendanceDataBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Delete Data</button>
                    <button id="exportAttendanceDataBtn" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export Data</button>
                </div>
                <div class="attendance-table-container" id="attendanceOverviewTableContainer">
                </div>
                <div class="attendance-status-guide">
                    <h3>Status Key:</h3>
                    <p><span class="status-indicator-guide status-WFO"></span> WFO: Work From Office</p>
                    <p><span class="status-indicator-guide status-WFH"></span> WFH: Work From Home</p>
                    <p><span class="status-indicator-guide status-SO"></span> SO: Signed Off</p>
                    <p><span class="status-indicator-guide status-L"></span> L: Leave (Annual)</p>
                    <p><span class="status-indicator-guide status-DO"></span> DO: Day Off</p>
                    <p><span class="status-indicator-guide status-UL"></span> UL: Unpaid Leave</p>
                    <p><span class="status-indicator-guide status-NCNS"></span> NCNS: No Call No Show</p>
                    <p><span class="status-indicator-guide status-CL"></span> CL: Compassionate Leave</p>
                    <p><span class="status-indicator-guide status-SOF"></span> SOF: Sick Off</p>
                </div>
            </div>

            <div id="leaveTrackerPage" class="content-module">
                <div class="leave-tracker-header">
                    <h2>Leave Tracker</h2>
                    <div>
                        <button id="prevMonthLeaveBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                        <h3 style="display:inline-block; margin: 0 15px;" id="currentLeaveMonthYear"></h3>
                        <button id="nextMonthLeaveBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <hr>
                <div class="leave-tracker-table-container" id="leaveTrackerTableContainer">
                </div>
            </div>

            <!-- New Shift Schedule Page -->
            <div id="shiftSchedulePage" class="content-module">
                <h2>Shift Schedule Management</h2>
                <hr>
                <h3>Add New Shift Assignment (In-Memory Only)</h3>
                <p>Note: Shifts added here are for demonstration and will NOT be saved to the database. They will disappear on page reload.</p>
                <form id="addShiftForm" class="shift-schedule-controls">
                    <div class="input-group">
                        <label for="newShiftAgentName">Agent Name:</label>
                        <select id="newShiftAgentName" required>
                            <option value="">Select Agent</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="newShiftRole">Role:</label>
                        <input type="text" id="newShiftRole" readonly placeholder="Auto-filled">
                    </div>
                    <div class="input-group">
                        <label for="newShiftSecondaryRole">Secondary Role:</label>
                        <input type="text" id="newShiftSecondaryRole" readonly placeholder="Auto-filled">
                    </div>
                     <div class="input-group">
                        <label for="newShiftDate">Shift Date:</label>
                        <input type="date" id="newShiftDate" required>
                    </div>
                    <div class="input-group">
                        <label for="newShiftTime">Shift Time:</label>
                        <select id="newShiftTime" required>
                            <option value="">Select Shift</option>
                            <!-- Populated dynamically -->
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="newShiftBreak">Break Time:</label>
                        <input type="text" id="newShiftBreak" readonly placeholder="Auto-filled">
                    </div>
                    <div class="input-group">
                        <label for="newShiftLunch">Lunch Break:</label>
                        <input type="text" id="newShiftLunch" readonly placeholder="Auto-filled">
                    </div>
                    <div class="input-group">
                        <label for="newShiftRemarks">Remarks:</label>
                        <input type="text" id="newShiftRemarks" placeholder="e.g., Shift Swap">
                    </div>
                    <div class="input-group">
                        <label for="newShiftSwapStatus">Swap Status:</label>
                        <select id="newShiftSwapStatus">
                            <option value="">-</option>
                            <option value="Available">Available</option>
                            <option value="Swap Requested">Swap Requested</option>
                            <option value="Swapped">Swapped</option>
                            <option value="Declined">Declined</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add Shift</button>
                    <p id="addShiftMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                </form>

                <h3 style="margin-top: 40px;">Monthly Shift Roster</h3>
                <hr>
                <div class="shift-schedule-controls">
                    <button id="prevMonthShiftScheduleBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                    <h3 style="display:inline-block; margin: 0 15px;" id="currentShiftScheduleMonthYear"></h3>
                    <button id="nextMonthShiftScheduleBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                    <div class="input-group" style="flex-basis: auto; flex-grow: 0;">
                        <label for="scheduleRoleFilter">Filter by Role:</label>
                        <select id="scheduleRoleFilter">
                            <option value="">All Roles</option>
                            <option value="Agent">Agent</option>
                            <option value="QA">QA</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Team Leader">Team Leader</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                    <button id="exportSchedulePdfBtn" class="btn btn-secondary"><i class="fas fa-file-pdf"></i> Export PDF</button>
                </div>

                <div class="shift-schedule-table-container">
                    <table class="shift-schedule-table">
                        <thead id="shiftScheduleTableHead">
                            <!-- Table headers will be dynamically generated here -->
                            <tr>
                                <th>No</th>
                                <th>Name</th>
                                <th>Role</th>
                                <th>Secondary Role</th>
                                <!-- Daily headers will be added by JS -->
                            </tr>
                        </thead>
                        <tbody id="shiftScheduleTableBody">
                            <!-- Shift schedule rows will be populated here -->
                        </tbody>
                    </table>
                </div>

                <h3>Shift Overview Dashboard (Current Month)</h3>
                <hr>
                <div class="shift-schedule-dashboard">
                    <div class="dashboard-card-new">
                        <h3>Daily Coverage Summary</h3>
                        <p>Total Shifts Scheduled: <span id="totalShiftsScheduled">0</span></p>
                        <p>Average Hours/Shift: <span id="avgHoursPerShift">0</span></p>
                        <p>Supervisors on Duty: <span id="coverageSupervisors">0</span></p>
                        <p>QAs on Duty: <span id="coverageQAs">0</span></p>
                    </div>
                    <div class="dashboard-card-new">
                        <h3>Break Distribution</h3>
                        <p>Tea Breaks: <span id="teaBreakSummary">N/A</span></p>
                        <p>Lunch Breaks: <span id="lunchBreakSummary">N/A</span></p>
                        <div class="break-load-chart" style="min-height: 100px; background-color: #f0f0f0; border-radius: 5px; display: flex; align-items: center; justify-content: center; color: #888;">
                            Break Load Chart Placeholder
                        </div>
                    </div>
                    <div class="dashboard-card-new">
                        <h3>Repetition Alerts</h3>
                        <ul id="repetitionAlertsList" style="list-style: none; padding: 0;">
                            <li>No alerts.</li>
                        </ul>
                    </div>
                    <div class="dashboard-card-new">
                        <h3>Swap Request Summary</h3>
                        <p>Pending Swaps: <span id="pendingSwaps">0</span></p>
                        <p>Approved Swaps: <span id="approvedSwaps">0</span></p>
                        <p>Declined Swaps: <span id="declinedSwaps">0</span></p>
                    </div>
                </div>
            </div>
            <!-- End New Shift Schedule Page -->

            <div id="individualSummaryPage" class="content-module">
                <h2>Individual Attendance Summary</h2>
                <hr>
                <div class="individual-summary-controls">
                    <div class="input-group">
                        <label for="individualSelectSummary">Select Team Member:</label>
                        <select id="individualSelectSummary">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                </div>

                <div class="summary-stats-grid">
                    <div class="summary-stat-card">
                        <h4>Work From Office</h4>
                        <p class="count" id="summaryWFO">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Work From Home</h4>
                        <p class="count" id="summaryWFH">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>On Leave</h4>
                        <p class="count" id="summaryLeave">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>On Sick Off</h4>
                        <p class="count" id="summarySickOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Signed Off</h4>
                        <p class="count" id="summarySignedOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Day Off</h4>
                        <p class="count" id="summaryDayOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Unpaid Leave</h4>
                        <p class="count" id="summaryUnpaidLeave">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>No Call No Show</h4>
                        <p class="count" id="summaryNCNS">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Compassionate Leave</h4>
                        <p class="count" id="summaryCompassionateLeave">0</p>
                    </div>
                </div>

                <div class="individual-summary-chart-container">
                    <h3>WFH vs WFO (Monthly Trend)</h3>
                    <div class="monthly-bar-chart" id="monthlyWFHWFOChart">
                        <p style="text-align: center; width: 100%; margin-top: 50px;">Select an employee to view chart data.</p>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item"><span class="legend-color-box" style="background-color: #007bff;"></span> WFO</div>
                        <div class="legend-item"><span class="legend-color-box" style="background-color: #28a745;"></span> WFH</div>
                    </div>
                </div>
            </div>


            <div id="dashboardPage" class="content-module">
                <h2 style="margin-bottom: 20px;">HR Employees Attendance Dashboard</h2>
                <div class="dashboard-container">
                    <div class="dashboard-header-row">
                        <div class="dashboard-header-card">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <div class="label">Start Date</div>
                                <div class="value" id="dashboardStartDate"></div>
                            </div>
                        </div>
                        <div class="dashboard-header-card employee-name">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="label">Employee Name</div>
                                <select id="employeeSelect" class="value">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-users"></i>
                            <div>
                                <div class="label">Total Employees</div>
                                <div class="value" id="dashboardTotalEmployees">0</div>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-times-circle"></i>
                            <div>
                                <div class="label">Absence Days</div>
                                <div class="value" id="dashboardAbsenceDays">0</div>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-calendar-times"></i>
                            <div>
                                <div class="label">Unapproved Leave</div>
                                <div class="value" id="dashboardUnapprovedLeave">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Attendance Statistics (Last 6 Months)</h3>
                        <div class="bar-chart-container" id="attendanceStatsChart">
                            <p style="text-align: center; width: 100%; margin-top: 50px;">No attendance data yet.</p>
                        </div>
                        <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; font-size:13px; color:#555;">
                            <span class="legend-item"><span class="legend-color-box on-time-bar"></span> Present</span>
                            <span class="legend-item"><span class="legend-color-box late"></span> Late/Partial</span>
                            <span class="legend-item"><span class="legend-color-box absent"></span> Absent</span>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Overall Attendance Percentage</h3>
                        <div class="gauge-container gauge-overall">
                            <div class="gauge">
                                <div class="gauge-fill" id="overallAttendanceGaugeFill"></div>
                            </div>
                            <div class="gauge-label" id="overallAttendanceGaugeLabel">0%</div>
                        </div>
                    </div>

                    <div class="dashboard-card-new">
                        <h3>Leave Taken (Total)</h3>
                        <div class="chart-grid">
                            <div>
                                <div class="value" id="leaveTakenSick">0</div> <div class="label">Sick Off</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenCasual">0</div> <div class="label">Compassionate</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenAnnual">0</div> <div class="label">Annual</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenUnpaid">0</div> <div class="label">Unpaid</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new">
                        <h3>Working Location Distribution</h3>
                        <div class="donut-chart-container" id="workingLocationDonutChart">
                            <div class="donut-chart-center"></div>
                        </div>
                        <div class="donut-chart-label" id="workingLocationDonutLabel">0% Working From Office</div>
                        <div class="donut-legend">
                            <div class="donut-legend-item">
                                <span class="donut-legend-color" style="background-color: #007bff;"></span> Working From Office
                            </div>
                            <div class="donut-legend-item">
                                <span class="donut-legend-color" style="background-color: #28a745;"></span> Working From Home
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Top 5 Employees by Attendance</h3>
                        <div class="top-employees-chart" id="topEmployeesChart">
                            <p style="text-align: center; width: 100%; margin-top: 50px;">No employee data to display.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportsPage" class="content-module">
                <h2>Attendance Reports & Analytics</h2>
                <hr>
                <div class="report-filters">
                    <div class="input-group">
                        <label for="reportType">Report Type:</label>
                        <select id="reportType">
                            <option value="daily">Daily Summary</option>
                            <option value="tardiness">Tardiness Report</option>
                            <option value="absenteeism">Absenteeism Report</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="input-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate">
                    </div>
                    <button id="generateReportBtn" class="btn btn-primary"><i class="fas fa-chart-bar"></i> Generate Report</button>
                    <button id="exportReportCsvBtn" class="btn btn-secondary"><i class="fas fa-download"></i> Export to CSV</button>
                </div>

                <div class="report-results">
                    <h3>Generated Report</h3>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Present (WFO)</th>
                                <th>Present (WFH)</th>
                                <th>On Leave</th>
                                <th>On Sick Off</th>
                                <th>Signed Off</th>
                                <th>Day Off</th>
                                <th>Unpaid Leave</th>
                                <th>No Call No Show</th>
                                <th>Compassionate Leave</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="adminPage" class="content-module">
                <h2>Create System User Account</h2>
                <p>Use this section to create new user accounts that can log in to the Attendance Management System. Once created, these users can be managed in the "Manage Attendance Roster" section below to control their visibility in attendance tracking.</p>
                <hr>
                <form id="addMemberForm">
                    <div class="input-group">
                        <label for="fullName">Full Name:</label>
                        <input type="text" id="fullName" placeholder="e.g., Alice Johnson" required>
                    </div>
                    <div class="input-group">
                        <label for="newEmail">Email:</label>
                        <input type="email" id="newEmail" placeholder="e.g., alice@example.com" required>
                    </div>
                    <div class="input-group">
                        <label for="newPassword">Password:</label>
                        <input type="password" id="newPassword" placeholder="********" required>
                    </div>
                    <div class="input-group">
                        <label for="memberRole">Role:</label>
                        <select id="memberRole" required>
                            <option value="">Select Role</option>
                            <option value="Agent">Agent</option>
                            <option value="QA">QA</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Admin">Admin</option>
                            <option value="Team Leader">Team Leader</option> <!-- New Role -->
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> Create System User</button>
                    <p id="addMemberMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                </form>

                <div class="staff-management-section">
                    <h2>Manage Attendance Roster</h2>
                    <p>This table lists all system users. You can activate or deactivate staff members to control whether they appear in the daily attendance marking and reports. You can also permanently delete their system account.</p>
                    <hr>
                    <div class="staff-list-table-container">
                        <table class="staff-list-table">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffListTableBody">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>
            </main>
    </div>

    <div id="attendanceMarkingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAttendanceModal">&times;</span>
            <h2>Mark Attendance for <span id="modalDateDisplay"></span></h2>
            <div class="modal-table-container">
                <table id="modalAttendanceTable">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="modalAttendanceTableBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-buttons">
                <button id="saveAttendanceBtn" class="btn btn-primary">Save Attendance</button>
                <button id="cancelAttendanceBtn" class="btn btn-secondary">Cancel</button>
                <p id="modalErrorMessage" class="error-message"></p>
            </div>
        </div>
    </div>

    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCalendarModal">&times;</span>
            <div class="calendar-header">
                <button id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
                <h3 id="currentMonthYear"></h3>
                <button id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-weekdays">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-days" id="calendarDaysGrid">
                </div>
            <div class="modal-buttons">
                <button id="selectDateFromCalendarBtn" class="btn btn-primary">Select Date</button>
                <button id="cancelCalendarSelection" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>


    <script>
        // Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig ={
            apiKey: "AIzaSyD9uPdQ7DfrKkOHyzcUnsJx5b2Fm51AdvY",
            authDomain: "attendance-d2f5c.firebaseapp.com",
            projectId: "attendance-d2f5c",
            storageBucket: "attendance-d2f5c.firebasestorage.app",
            messagingSenderId: "275359754293",
            appId: "1:275359754293:web:0fe5aa0f30d57c749ce97c",
            measurementId: "G-PWN5S35KTP"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); // Initialize Firebase Authentication
        const db = firebase.firestore();

        // --- Global Variables / Caches ---
        let loggedInUser = null; // Stores the Firebase Auth user object
        let loggedInUserRole = 'Agent'; // Stores the role fetched from Firestore user profile
        let usersData = {}; // Local cache for all user profiles from Firestore (email -> {uid, fullName, role, isActive, email, openingLeaveBalance, secondaryRole, period})
        const attendanceData = {}; // Local cache for attendance records from Firestore (date -> {agentName: status})
        const markedDates = new Set(); // Local cache for dates with marked attendance
        let activeAgents = []; // Array of active agent full names, derived from usersData
        let currentLeaveTrackerDate = new Date(); // Tracks the month/year for leave tracker
        const leavePlannerData = {}; // Local cache for leave records from Firestore ({ 'Month YYYY': [{...}, {...}] })

        let currentShiftScheduleDate = new Date(); // Tracks the month/year for shift schedule
        const shiftScheduleData = []; // In-memory sample data for shift schedule (NOT PERSISTED)

        const todayGlobal = new Date(); // Constant for today's date

        // --- DOM Element References ---
        let DOM = {}; // Centralize DOM element references

        // --- Constants and Utility Data ---
        const ATTENDANCE_STATUSES = [
            { value: '', text: 'Select Status', colorClass: '' },
            { value: 'WFO', text: 'Work From Office', colorClass: 'status-WFO' },
            { value: 'WFH', text: 'Work From Home', colorClass: 'status-WFH' },
            { value: 'SO', text: 'Signed Off', colorClass: 'status-SO' },
            { value: 'L', text: 'Leave (Annual)', colorClass: 'status-L' }, // Changed text for clarity
            { value: 'DO', text: 'Day Off', colorClass: 'status-DO' },
            { value: 'UL', text: 'Unpaid Leave', colorClass: 'status-UL' },
            { value: 'NCNS', text: 'No Call No Show', colorClass: 'status-NCNS' },
            { value: 'CL', text: 'Compassionate Leave', colorClass: 'status-CL' },
            { value: 'SOF', text: 'Sick Off', colorClass: 'status-SOF' }
        ];

        // New: Shift Time to Break/Lunch Mapping
        const SHIFT_DETAILS_MAP = [
            { shift: "8:00 am - 4:30 pm", break: "8:50-9:05AM", lunch: "12:30-1:30PM", hours: 8.5 },
            { shift: "8:30 am - 5:00 pm", break: "9:50 - 10:05AM", lunch: "1:30 - 2:30PM", hours: 8.5 },
            { shift: "7:00 am - 3:30 pm", break: "8:20 - 8:35AM", lunch: "12:30-1:30PM", hours: 8.5 },
            { shift: "9:30 am - 6:00 pm", break: "10:45-11:45AM", lunch: "2:30-3:30PM", hours: 8.5 },
            { shift: "Day Off", break: "", lunch: "", hours: 0 },
            { shift: "Public Holiday", break: "", lunch: "", hours: 0 },
            { shift: "Leave", break: "", lunch: "", hours: 0 }, // For assigned leave days
            { shift: "Sick Off", break: "", lunch: "", hours: 0 } // For assigned sick off days
        ];

        // Helper to format date for Firestore document IDs
        const formatDate = (date) => date.toISOString().split('T')[0];

        // --- Core Helper Functions ---

        /**
         * Updates the global activeAgents list based on the current usersData cache.
         * Also adds sample secondaryRole and period to usersData if they don't exist.
         */
        function updateActiveAgentsList() {
            // Sample secondary roles and periods for demonstration purposes
            const sampleSecondaryRoles = ['Inbound / Email', 'Social Media', 'LiveChat', 'Sales', 'Onboarding', 'Level 1 Escalations'];
            const samplePeriods = ['July - December', 'Jan - June', 'Annual'];

            // Ensure all users have sample secondaryRole and period for shift schedule display
            Object.keys(usersData).forEach(email => {
                if (!usersData[email].secondaryRole) {
                    usersData[email].secondaryRole = sampleSecondaryRoles[Math.floor(Math.random() * sampleSecondaryRoles.length)];
                }
                if (!usersData[email].period) {
                    usersData[email].period = samplePeriods[Math.floor(Math.random() * samplePeriods.length)];
                }
            });


            activeAgents = Object.values(usersData)
                .filter(user => user.isActive)
                .map(user => user.fullName)
                .sort(); // Keep sorted for consistent display
            console.log("Active agents list updated:", activeAgents.length, "active agents.");
        }

        /**
         * Fetches all user profiles from Firestore and populates the usersData cache.
         * @returns {Promise<void>}
         */
        async function fetchAllUsersData() {
            usersData = {}; // Clear existing data to ensure fresh load
            try {
                const usersSnapshot = await db.collection('users').get();
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersData[userData.email] = {
                        uid: doc.id, // Firestore Document ID (should match Auth UID)
                        fullName: userData.fullName,
                        role: userData.role,
                        isActive: userData.isActive,
                        email: userData.email,
                        openingLeaveBalance: userData.openingLeaveBalance || 20, // Default to 20 if not set
                        secondaryRole: userData.secondaryRole || '', // Added for shift schedule
                        period: userData.period || '' // Added for shift schedule
                    };
                });
                updateActiveAgentsList();
                console.log("All user data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching users from Firestore:", error.code, error.message);
                alert("Critical: Could not load user list from database. Check console and Firebase rules.");
            }
        }

        /**
         * Fetches all attendance records from Firestore and populates the attendanceData and markedDates caches.
         * @returns {Promise<void>}
         */
        async function fetchAttendanceData() {
            // Clear existing local cache before fetching fresh data
            for (const key in attendanceData) {
                delete attendanceData[key];
            }
            markedDates.clear();

            try {
                const attendanceSnapshot = await db.collection('attendance').get();
                attendanceSnapshot.forEach(doc => {
                    attendanceData[doc.id] = doc.data(); // doc.id is the date string (e.g., "YYYY-MM-DD")
                    markedDates.add(doc.id);
                });
                console.log("Attendance data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching attendance data:", error);
                alert("Critical: Could not load attendance data. Check console and Firebase rules.");
            }
        }

        /**
         * Fetches leave data for a specific month and year from Firestore.
         * @param {number} year
         * @param {number} month (0-indexed)
         * @returns {Promise<void>}
         */
        async function fetchLeaveData(year, month) {
            const monthYearKey = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });
            try {
                const docRef = db.collection('leaves').doc(monthYearKey);
                const doc = await docRef.get();
                if (doc.exists) {
                    leavePlannerData[monthYearKey] = doc.data().data || [];
                    console.log(`Leave data for ${monthYearKey} loaded from Firestore.`);
                } else {
                    leavePlannerData[monthYearKey] = []; // Initialize empty if no data in Firestore
                    console.log(`No leave data found for ${monthYearKey} in Firestore, initialized locally.`);
                }
                renderLeavePlannerTable(); // Re-render table after fetching data
            } catch (error) {
                console.error("Error fetching leave data:", error);
                alert("Critical: Could not load leave data. Check console and Firebase rules.");
            }
        }

        // --- UI State Management ---

        /**
         * Sets the logged-in state of the application and updates UI visibility.
         * @param {boolean} loggedIn - True if user is logged in, false otherwise.
         * @param {object | null} user - The Firebase Auth user object, or null.
         * @param {object | null} userProfile - The user's profile data from Firestore, or null.
         */
        function setLoggedInState(loggedIn, user = null, userProfile = null) {
            if (loggedIn && user && userProfile) {
                loggedInUser = user;
                loggedInUserRole = userProfile.role; // Set the global role from Firestore profile

                DOM.loginPage.classList.remove('active');
                DOM.appContainer.classList.add('active');

                DOM.loggedInUserName.textContent = userProfile.fullName || user.email;
                DOM.loggedInUserRoleDisplay.textContent = userProfile.role;

                // Show Admin link only if the user is an Admin
                if (loggedInUserRole === 'Admin') {
                    DOM.adminNavLink.style.display = 'list-item';
                } else {
                    DOM.adminNavLink.style.display = 'none';
                }

                // Determine which page to show after login based on hash or default
                const currentPageHash = window.location.hash.substring(1);
                let targetPageId = 'homePage';
                if (currentPageHash && DOM[currentPageHash + 'Page']) {
                    targetPageId = currentPageHash + 'Page';
                }
                showPage(targetPageId);

                // Initial data load and UI updates (only if not already fetched by onAuthStateChanged listener)
                if (Object.keys(usersData).length === 0 || Object.keys(attendanceData).length === 0) {
                    Promise.all([
                        fetchAllUsersData(),
                        fetchAttendanceData(),
                        fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth())
                    ]).then(() => {
                        updateHomeStatistics();
                        populateEmployeeSelect();
                        populateIndividualSummarySelect();
                        updateDashboardData(DOM.employeeSelect.value);
                        renderStaffList();
                        // Initialize Shift Schedule page content
                        populateNewShiftAgentNameDropdown(); // Populate agent dropdown for add shift form
                        populateNewShiftTimeDropdown(); // Populate shift time dropdown for add shift form
                        populateShiftScheduleMonthSelector(); // Populate month dropdown for schedule view
                        renderShiftScheduleTable(); // Render table with default month/role
                    }).catch(err => {
                        console.error("Error during initial data fetch:", err);
                        alert("Failed to load initial application data.");
                    });
                } else {
                    // Data already loaded, just refresh UI based on it
                    updateHomeStatistics();
                    populateEmployeeSelect();
                    populateIndividualSummarySelect();
                    updateDashboardData(DOM.employeeSelect.value);
                    renderStaffList();
                    populateNewShiftAgentNameDropdown();
                    populateNewShiftTimeDropdown();
                    populateShiftScheduleMonthSelector();
                    // Re-render Shift Schedule if active
                    if (DOM.shiftSchedulePage.classList.contains('active')) {
                        renderShiftScheduleTable();
                    }
                }

            } else {
                loggedInUser = null;
                loggedInUserRole = 'Agent'; // Reset role on logout

                DOM.loginPage.classList.add('active');
                DOM.appContainer.classList.remove('active');
                DOM.loginForm.reset();
                DOM.loginError.textContent = '';
                DOM.loggedInUserName.textContent = ''; // Clear user info
                DOM.loggedInUserRoleDisplay.textContent = ''; // Clear user role
                DOM.adminNavLink.style.display = 'none'; // Hide admin link on logout
            }
        }

        /**
         * Shows the specified content page and updates navigation links.
         * @param {string} pageId - The ID of the page to show (e.g., 'homePage').
         */
        function showPage(pageId) {
            document.querySelectorAll('.content-module').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            DOM.navLinks.forEach(link => {
                if (link.dataset.page === pageId.replace('Page', '')) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            // Trigger data updates/rendering specific to each page
            switch (pageId) {
                case 'attendancePage':
                    generateAttendanceOverviewTable();
                    // Reset attendance date input and disable button on page load
                    DOM.attendanceDateInput.value = '';
                    DOM.openAttendanceCalendarBtn.disabled = false; // Enable calendar button
                    selectedMarkingDate = null; // Clear selected date
                    break;
                case 'dashboardPage':
                    populateEmployeeSelect();
                    updateDashboardData(DOM.employeeSelect.value); // Pass current selection
                    break;
                case 'leaveTrackerPage':
                    fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth());
                    break;
                case 'shiftSchedulePage': // New case for Shift Schedule page
                    populateNewShiftAgentNameDropdown();
                    populateNewShiftTimeDropdown();
                    populateShiftScheduleMonthSelector();
                    renderShiftScheduleTable();
                    break;
                case 'adminPage':
                    renderStaffList();
                    break;
                case 'individualSummaryPage':
                    populateIndividualSummarySelect();
                    // Clear individual summary stats when page is first loaded without selection
                    DOM.summaryWFO.textContent = '0';
                    DOM.summaryWFH.textContent = '0';
                    DOM.summaryLeave.textContent = '0';
                    DOM.summarySickOff.textContent = '0';
                    DOM.summarySignedOff.textContent = '0';
                    DOM.summaryDayOff.textContent = '0';
                    DOM.summaryUnpaidLeave.textContent = '0';
                    DOM.summaryNCNS.textContent = '0';
                    DOM.summaryCompassionateLeave.textContent = '0';
                    DOM.monthlyWFHWFOChart.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 50px;">Select an employee to view chart data.</p>';
                    DOM.individualSelectSummary.value = ''; // Reset dropdown
                    break;
                case 'reportsPage':
                    // Initialize date inputs for reports to current month
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    DOM.startDateInput.value = firstDayOfMonth;
                    DOM.endDateInput.value = lastDayOfMonth;
                    DOM.reportsTableBody.innerHTML = ''; // Clear existing report data
                    break;
                case 'homePage':
                    updateHomeStatistics();
                    break;
            }
        }

        // --- Home Page Statistics Update ---
        function updateHomeStatistics() {
            updateActiveAgentsList();

            DOM.statTotalPresent.textContent = activeAgents.length;
            DOM.statTotalStaff.textContent = Object.keys(usersData).length;

            const today = new Date();
            const oneWeekAgo = new Date(today);
            oneWeekAgo.setDate(today.getDate() - 7);
            oneWeekAgo.setHours(0, 0, 0, 0);

            const onLeaveNamesSet = new Set();
            const onSickOffNamesSet = new Set();

            for (const dateKey in attendanceData) {
                const date = new Date(dateKey);
                date.setHours(0, 0, 0, 0);

                if (date >= oneWeekAgo && date <= today) {
                    const dailyAttendance = attendanceData[dateKey];
                    for (const agentName in dailyAttendance) {
                        if (activeAgents.includes(agentName)) { // Only consider active agents
                            const status = dailyAttendance[agentName];
                            if (status === 'L' || status === 'CL' || status === 'UL') { // Include all types of leave here
                                onLeaveNamesSet.add(agentName);
                            } else if (status === 'SOF') {
                                onSickOffNamesSet.add(agentName);
                            }
                        }
                    }
                }
            }
            DOM.statAgentsOnLeaveWeek.textContent = onLeaveNamesSet.size;
            DOM.staffOnLeaveNames.textContent = onLeaveNamesSet.size > 0 ? Array.from(onLeaveNamesSet).join(', ') : 'No agents on leave.';

            DOM.statAgentsOnSickOffWeek.textContent = onSickOffNamesSet.size;
            DOM.agentsOnSickOffNames.textContent = onSickOffNamesSet.size > 0 ? Array.from(onSickOffNamesSet).join(', ') : 'No agents on sick off.';
        }

        // --- Calendar Modal Logic ---
        let currentCalendarDate = new Date(); // To track calendar month/year
        let selectedMarkingDate = null; // Stores the date selected in the calendar

        /**
         * Renders the calendar grid for the given year and month.
         * @param {number} year - The year to display.
         * @param {number} month - The month to display (0-indexed).
         */
        function renderCalendar(year, month) {
            DOM.calendarDaysGrid.innerHTML = '';
            DOM.currentMonthYear.textContent = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const numDaysInMonth = lastDayOfMonth.getDate();
            const firstWeekday = firstDayOfMonth.getDay();

            const todayFormatted = todayGlobal.toISOString().split('T')[0];

            // Render empty cells for days before the 1st of the month
            for (let i = 0; i < firstWeekday; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                DOM.calendarDaysGrid.appendChild(emptyDay);
            }

            // Render days of the month
            for (let day = 1; day <= numDaysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('calendar-day');
                dayElement.textContent = day;

                const fullDate = new Date(year, month, day);
                const dateKey = fullDate.toISOString().split('T')[0];

                if (dateKey === todayFormatted) {
                    dayElement.classList.add('today');
                }

                // Mark dates already attended as disabled
                if (markedDates.has(dateKey)) {
                    dayElement.classList.add('disabled');
                    dayElement.title = "Attendance already marked for this date.";
                } else {
                    dayElement.addEventListener('click', () => {
                        const previouslySelected = DOM.calendarDaysGrid.querySelector('.calendar-day.selected');
                        if (previouslySelected) {
                            previouslySelected.classList.remove('selected');
                        }
                        dayElement.classList.add('selected');
                        selectedMarkingDate = dateKey;
                        // The "Select Date" button in the calendar will handle setting attendanceDateInput.value
                    });
                }
                DOM.calendarDaysGrid.appendChild(dayElement);
            }
        }

        // --- Attendance Marking Modal Logic ---

        /**
         * Populates the attendance marking modal table with active agents and their current statuses for the selected date.
         */
        function populateModalAttendanceTable() {
            DOM.modalAttendanceTableBody.innerHTML = '';
            const existingAttendance = attendanceData[selectedMarkingDate] || {};

            activeAgents.forEach(agentName => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = agentName;
                tr.appendChild(nameTd);

                const statusTd = document.createElement('td');
                const select = document.createElement('select');
                select.classList.add('attendance-status-select');
                select.dataset.agent = agentName;

                ATTENDANCE_STATUSES.forEach(status => {
                    const option = document.createElement('option');
                    option.value = status.value;
                    option.textContent = status.text;
                    select.appendChild(option);
                });

                // Set existing status if available
                if (existingAttendance[agentName]) {
                    select.value = existingAttendance[agentName];
                    const statusObj = ATTENDANCE_STATUSES.find(s => s.value === existingAttendance[agentName]);
                    if (statusObj && statusObj.colorClass) {
                        select.classList.add(statusObj.colorClass);
                    }
                } else {
                    // Default to WFO for new entries if not explicitly set
                    select.value = 'WFO';
                    select.classList.add('status-WFO');
                }

                // Add event listener to update class on change
                select.addEventListener('change', (event) => {
                    const selectedValue = event.target.value;
                    ATTENDANCE_STATUSES.forEach(status => {
                        event.target.classList.remove(status.colorClass);
                    });
                    const newStatusObj = ATTENDANCE_STATUSES.find(s => s.value === selectedValue);
                    if (newStatusObj && newStatusObj.colorClass) {
                        event.target.classList.add(newStatusObj.colorClass);
                    }
                });

                statusTd.appendChild(select);
                tr.appendChild(statusTd);
                DOM.modalAttendanceTableBody.appendChild(tr);
            });
        }

        /**
         * Saves attendance data to Firestore.
         */
        async function saveAttendance() {
            DOM.modalErrorMessage.textContent = '';
            const attendanceRecord = {};
            let allSelected = true;

            DOM.modalAttendanceTableBody.querySelectorAll('select').forEach(select => {
                const agentName = select.dataset.agent;
                const status = select.value;
                if (!status) {
                    allSelected = false;
                }
                attendanceRecord[agentName] = status;
            });

            if (!allSelected) {
                DOM.modalErrorMessage.textContent = 'Please select a status for all agents.';
                return;
            }

            try {
                // Use set with merge: true to avoid overwriting the entire document if new agents are added later
                await db.collection('attendance').doc(selectedMarkingDate).set(attendanceRecord, { merge: true });
                markedDates.add(selectedMarkingDate); // Update local cache
                attendanceData[selectedMarkingDate] = attendanceRecord; // Update local cache
                DOM.attendanceMarkingMessage.textContent = `Attendance for ${selectedMarkingDate} saved successfully!`;
                DOM.attendanceMarkingMessage.style.display = 'block';
                setTimeout(() => DOM.attendanceMarkingMessage.style.display = 'none', 3000);

                DOM.attendanceMarkingModal.style.display = 'none';
                DOM.attendanceDateInput.value = ''; // Clear input
                // DOM.openAttendanceCalendarBtn.disabled = true; // No longer needed, as button opens calendar directly
                selectedMarkingDate = null; // Clear selected date after saving

                // Re-fetch and update all relevant UI components after saving attendance
                await fetchAttendanceData();
                await fetchAllUsersData(); // Ensure active agents list is fresh
                updateHomeStatistics();
                generateAttendanceOverviewTable();
                updateDashboardData(DOM.employeeSelect.value);
                populateIndividualSummarySelect();
            } catch (error) {
                console.error("Error saving attendance:", error);
                DOM.modalErrorMessage.textContent = `Error saving attendance: ${error.message}`;
            }
        }

        // --- Team Attendance Overview Table Generation ---

        /**
         * Generates and displays the team attendance overview table.
         */
        function generateAttendanceOverviewTable() {
            DOM.attendanceOverviewTableContainer.innerHTML = '';

            const table = document.createElement('table');
            table.classList.add('attendance-overview-table');

            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            const tbody = document.createElement('tbody');

            const dates = [];
            const today = new Date();
            for (let i = -7; i <= 7; i++) { // Display 7 days before and 7 days after today
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                dates.push(date);
            }

            const agentHeader = document.createElement('th');
            agentHeader.textContent = 'Agent Name';
            headerRow.appendChild(agentHeader);

            dates.forEach(date => {
                const th = document.createElement('th');
                const dateString = date.toISOString().split('T')[0];
                const displayDate = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                th.textContent = displayDate;
                th.title = date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                if (markedDates.has(dateString)) {
                    th.classList.add('marked-date-header');
                }

                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            activeAgents.forEach(agentName => {
                const tr = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = agentName;
                nameTd.classList.add('agent-name-cell');
                tr.appendChild(nameTd);

                dates.forEach(date => {
                    const td = document.createElement('td');
                    td.classList.add('attendance-cell');
                    const dateKey = date.toISOString().split('T')[0];

                    const status = attendanceData[dateKey] ? attendanceData[dateKey][agentName] : '';
                    td.textContent = status || '-'; // Display '-' if no status
                    const statusObj = ATTENDANCE_STATUSES.find(s => s.value === status);
                    if (statusObj && statusObj.colorClass) {
                        td.classList.add(statusObj.colorClass);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            DOM.attendanceOverviewTableContainer.appendChild(table);
        }

        /**
         * Deletes all attendance data from Firestore.
         */
        async function deleteAttendanceData() {
            if (!confirm('Are you sure you want to delete ALL attendance data? This action cannot be undone.')) {
                return;
            }

            try {
                const snapshot = await db.collection('attendance').get();
                const batch = db.batch();
                snapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });
                await batch.commit();

                // Clear local caches
                for (const key in attendanceData) {
                    delete attendanceData[key];
                }
                markedDates.clear();

                alert('All attendance data deleted successfully.');
                generateAttendanceOverviewTable(); // Re-render empty table
                updateHomeStatistics();
                updateDashboardData(DOM.employeeSelect.value);
            } catch (error) {
                console.error('Error deleting attendance data:', error);
                alert('Failed to delete attendance data: ' + error.message);
            }
        }

        /**
         * Exports attendance data to a CSV file.
         */
        function exportAttendanceDataToCSV() {
            let csvContent = "data:text/csv;charset=utf-8,";
            const header = ['Date', 'Agent Name', 'Status'];
            csvContent += header.join(',') + '\n';

            // Get sorted dates
            const sortedDates = Object.keys(attendanceData).sort();

            sortedDates.forEach(dateKey => {
                const dailyAttendance = attendanceData[dateKey];
                for (const agentName in dailyAttendance) {
                    const status = dailyAttendance[agentName];
                    csvContent += `${dateKey},"${agentName}",${status}\n`;
                }
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "attendance_data.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Attendance data exported to attendance_data.csv');
        }

        // --- Leave Tracker Functions ---

        /**
         * Renders the leave planner table for the current month.
         */
        function renderLeavePlannerTable() {
            DOM.leaveTrackerTableContainer.innerHTML = '';
            DOM.currentLeaveMonthYear.textContent = currentLeaveTrackerDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            if (activeAgents.length === 0) {
                DOM.leaveTrackerTableContainer.innerHTML = '<p style="text-align: center; padding: 20px;">No active staff members to display in the leave tracker. Please add active staff via the Admin page.</p>';
                return;
            }

            const table = document.createElement('table');
            table.classList.add('leave-planner-table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            const tfoot = document.createElement('tfoot');

            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>No.</th><th>Name</th><th>Opening Balance</th><th>Leave Balance</th>'; // Fixed headers

            const numDaysInMonth = new Date(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth() + 1, 0).getDate();
            const monthlyDateKeys = [];
            for (let i = 1; i <= numDaysInMonth; i++) {
                const date = new Date(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth(), i);
                const dayOfMonth = date.getDate().toString();
                const dayOfWeek = date.toLocaleString('en-US', { weekday: 'short' }).substring(0, 1); // Get first letter of weekday
                const fullDateKey = `${currentLeaveTrackerDate.getFullYear()}-${(currentLeaveTrackerDate.getMonth() + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                monthlyDateKeys.push(fullDateKey);

                const th = document.createElement('th');
                th.innerHTML = `${dayOfMonth}<br>${dayOfWeek}`; // Day number and first letter of weekday
                headerRow.appendChild(th);
            }
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const monthYearKey = currentLeaveTrackerDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
            const currentMonthLeaveData = leavePlannerData[monthYearKey] || [];

            const totalMonthlyLeave = Array(numDaysInMonth).fill(0); // For footer totals

            let hasDataForTable = false; // Flag to check if any active agent has data

            activeAgents.forEach((agentName, index) => {
                const tr = document.createElement('tr');
                const agentLeaveData = currentMonthLeaveData.find(row => row.Name === agentName);

                // Get opening balance from usersData if available, otherwise default
                const userProfile = Object.values(usersData).find(user => user.fullName === agentName);
                const openingBalance = (userProfile && userProfile.openingLeaveBalance !== undefined) ? userProfile.openingLeaveBalance : 20; // Default to 20 annual leave days

                // Calculate current leave balance based on approved annual leaves in THIS MONTH
                let approvedAnnualLeavesInMonth = 0;
                if (agentLeaveData) {
                    for (let i = 1; i <= numDaysInMonth; i++) {
                        const dayKey = i.toString().padStart(2, '0');
                        if (agentLeaveData[dayKey] === 'AP') { // Only count approved annual leaves
                            approvedAnnualLeavesInMonth++;
                        }
                    }
                }
                const leaveBalance = Math.max(0, openingBalance - approvedAnnualLeavesInMonth); // Ensure balance doesn't go negative

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${agentName}</td>
                    <td>${openingBalance}</td>
                    <td class="current-leave-balance" data-agent="${agentName}">${leaveBalance}</td>
                `;

                monthlyDateKeys.forEach((fullDateKey, dayIndex) => {
                    const dateObj = new Date(fullDateKey);
                    const dayOnly = dateObj.getDate().toString().padStart(2, '0'); // 'DD' format

                    let cellStatus = agentLeaveData ? agentLeaveData[dayOnly] : ''; // Status (L, AP, D, SOF, CL, etc.)

                    const td = document.createElement('td');
                    td.textContent = cellStatus;
                    td.dataset.date = fullDateKey;
                    td.dataset.agent = agentName;

                    // Apply status classes for visual indication
                    // Check if it's a leave type that requires special styling or interaction
                    if (cellStatus === 'L') {
                        td.classList.add('pending-leave');
                        td.title = "Pending Annual Leave Request";
                        // Add interactive overlay for approval/decline only if it's pending
                        if (loggedInUserRole === 'Admin' || loggedInUserRole === 'Supervisor') { // Only admins/supervisors can approve
                            td.innerHTML = `<span style="display:none;" class="leave-approval-overlay">
                                <button class="approve-btn" data-agent="${agentName}" data-date="${fullDateKey}" data-status="Approved">Approve</button>
                                <button class="decline-btn" data-agent="${agentName}" data-date="${fullDateKey}" data-status="Declined">Decline</button>
                            </span>L`; // Keep 'L' visible
                            td.addEventListener('click', (event) => {
                                // Show overlay if clicked, hide others
                                document.querySelectorAll('.leave-approval-overlay').forEach(overlay => {
                                    if (overlay !== event.currentTarget.querySelector('.leave-approval-overlay')) {
                                        overlay.style.display = 'none';
                                    }
                                });
                                const overlay = event.currentTarget.querySelector('.leave-approval-overlay');
                                if (overlay) {
                                    overlay.style.display = (overlay.style.display === 'flex') ? 'none' : 'flex';
                                    event.stopPropagation(); // Prevent document click from immediately closing
                                }
                            });
                        }
                        hasDataForTable = true;
                    } else if (cellStatus === 'AP') {
                        td.classList.add('approved-leave');
                        td.title = "Approved Annual Leave";
                        hasDataForTable = true;
                    } else if (cellStatus === 'D') {
                        td.classList.add('declined-leave');
                        td.title = "Declined Annual Leave";
                        hasDataForTable = true;
                    } else {
                         // Apply general status colors for other attendance types
                        const statusObj = ATTENDANCE_STATUSES.find(s => s.value === cellStatus);
                        if (statusObj && statusObj.colorClass) {
                            td.classList.add(statusObj.colorClass);
                            td.title = statusObj.text;
                            hasDataForTable = true; // Mark as having data if any status is present
                        }

                        // Allow clicking empty cells to request leave (only if not a specific status)
                        if (!cellStatus && (loggedInUserRole === 'Agent' || loggedInUserRole === 'QA' || loggedInUserRole === 'Supervisor' || loggedInUserRole === 'Team Leader')) {
                            td.addEventListener('click', async (event) => {
                                await updateLeaveStatus(agentName, fullDateKey, 'L'); // Request Annual Leave
                            });
                        }
                    }

                    // Count approved/pending annual leaves for total footer
                    if (cellStatus === 'L' || cellStatus === 'AP') {
                        totalMonthlyLeave[dayIndex]++;
                    }
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
            table.appendChild(tbody);

            // Footer for total leaves per day
            const tfootRow = document.createElement('tr');
            tfootRow.innerHTML = `<td colspan="4" style="text-align: right;">Total Leaves (Annual/Pending):</td>`;
            totalMonthlyLeave.forEach(count => {
                const td = document.createElement('td');
                td.textContent = count > 0 ? count : '';
                tfootRow.appendChild(td);
            });
            tfoot.appendChild(tfootRow);
            table.appendChild(tfoot);

            if (activeAgents.length > 0 && !hasDataForTable && currentMonthLeaveData.length === 0) {
                   DOM.leaveTrackerTableContainer.innerHTML = '<p style="text-align: center; padding: 20px;">No leave data found for this month. Click on a day to request leave.</p>';
            } else if (activeAgents.length > 0) {
                DOM.leaveTrackerTableContainer.appendChild(table);
            }


            // Add event listeners for approve/decline buttons after rendering
            document.querySelectorAll('.leave-approval-overlay button').forEach(button => {
                button.addEventListener('click', async (event) => {
                    event.stopPropagation(); // Prevent triggering cell click
                    const agent = event.target.dataset.agent;
                    const date = event.target.dataset.date;
                    const status = event.target.dataset.status === 'Approved' ? 'AP' : 'D'; // AP for Approved, D for Declined

                    await updateLeaveStatus(agent, date, status);
                });
            });
        }


        /**
         * Updates the leave status for a specific agent on a specific date in Firestore.
         * Handles creation of new leave entries if none exist for the agent in that month.
         * @param {string} agentName - The full name of the agent.
         * @param {string} fullDateKey - The date in YYYY-MM-DD format.
         * @param {string} newStatus - The new status ('L' for pending, 'AP' for approved, 'D' for declined, etc.).
         */
        async function updateLeaveStatus(agentName, fullDateKey, newStatus) {
            const dateParts = fullDateKey.split('-');
            const year = parseInt(dateParts[0]);
            const monthIndex = parseInt(dateParts[1]) - 1; // Month is 0-indexed for Date
            const day = parseInt(dateParts[2]);

            const monthYearKey = new Date(year, monthIndex).toLocaleString('en-US', { month: 'long', year: 'numeric' });
            const dayOnly = day.toString().padStart(2, '0'); // Ensure 'DD' format

            try {
                const docRef = db.collection('leaves').doc(monthYearKey);
                const doc = await docRef.get();
                let currentData = doc.exists ? (doc.data().data || []) : [];
                let agentRowIndex = currentData.findIndex(row => row.Name === agentName);
                let agentRow = agentRowIndex !== -1 ? { ...currentData[agentRowIndex] } : null;

                const userProfile = Object.values(usersData).find(user => user.fullName === agentName);
                const defaultOpeningBalance = (userProfile && userProfile.openingLeaveBalance !== undefined) ? userProfile.openingLeaveBalance : 20;

                // If agent row doesn't exist, create a new one
                if (!agentRow) {
                    agentRow = {
                        "Name": agentName,
                        "Opening Balance": defaultOpeningBalance,
                        "Leave Balance": defaultOpeningBalance // Initially, leave balance is opening balance
                    };
                    // Ensure the day key is initialized if it's a new entry
                    agentRow[dayOnly] = newStatus;
                    currentData.push(agentRow);
                    console.log("Created new leave entry for agent:", agentName);
                } else {
                    const oldStatus = agentRow[dayOnly]; // Capture old status for comparison

                    // Update the status for the specific day
                    agentRow[dayOnly] = newStatus;

                    // Logic to adjust Leave Balance, only for Annual Leave ('L' or 'AP')
                    if (['L', 'AP'].includes(oldStatus) && newStatus === 'AP' && oldStatus === 'L') { // Pending to Approved
                        agentRow['Leave Balance'] = Math.max(0, (agentRow['Leave Balance'] || agentRow['Opening Balance'] || defaultOpeningBalance) - 1);
                    } else if (oldStatus === 'AP' && newStatus === 'L') { // Approved to Pending
                        agentRow['Leave Balance'] = (agentRow['Leave Balance'] || agentRow['Opening Balance'] || defaultOpeningBalance) + 1;
                    } else if (oldStatus === 'AP' && newStatus === 'D') { // Approved to Declined
                         agentRow['Leave Balance'] = (agentRow['Leave Balance'] || agentRow['Opening Balance'] || defaultOpeningBalance) + 1;
                    }
                    // No change to Leave Balance for other statuses (SOF, CL, UL, DO, SO, NCNS)
                    // If an 'L' is changed to something other than 'AP', the balance is not affected unless it was 'AP' before.

                    currentData[agentRowIndex] = agentRow; // Update the array with modified row
                }

                // Save updated data to Firestore
                await docRef.set({ data: currentData }, { merge: true });
                leavePlannerData[monthYearKey] = currentData; // Update local cache

                renderLeavePlannerTable(); // Re-render the table to show changes

                // Also update attendanceData if it's for today or a recent date
                // This logic needs to align with how attendance is marked and how it should reflect leave statuses.
                // For simplicity, if leave is approved/declined, update the daily attendance if applicable.
                if (attendanceData[fullDateKey]) { // Only if daily attendance for this date exists
                    let attendanceStatusToSet = attendanceData[fullDateKey][agentName] || ''; // Get current daily attendance status

                    // If a leave status affects current attendance representation
                    if (newStatus === 'AP' || newStatus === 'L') { // If it's an approved or pending leave
                        attendanceStatusToSet = 'L'; // Always show as 'L' (Leave) in daily attendance overview if it's any kind of leave
                    } else if (newStatus === 'D') { // If leave is declined, it might be an absence
                        attendanceStatusToSet = 'UL'; // Assuming declined leave results in Unpaid Leave in attendance
                    }
                    // For other statuses (SOF, CL, UL, DO, NCNS, SO), they already have their own values

                    if (attendanceStatusToSet) { // Only update if a status is determined
                         await db.collection('attendance').doc(fullDateKey).update({
                            [agentName]: attendanceStatusToSet
                        });
                        attendanceData[fullDateKey][agentName] = attendanceStatusToSet; // Update local cache
                    }
                }
                updateHomeStatistics(); // Update home stats if relevant
                updateDashboardData(DOM.employeeSelect.value); // Update dashboard if relevant

                alert(`Leave for ${agentName} on ${fullDateKey} updated to ${newStatus === 'AP' ? 'Approved' : (newStatus === 'D' ? 'Declined' : 'Pending')}.`);

            } catch (error) {
                console.error("Error updating leave status:", error);
                alert(`Failed to update leave status: ${error.message}`);
            }
        }


        // --- Dashboard Data and Charting Functions ---

        /**
         * Populates the employee dropdown for the dashboard.
         */
        function populateEmployeeSelect() {
            if (DOM.employeeSelect) {
                DOM.employeeSelect.innerHTML = '<option value="">All Employees</option>';
                Object.values(usersData).filter(user => user.isActive).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.fullName;
                    option.textContent = user.fullName;
                    DOM.employeeSelect.appendChild(option);
                });
            }
        }

        /**
         * Populates the employee dropdown for the Individual Summary page.
         */
        function populateIndividualSummarySelect() {
            if (DOM.individualSelectSummary) {
                DOM.individualSelectSummary.innerHTML = '<option value="">Select Employee</option>';
                Object.values(usersData).filter(user => user.isActive).forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.fullName;
                    option.textContent = user.fullName;
                    DOM.individualSelectSummary.appendChild(option);
                });
            }
        }


        /**
         * Updates all dashboard statistics and charts based on selected employee and attendance data.
         * @param {string} selectedEmployee - The full name of the selected employee, or empty string for all.
         */
        function updateDashboardData(selectedEmployee = '') {
            const endDate = new Date();
            const startDate = new Date();
            startDate.setMonth(endDate.getMonth() - 5); // Last 6 months including current

            DOM.dashboardStartDate.textContent = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: '2-digit' });

            // Initialize all counts
            DOM.dashboardTotalEmployees.textContent = activeAgents.length;
            let totalAbsenceDays = 0;
            let totalUnapprovedLeave = 0;
            let totalWFO = 0;
            let totalWFH = 0;
            let totalSickOffCount = 0;
            let totalSignedOff = 0;
            let totalDayOff = 0;
            let totalUnpaidLeaveCount = 0;
            let totalNCNSCount = 0;
            let totalCompassionateLeaveCount = 0;
            let totalAnnualLeaveCount = 0; // For 'L' status

            let overallPresentDays = 0; // For gauge
            let overallTotalPossibleDays = 0; // For gauge

            const monthlyAttendanceSummary = {}; // { 'YYYY-MM': { present: 0, late: 0, absent: 0 } }
            const agentAttendancePercentages = {}; // { 'Agent Name': { totalDays: 0, presentDays: 0, percentage: 0 } }

            // Initialize monthlyAttendanceSummary for the last 6 months
            for (let i = 0; i < 6; i++) {
                const month = new Date(endDate.getFullYear(), endDate.getMonth() - i, 1);
                const monthKey = month.toISOString().substring(0, 7);
                monthlyAttendanceSummary[monthKey] = { present: 0, late: 0, absent: 0 };
            }

            activeAgents.forEach(agent => {
                agentAttendancePercentages[agent] = { totalDays: 0, presentDays: 0, percentage: 0 };
            });

            // Iterate through attendance data
            for (const dateKey in attendanceData) {
                const date = new Date(dateKey);
                date.setHours(0,0,0,0);

                if (date >= startDate && date <= endDate) {
                    const dailyAttendance = attendanceData[dateKey];
                    const monthYear = dateKey.substring(0, 7); // YYYY-MM

                    const agentsToProcess = selectedEmployee ? [selectedEmployee] : activeAgents;

                    agentsToProcess.forEach(agent => {
                        if (dailyAttendance && dailyAttendance[agent]) {
                            const status = dailyAttendance[agent];

                            // For Dashboard Header Cards (Absence Days)
                            if (status === 'UL' || status === 'NCNS') {
                                totalAbsenceDays++;
                            }

                            // For Leave Taken counts
                            if (status === 'SOF') totalSickOffCount++;
                            if (status === 'CL') totalCompassionateLeaveCount++;
                            if (status === 'UL') totalUnpaidLeaveCount++;
                            if (status === 'L') totalAnnualLeaveCount++; // Assuming 'L' in attendance is Annual Leave

                            // For Working Location Distribution Donut Chart
                            if (status === 'WFO') totalWFO++;
                            if (status === 'WFH') totalWFH++;

                            // For Overall Attendance Percentage Gauge
                            if (activeAgents.includes(agent)) { // Ensure only active agents contribute to overall stats
                                overallTotalPossibleDays++;
                                if (status === 'WFO' || status === 'WFH') {
                                    overallPresentDays++;
                                }
                            }


                            // For Monthly Attendance Statistics Bar Chart
                            if (!monthlyAttendanceSummary[monthYear]) { // Should be initialized above, but good for safety
                                monthlyAttendanceSummary[monthYear] = { present: 0, late: 0, absent: 0 };
                            }
                            if (status === 'WFO' || status === 'WFH') {
                                monthlyAttendanceSummary[monthYear].present++;
                                // Simulate 'late' randomly if not a specific employee selection
                                if (!selectedEmployee && Math.random() < 0.15) { // 15% chance to be considered 'late' for general view
                                    monthlyAttendanceSummary[monthYear].late++;
                                    monthlyAttendanceSummary[monthYear].present--; // Deduct from present if marked late
                                }
                            } else if (status === 'UL' || status === 'NCNS') {
                                monthlyAttendanceSummary[monthYear].absent++;
                            }


                            // For Top Employees by Attendance (Percentage)
                            if (agentAttendancePercentages[agent]) {
                                agentAttendancePercentages[agent].totalDays++;
                                if (status === 'WFO' || status === 'WFH') {
                                    agentAttendancePercentages[agent].presentDays++;
                                }
                            }
                        }
                    });
                }
            }

            // Calculate Unapproved Leave from leavePlannerData for dates up to today
            totalUnapprovedLeave = 0;
            for (const monthYearKey in leavePlannerData) {
                const monthData = leavePlannerData[monthYearKey];
                if (monthData) {
                    monthData.forEach(rowData => {
                        // Filter by selected employee if applicable
                        const isRelevantEmployee = !selectedEmployee || rowData['Name'] === selectedEmployee;
                        if (isRelevantEmployee) {
                            const dateKeysInRow = Object.keys(rowData).filter(key => !isNaN(key) && key.length <= 2); // Numeric day keys like "01", "15"
                            dateKeysInRow.forEach(dayNum => {
                                const status = rowData[dayNum];
                                if (status === 'L') { // 'L' represents pending leave in the planner
                                    const year = new Date(Date.parse(monthYearKey)).getFullYear();
                                    const month = new Date(Date.parse(monthYearKey)).getMonth();
                                    const fullLeaveDate = new Date(year, month, parseInt(dayNum));

                                    fullLeaveDate.setHours(0,0,0,0);
                                    todayGlobal.setHours(0,0,0,0); // Ensure comparison is only by date

                                    if (fullLeaveDate <= todayGlobal) { // Count only pending leaves up to and including today
                                        totalUnapprovedLeave++;
                                    }
                                }
                            });
                        }
                    });
                }
            }


            DOM.dashboardAbsenceDays.textContent = totalUnpaidLeaveCount + totalNCNSCount;
            DOM.dashboardUnapprovedLeave.textContent = totalUnapprovedLeave;

            // Overall Attendance Gauge
            let overallPercentage = 0;
            if (overallTotalPossibleDays > 0) {
                overallPercentage = (overallPresentDays / overallTotalPossibleDays) * 100;
            }
            DOM.overallAttendanceGaugeLabel.textContent = `${overallPercentage.toFixed(0)}%`;
            const rotation = -135 + (overallPercentage * 2.7); // Adjust rotation for 0-100% over a semi-circle
            DOM.overallAttendanceGaugeFill.style.transform = `rotate(${rotation}deg)`;

            renderAttendanceStatsChart(monthlyAttendanceSummary);

            // Update Leave Taken stats
            DOM.leaveTakenSick.textContent = totalSickOffCount;
            DOM.leaveTakenCasual.textContent = totalCompassionateLeaveCount;
            DOM.leaveTakenAnnual.textContent = totalAnnualLeaveCount;
            DOM.leaveTakenUnpaid.textContent = totalUnpaidLeaveCount;


            renderWorkingLocationDonutChart(totalWFO, totalWFH);

            renderTopEmployeesChart(agentAttendancePercentages);
        }

        /**
         * Renders the monthly attendance statistics bar chart.
         * @param {object} monthlyData - An object where keys are 'YYYY-MM' and values are { present, late, absent }.
         */
        function renderAttendanceStatsChart(monthlyData) {
            DOM.attendanceStatsChart.innerHTML = ''; // Clear previous chart

            const monthsSorted = Object.keys(monthlyData).sort();
            if (monthsSorted.length === 0) {
                DOM.attendanceStatsChart.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 50px;">No attendance data yet for charts.</p>';
                return;
            }

            const chartContainerInner = document.createElement('div');
            chartContainerInner.style.display = 'flex';
            chartContainerInner.style.justifyContent = 'space-around';
            chartContainerInner.style.alignItems = 'flex-end';
            chartContainerInner.style.height = '100%';
            DOM.attendanceStatsChart.appendChild(chartContainerInner);

            // Calculate max count for scaling bars
            const allCounts = Object.values(monthlyData).flatMap(m => [m.present, m.late, m.absent]);
            const maxCount = Math.max(...allCounts);
            const scaleFactor = maxCount > 0 ? 180 / maxCount : 0; // Max height of chart area is 200px (minus padding)

            monthsSorted.forEach(monthKey => {
                const monthName = new Date(monthKey + '-01').toLocaleString('en-US', { month: 'short' });
                const monthSummary = monthlyData[monthKey];

                const barGroup = document.createElement('div');
                barGroup.classList.add('bar-group');

                barGroup.innerHTML = `
                    <div class="bar on-time-bar" style="height: ${monthSummary.present * scaleFactor}px;" title="Present: ${monthSummary.present}"></div>
                    <div class="bar late" style="height: ${monthSummary.late * scaleFactor}px;" title="Late/Partial: ${monthSummary.late}"></div>
                    <div class="bar absent" style="height: ${monthSummary.absent * scaleFactor}px;" title="Absent: ${monthSummary.absent}"></div>
                `;
                chartContainerInner.appendChild(barGroup);
            });

            const monthLabels = document.createElement('div');
            monthLabels.classList.add('bar-chart-month-labels');
            monthsSorted.forEach(monthKey => {
                const monthName = new Date(monthKey + '-01').toLocaleString('en-US', { month: 'short' });
                const div = document.createElement('div');
                div.textContent = monthName;
                monthLabels.appendChild(div);
            });
            DOM.attendanceStatsChart.appendChild(monthLabels);
        }

        /**
         * Renders the working location distribution donut chart.
         * @param {number} wfoCount - Count of Work From Office days.
         * @param {number} wfhCount - Count of Work From Home days.
         */
        function renderWorkingLocationDonutChart(wfoCount, wfhCount) {
            const total = wfoCount + wfhCount;
            let wfoPercentage = 0;

            if (total > 0) {
                wfoPercentage = (wfoCount / total) * 100;
            }

            DOM.workingLocationDonutChart.style.background = `conic-gradient(#007bff 0% ${wfoPercentage}%, #28a745 ${wfoPercentage}% 100%)`;
            DOM.workingLocationDonutLabel.textContent = `${wfoPercentage.toFixed(0)}% Working From Office`; // Round to whole number
        }

        /**
         * Renders the top employees by attendance bar chart.
         * @param {object} agentAttendancePercentages - An object mapping agent names to { totalDays, presentDays, percentage }.
         */
        function renderTopEmployeesChart(agentAttendancePercentages) {
            DOM.topEmployeesChart.innerHTML = '';

            const agentsWithPercentages = Object.entries(agentAttendancePercentages)
                .map(([name, data]) => ({
                    name,
                    percentage: data.totalDays > 0 ? (data.presentDays / data.totalDays) * 100 : 0
                }))
                .sort((a, b) => b.percentage - a.percentage) // Sort descending by percentage
                .slice(0, 5); // Take top 5

            if (agentsWithPercentages.length === 0) {
                DOM.topEmployeesChart.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 50px;">No employee data to display.</p>';
                return;
            }

            agentsWithPercentages.forEach(agent => {
                const item = document.createElement('div');
                item.classList.add('employee-bar-item');
                item.innerHTML = `
                    <span class="employee-name-label">${agent.name}</span>
                    <div class="employee-bar-track">
                        <div class="employee-bar-fill" style="width: ${agent.percentage.toFixed(0)}%;"></div>
                    </div>
                    <span class="employee-bar-value">${agent.percentage.toFixed(0)}%</span>
                `;
                DOM.topEmployeesChart.appendChild(item);
            });
        }


        // --- Individual Summary Page Functions ---
        /**
         * Updates individual summary statistics and chart for the selected employee.
         * @param {string} employeeName - The full name of the employee to summarize.
         */
        function updateIndividualSummary(employeeName) {
            if (!employeeName) {
                // Clear all stats and chart if no employee is selected
                DOM.summaryWFO.textContent = '0';
                DOM.summaryWFH.textContent = '0';
                DOM.summaryLeave.textContent = '0';
                DOM.summarySickOff.textContent = '0';
                DOM.summarySignedOff.textContent = '0';
                DOM.summaryDayOff.textContent = '0';
                DOM.summaryUnpaidLeave.textContent = '0';
                DOM.summaryNCNS.textContent = '0';
                DOM.summaryCompassionateLeave.textContent = '0';
                DOM.monthlyWFHWFOChart.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 50px;">Select an employee to view chart data.</p>';
                return;
            }

            let wfoCount = 0;
            let wfhCount = 0;
            let leaveCount = 0;
            let sickOffCount = 0;
            let signedOffCount = 0;
            let dayOffCount = 0;
            let unpaidLeaveCount = 0;
            let ncnsCount = 0;
            let compassionateLeaveCount = 0;

            const monthlyWFHWFO = {}; // { 'YYYY-MM': { wfo: 0, wfh: 0 } }

            // Aggregate data from attendanceData
            for (const dateKey in attendanceData) {
                const dailyRecord = attendanceData[dateKey];
                if (dailyRecord[employeeName]) {
                    const status = dailyRecord[employeeName];
                    const monthYear = dateKey.substring(0, 7);

                    if (!monthlyWFHWFO[monthYear]) {
                        monthlyWFHWFO[monthYear] = { wfo: 0, wfh: 0 };
                    }

                    switch (status) {
                        case 'WFO':
                            wfoCount++;
                            monthlyWFHWFO[monthYear].wfo++;
                            break;
                        case 'WFH':
                            wfhCount++;
                            monthlyWFHWFO[monthYear].wfh++;
                            break;
                        case 'L':
                            leaveCount++;
                            break;
                        case 'SOF':
                            sickOffCount++;
                            break;
                        case 'SO':
                            signedOffCount++;
                            break;
                        case 'DO':
                            dayOffCount++;
                            break;
                        case 'UL':
                            unpaidLeaveCount++;
                            break;
                        case 'NCNS':
                            ncnsCount++;
                            break;
                        case 'CL':
                            compassionateLeaveCount++;
                            break;
                    }
                }
            }

            DOM.summaryWFO.textContent = wfoCount;
            DOM.summaryWFH.textContent = wfhCount;
            DOM.summaryLeave.textContent = leaveCount;
            DOM.summarySickOff.textContent = sickOffCount;
            DOM.summarySignedOff.textContent = signedOffCount;
            DOM.summaryDayOff.textContent = dayOffCount;
            DOM.summaryUnpaidLeave.textContent = unpaidLeaveCount;
            DOM.summaryNCNS.textContent = ncnsCount;
            DOM.summaryCompassionateLeave.textContent = compassionateLeaveCount;

            renderMonthlyWFHWFOChart(monthlyWFHWFO);
        }

        /**
         * Renders the monthly WFO vs WFH bar chart for an individual employee.
         * @param {object} monthlyData - An object where keys are 'YYYY-MM' and values are { wfo, wfh }.
         */
        function renderMonthlyWFHWFOChart(monthlyData) {
            DOM.monthlyWFHWFOChart.innerHTML = '';

            const monthsSorted = Object.keys(monthlyData).sort();
            if (monthsSorted.length === 0) {
                DOM.monthlyWFHWFOChart.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 50px;">No data available for this employee for charts.</p>';
                return;
            }

            // Determine max value for scaling
            const allCounts = Object.values(monthlyData).flatMap(m => [m.wfo, m.wfh]);
            const maxCount = Math.max(...allCounts);
            const scaleFactor = maxCount > 0 ? 180 / maxCount : 0; // Chart height is 200px

            monthsSorted.forEach(monthKey => {
                const monthName = new Date(monthKey + '-01').toLocaleString('en-US', { month: 'short' });
                const monthSummary = monthlyData[monthKey];

                const barGroup = document.createElement('div');
                barGroup.classList.add('monthly-bar-group');

                // WFO Bar
                const wfoBar = document.createElement('div');
                wfoBar.classList.add('monthly-bar', 'wfo');
                wfoBar.style.height = `${monthSummary.wfo * scaleFactor}px`;
                wfoBar.title = `WFO: ${monthSummary.wfo}`;
                barGroup.appendChild(wfoBar);

                // WFH Bar
                const wfhBar = document.createElement('div');
                wfhBar.classList.add('monthly-bar', 'wfh');
                wfhBar.style.height = `${monthSummary.wfh * scaleFactor}px`;
                wfhBar.title = `WFH: ${monthSummary.wfh}`;
                barGroup.appendChild(wfhBar);

                // Month Label
                const label = document.createElement('div');
                label.classList.add('monthly-bar-label');
                label.textContent = monthName;
                barGroup.appendChild(label);

                DOM.monthlyWFHWFOChart.appendChild(barGroup);
            });
        }


        // --- Reports Generation Logic ---

        /**
         * Generates and displays report data based on selected filters.
         * @param {string} reportType - Type of report ('daily', 'tardiness', 'absenteeism').
         * @param {string} startDateStr - Start date in YYYY-MM-DD format.
         * @param {string} endDateStr - End date in YYYY-MM-DD format.
         */
        function generateReportData(reportType, startDateStr, endDateStr) {
            DOM.reportsTableBody.innerHTML = '';

            const start = new Date(startDateStr);
            const end = new Date(endDateStr);
            end.setHours(23,59,59,999); // Set to end of the day for inclusive range

            if (start > end) {
                alert("Start date cannot be after end date.");
                return;
            }

            let currentDate = new Date(start);
            let reportData = [];

            while (currentDate <= end) {
                const dateKey = formatDate(currentDate);
                const dailyAttendance = attendanceData[dateKey];

                const rowData = {
                    Date: dateKey,
                    WFO: 0,
                    WFH: 0,
                    L: 0,
                    SOF: 0,
                    SO: 0,
                    DO: 0,
                    UL: 0,
                    NCNS: 0,
                    CL: 0,
                    Late: 0, // For tardiness report
                    Absent: 0 // For absenteeism report
                };

                if (dailyAttendance) {
                    for (const agentName of activeAgents) { // Iterate over active agents to get counts
                        const status = dailyAttendance[agentName] || ''; // Get status or empty string

                        switch (status) {
                            case 'WFO':
                                rowData.WFO++;
                                break;
                            case 'WFH':
                                rowData.WFH++;
                                break;
                            case 'L':
                                rowData.L++;
                                break;
                            case 'SOF':
                                rowData.SOF++;
                                break;
                            case 'SO':
                                rowData.SO++;
                                break;
                            case 'DO':
                                rowData.DO++;
                                break;
                            case 'UL':
                                rowData.UL++;
                                rowData.Absent++; // Count as absent for report
                                break;
                            case 'NCNS':
                                rowData.NCNS++;
                                rowData.Absent++; // Count as absent for report
                                break;
                            case 'CL':
                                rowData.CL++;
                                break;
                            default:
                                // If an agent is not marked, they are considered absent or expected to be present
                                if (!status && activeAgents.includes(agentName)) { // If no status recorded for active agent
                                    rowData.Absent++;
                                }
                                break;
                        }

                        // Simulate late entries for tardiness report (if not a specific status like leave/day off)
                        if ((status === 'WFO' || status === 'WFH') && Math.random() < 0.1) { // 10% chance of being late
                            rowData.Late++;
                        }
                    }
                }

                reportData.push(rowData);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            renderReportTable(reportData, reportType);
        }

        /**
         * Renders the report table based on the generated data and report type.
         * @param {Array<object>} data - The report data.
         * @param {string} reportType - The type of report.
         */
        function renderReportTable(data, reportType) {
            DOM.reportsTableBody.innerHTML = '';
            let headerHtml = '';
            let rowHtmlGenerator;

            if (reportType === 'daily') {
                headerHtml = `
                    <th>Date</th>
                    <th>Present (WFO)</th>
                    <th>Present (WFH)</th>
                    <th>On Leave</th>
                    <th>On Sick Off</th>
                    <th>Signed Off</th>
                    <th>Day Off</th>
                    <th>Unpaid Leave</th>
                    <th>No Call No Show</th>
                    <th>Compassionate Leave</th>
                `;
                rowHtmlGenerator = (row) => `
                    <td>${row.Date}</td>
                    <td>${row.WFO}</td>
                    <td>${row.WFH}</td>
                    <td>${row.L}</td>
                    <td>${row.SOF}</td>
                    <td>${row.SO}</td>
                    <td>${row.DO}</td>
                    <td>${row.UL}</td>
                    <td>${row.NCNS}</td>
                    <td>${row.CL}</td>
                `;
            } else if (reportType === 'tardiness') {
                headerHtml = `
                    <th>Date</th>
                    <th>Late Arrivals</th>
                `;
                rowHtmlGenerator = (row) => `
                    <td>${row.Date}</td>
                    <td>${row.Late}</td>
                `;
            } else if (reportType === 'absenteeism') {
                headerHtml = `
                    <th>Date</th>
                    <th>Absences (UL/NCNS)</th>
                `;
                rowHtmlGenerator = (row) => `
                    <td>${row.Date}</td>
                    <td>${row.Absent}</td>
                `;
            }

            DOM.reportTable.querySelector('thead tr').innerHTML = headerHtml;

            if (data.length === 0 || data.every(row => Object.values(row).slice(1).every(val => val === 0))) {
                   const tr = document.createElement('tr');
                   tr.innerHTML = `<td colspan="${DOM.reportTable.querySelector('thead tr').children.length}" style="text-align: center;">No data available for the selected criteria.</td>`;
                   DOM.reportsTableBody.appendChild(tr);
            } else {
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = rowHtmlGenerator(row);
                    DOM.reportsTableBody.appendChild(tr);
                });
            }
        }


        /**
         * Exports the currently displayed report data to a CSV file.
         */
        function exportReportToCSV() {
            let csv = [];
            const rows = DOM.reportTable.querySelectorAll('tr');

            for (let i = 0; i < rows.length; i++) {
                const row = [], cols = rows[i].querySelectorAll('td, th');
                for (let j = 0; j < cols.length; j++) {
                    // Handle commas within data by enclosing in quotes
                    let data = cols[j].innerText.replace(/"/g, '""'); // Escape double quotes
                    row.push(`"${data}"`);
                }
                csv.push(row.join(','));
            }

            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${DOM.reportTypeSelect.value}_report_${DOM.startDateInput.value}_to_${DOM.endDateInput.value}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert('Report exported successfully to CSV.');
        }


        // --- Admin Add/Manage User Logic ---

        /**
         * Renders the staff list table in the Admin page.
         */
        function renderStaffList() {
            DOM.staffListTableBody.innerHTML = '';

            const sortedUsers = Object.values(usersData).sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (sortedUsers.length === 0) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="5" style="text-align: center;">No staff members found.</td>`;
                DOM.staffListTableBody.appendChild(tr);
                return;
            }

            sortedUsers.forEach(user => {
                const tr = document.createElement('tr');

                const statusSelect = document.createElement('select');
                statusSelect.innerHTML = `
                    <option value="true" ${user.isActive ? 'selected' : ''}>Active</option>
                    <option value="false" ${!user.isActive ? 'selected' : ''}>Inactive</option>
                `;
                statusSelect.addEventListener('change', (e) => {
                    toggleUserStatus(user.email, e.target.value === 'true');
                });

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => {
                    deleteUser(user.email);
                });

                tr.innerHTML = `
                    <td>${user.fullName}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td></td>
                    <td></td>
                `;
                tr.children[3].appendChild(statusSelect);
                tr.children[4].appendChild(deleteButton);

                DOM.staffListTableBody.appendChild(tr);
            });
        }

        /**
         * Toggles the active status of a user in Firestore.
         * @param {string} email - The email of the user to update.
         * @param {boolean} isActive - The new active status.
         */
        async function toggleUserStatus(email, isActive) {
            const userToUpdate = usersData[email];
            if (userToUpdate && userToUpdate.uid) {
                if (loggedInUser.email === email && !isActive) {
                    alert("You cannot deactivate your own account while logged in.");
                    renderStaffList(); // Re-render to revert selection
                    return;
                }
                try {
                    await db.collection('users').doc(userToUpdate.uid).update({
                        isActive: isActive
                    });
                    userToUpdate.isActive = isActive; // Update local state
                    updateActiveAgentsList(); // Rebuild active agents list
                    renderStaffList(); // Re-render table

                    // Refresh relevant sections that depend on active agents
                    generateAttendanceOverviewTable();
                    populateEmployeeSelect();
                    populateIndividualSummarySelect();
                    updateHomeStatistics();
                    updateDashboardData(DOM.employeeSelect.value);
                } catch (error) {
                    console.error("Error toggling user status:", error);
                    alert(`Failed to change status for ${userToUpdate.fullName}: ${error.message}`);
                }
            } else {
                alert("User not found or UID is missing.");
            }
        }

        /**
         * Deletes a user's profile and related data from Firestore.
         * NOTE: Deleting a Firebase Auth user from the client is generally not allowed for other users.
         * For a production app, this would require a Firebase Cloud Function.
         * Here, we delete their Firestore profile and data, but the Auth user might persist unless manually deleted in Firebase Console or via Cloud Function.
         * @param {string} email - The email of the user to delete.
         */
        async function deleteUser(email) {
            const userToDelete = usersData[email];
            if (!userToDelete) {
                alert("User not found.");
                return;
            }

            if (loggedInUser.email === email) {
                alert("You cannot delete your own account while logged in. Please log out and ask another administrator to delete your account, or delete it via Firebase Console.");
                return;
            }

            const confirmDelete = confirm(`Are you sure you want to delete user ${userToDelete.fullName} (${email})? This action will also delete their attendance and leave records and cannot be undone.`);
            if (!confirmDelete) {
                return;
            }

            try {
                const batch = db.batch();

                // 1. Delete user data from Firestore 'users' collection
                if (userToDelete.uid) {
                    batch.delete(db.collection('users').doc(userToDelete.uid));
                }

                // 2. Delete their attendance records for this agent
                const attendanceSnapshot = await db.collection('attendance').get();
                attendanceSnapshot.forEach(doc => {
                    const docData = doc.data();
                    if (docData[userToDelete.fullName]) {
                        const updatedData = { ...docData };
                        delete updatedData[userToDelete.fullName]; // Remove agent's specific attendance for this day
                        if (Object.keys(updatedData).length > 0) {
                            batch.update(db.collection('attendance').doc(doc.id), updatedData);
                        } else {
                            batch.delete(db.collection('attendance').doc(doc.id)); // Delete doc if no agents left for that day
                        }
                    }
                });

                // 3. Delete their leave records (simplified, assumes flat structure in month docs)
                const leavesSnapshot = await db.collection('leaves').get();
                leavesSnapshot.forEach(doc => {
                    const monthDocData = doc.data();
                    if (monthDocData.data && Array.isArray(monthDocData.data)) {
                        const originalData = monthDocData.data;
                        const updatedData = originalData.filter(row => row.Name !== userToDelete.fullName);
                        if (updatedData.length !== originalData.length) { // If something was filtered out
                            if (updatedData.length > 0) {
                                batch.update(db.collection('leaves').doc(doc.id), { data: updatedData });
                            } else {
                                batch.delete(db.collection('leaves').doc(doc.id)); // Delete month doc if no agents left
                            }
                        }
                    }
                });

                await batch.commit(); // Commit all batched operations

                // Update local state and re-render UI
                delete usersData[email];
                updateActiveAgentsList();
                renderStaffList();
                generateAttendanceOverviewTable();
                populateEmployeeSelect();
                populateIndividualSummarySelect();
                updateHomeStatistics();
                updateDashboardData(DOM.employeeSelect.value);
                alert(`User ${userToDelete.fullName} and their related data deleted from Firestore.`);

                // IMPORTANT: The Firebase Auth user account for ${email} still exists.
                console.warn(`Firebase Auth user for ${email} was NOT deleted client-side. Please delete it manually in Firebase Console or via a Cloud Function.`);

            } catch (error) {
                console.error("Error deleting user and associated data:", error);
                alert(`Failed to delete user ${userToDelete.fullName}: ${error.message}`);
            }
        }

        // --- Shift Schedule Page Functions ---

        /**
         * Populates the agent name dropdown for the "Add New Shift Assignment" form.
         */
        function populateNewShiftAgentNameDropdown() {
            DOM.newShiftAgentName.innerHTML = '<option value="">Select Agent</option>';
            activeAgents.forEach(agentName => {
                const option = document.createElement('option');
                option.value = agentName;
                option.textContent = agentName;
                DOM.newShiftAgentName.appendChild(option);
            });
        }

        /**
         * Populates the shift time dropdown for the "Add New Shift Assignment" form.
         */
        function populateNewShiftTimeDropdown() {
            DOM.newShiftTime.innerHTML = '<option value="">Select Shift</option>';
            SHIFT_DETAILS_MAP.forEach(shift => {
                const option = document.createElement('option');
                option.value = shift.shift;
                option.textContent = shift.shift;
                DOM.newShiftTime.appendChild(option);
            });
        }

        /**
         * Auto-fills Role and Secondary Role when an agent is selected in the "Add New Shift Assignment" form.
         */
        function autoFillAgentDetailsForShiftForm() {
            const selectedAgentName = DOM.newShiftAgentName.value;
            const user = Object.values(usersData).find(u => u.fullName === selectedAgentName);
            if (user) {
                DOM.newShiftRole.value = user.role || '';
                DOM.newShiftSecondaryRole.value = user.secondaryRole || '';
            } else {
                DOM.newShiftRole.value = '';
                DOM.newShiftSecondaryRole.value = '';
            }
        }

        /**
         * Auto-fills Break Time and Lunch Break based on selected Shift Time in the "Add New Shift Assignment" form.
         */
        function autoFillShiftTimesForShiftForm() {
            const selectedShift = DOM.newShiftTime.value;
            const shiftDetail = SHIFT_DETAILS_MAP.find(s => s.shift === selectedShift);
            if (shiftDetail) {
                DOM.newShiftBreak.value = shiftDetail.break;
                DOM.newShiftLunch.value = shiftDetail.lunch;
            } else {
                DOM.newShiftBreak.value = '';
                DOM.newShiftLunch.value = '';
            }
        }

        /**
         * Populates the month selector dropdown for the shift schedule table view.
         */
        function populateShiftScheduleMonthSelector() {
            DOM.scheduleMonth.innerHTML = '';
            const currentYear = todayGlobal.getFullYear();
            const currentMonth = todayGlobal.getMonth(); // 0-indexed

            for (let i = -6; i <= 6; i++) { // Show 1 year (6 months before, current, 6 months after)
                const monthDate = new Date(currentYear, currentMonth + i, 1);
                const value = monthDate.toISOString().substring(0, 7); // YYYY-MM
                const text = monthDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });
                const option = document.createElement('option');
                option.value = value;
                option.textContent = text;
                if (i === 0) { // Select current month by default
                    option.selected = true;
                }
                DOM.scheduleMonth.appendChild(option);
            }
             currentShiftScheduleDate = new Date(DOM.scheduleMonth.value + '-01'); // Set initial date for navigation
        }

        /**
         * Renders the shift schedule table for the currently selected month.
         * Data is generated in-memory for demonstration purposes.
         */
        function renderShiftScheduleTable() {
            DOM.shiftScheduleTableHead.innerHTML = '';
            DOM.shiftScheduleTableBody.innerHTML = '';
            DOM.currentShiftScheduleMonthYear.textContent = currentShiftScheduleDate.toLocaleString('en-US', { month: 'long', year: 'numeric' });

            const selectedMonthYear = currentShiftScheduleDate.toISOString().substring(0, 7);
            const selectedRole = DOM.scheduleRoleFilter.value;

            // Filter active agents by selected role
            const filteredAgents = Object.values(usersData).filter(user =>
                user.isActive && (selectedRole === '' || user.role === selectedRole)
            ).sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (filteredAgents.length === 0) {
                DOM.shiftScheduleTableBody.innerHTML = `<tr><td colspan="11" style="text-align: center; padding: 20px;">No active staff found for the selected criteria.</td></tr>`;
                updateShiftScheduleDashboard([]); // Clear dashboard
                return;
            }

            // Generate Header Rows: Fixed columns + daily columns for the month
            const headerRow1 = document.createElement('tr');
            headerRow1.innerHTML = `
                <th rowspan="2">No</th>
                <th rowspan="2">Name</th>
                <th rowspan="2">Role</th>
                <th rowspan="2">Secondary Role</th>
                <th rowspan="2">Period</th>
            `;
            const headerRow2 = document.createElement('tr'); // Sub-headers for each day

            const numDaysInMonth = new Date(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth() + 1, 0).getDate();
            const dailyHeaders = ['Shift Time', 'Break', 'Lunch', 'Total Hours', 'Remarks', 'Swap Status']; // Adjusted for single-day view

            for (let day = 1; day <= numDaysInMonth; day++) {
                const date = new Date(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth(), day);
                const dayOfMonth = date.getDate().toString();
                const dayOfWeek = date.toLocaleString('en-US', { weekday: 'short' }).substring(0, 1);

                const monthHeader = document.createElement('th');
                monthHeader.colSpan = dailyHeaders.length;
                monthHeader.textContent = `${dayOfMonth} (${dayOfWeek})`;
                monthHeader.classList.add('month-header');
                headerRow1.appendChild(monthHeader);

                dailyHeaders.forEach(subHeader => {
                    const th = document.createElement('th');
                    th.textContent = subHeader;
                    th.classList.add('sub-header');
                    headerRow2.appendChild(th);
                });
            }
            DOM.shiftScheduleTableHead.appendChild(headerRow1);
            DOM.shiftScheduleTableHead.appendChild(headerRow2);


            // Populate Table Body
            const allShiftsForMonth = shiftScheduleData.filter(shift =>
                shift.shiftDate.startsWith(selectedMonthYear)
            );

            filteredAgents.forEach((agent, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${agent.fullName}</td>
                    <td>${agent.role}</td>
                    <td>${agent.secondaryRole}</td>
                    <td>${agent.period}</td>
                `;

                for (let day = 1; day <= numDaysInMonth; day++) {
                    const currentDayFormatted = `${selectedMonthYear}-${day.toString().padStart(2, '0')}`;
                    const agentShiftForDay = allShiftsForMonth.find(s =>
                        s.agentName === agent.fullName && s.shiftDate === currentDayFormatted
                    );

                    const td = document.createElement('td');
                    td.classList.add('shift-cell-group');

                    const shiftDetailsGroup = document.createElement('div');
                    shiftDetailsGroup.classList.add('shift-details-group');

                    // Shift Time Dropdown
                    const shiftSelect = document.createElement('select');
                    shiftSelect.dataset.agent = agent.fullName;
                    shiftSelect.dataset.date = currentDayFormatted; // Store date for lookup
                    shiftSelect.classList.add('shift-time-select');
                    shiftSelect.innerHTML = '<option value="">-</option>'; // Default empty option
                    SHIFT_DETAILS_MAP.forEach(shiftOption => {
                        const option = document.createElement('option');
                        option.value = shiftOption.shift;
                        option.textContent = shiftOption.shift;
                        if (agentShiftForDay && shiftOption.shift === agentShiftForDay.shiftTime) {
                            option.selected = true;
                        }
                        shiftSelect.appendChild(option);
                    });
                    shiftSelect.addEventListener('change', (e) => {
                        updateShiftDetailsInTable(e.target);
                        // Update in-memory data when shift changes
                        const updatedShift = shiftScheduleData.find(s => s.agentName === agent.fullName && s.shiftDate === currentDayFormatted);
                        if (updatedShift) {
                            updatedShift.shiftTime = e.target.value;
                            const details = SHIFT_DETAILS_MAP.find(s => s.shift === e.target.value);
                            updatedShift.breakTime = details?.break || '';
                            updatedShift.lunchBreak = details?.lunch || '';
                            updatedShift.totalHours = details?.hours || 0;
                        } else { // If no existing shift, add a new one (in memory)
                            const details = SHIFT_DETAILS_MAP.find(s => s.shift === e.target.value);
                            shiftScheduleData.push({
                                agentName: agent.fullName,
                                role: agent.role,
                                secondaryRole: agent.secondaryRole,
                                shiftDate: currentDayFormatted,
                                shiftTime: e.target.value,
                                breakTime: details?.break || '',
                                lunchBreak: details?.lunch || '',
                                totalHours: details?.hours || 0,
                                remarks: '',
                                swapStatus: ''
                            });
                        }
                        updateShiftScheduleDashboard(shiftScheduleData.filter(shift => shift.shiftDate.startsWith(selectedMonthYear)));
                    });
                    shiftDetailsGroup.appendChild(shiftSelect);

                    // Break Time Span
                    const breakSpan = document.createElement('span');
                    breakSpan.classList.add('break-time');
                    breakSpan.textContent = agentShiftForDay ? agentShiftForDay.breakTime : '';
                    shiftDetailsGroup.appendChild(breakSpan);

                    // Lunch Break Span
                    const lunchSpan = document.createElement('span');
                    lunchSpan.classList.add('lunch-break');
                    lunchSpan.textContent = agentShiftForDay ? agentShiftForDay.lunchBreak : '';
                    shiftDetailsGroup.appendChild(lunchSpan);

                    // Total Hours Span
                    const totalHoursSpan = document.createElement('span');
                    totalHoursSpan.classList.add('total-hours');
                    totalHoursSpan.textContent = agentShiftForDay ? `${agentShiftForDay.totalHours} hrs` : '';
                    if (agentShiftForDay) {
                        const shiftDetail = SHIFT_DETAILS_MAP.find(s => s.shift === agentShiftForDay.shiftTime);
                        if (shiftDetail && shiftDetail.hours > 9) {
                            totalHoursSpan.classList.add('overtime');
                        } else if (shiftDetail && shiftDetail.hours >= 7 && shiftDetail.hours <= 9) {
                            totalHoursSpan.classList.add('compliant');
                        }
                    }
                    shiftDetailsGroup.appendChild(totalHoursSpan);

                    // Remarks Input
                    const remarksInput = document.createElement('input');
                    remarksInput.type = 'text';
                    remarksInput.placeholder = 'Remarks';
                    remarksInput.value = agentShiftForDay ? agentShiftForDay.remarks : '';
                    remarksInput.addEventListener('change', (e) => {
                        const updatedShift = shiftScheduleData.find(s => s.agentName === agent.fullName && s.shiftDate === currentDayFormatted);
                        if (updatedShift) updatedShift.remarks = e.target.value;
                    });
                    shiftDetailsGroup.appendChild(remarksInput);

                    // Swap Status Dropdown
                    const swapStatusSelect = document.createElement('select');
                    swapStatusSelect.classList.add('swap-status-select');
                    swapStatusSelect.innerHTML = `
                        <option value="">-</option>
                        <option value="Available">Available</option>
                        <option value="Swap Requested">Swap Requested</option>
                        <option value="Swapped">Swapped</option>
                        <option value="Declined">Declined</option>
                    `;
                    swapStatusSelect.value = agentShiftForDay ? agentShiftForDay.swapStatus : '';
                    swapStatusSelect.addEventListener('change', (e) => {
                        const updatedShift = shiftScheduleData.find(s => s.agentName === agent.fullName && s.shiftDate === currentDayFormatted);
                        if (updatedShift) updatedShift.swapStatus = e.target.value;

                        const cell = e.target.closest('td');
                        cell.classList.remove('swap-requested', 'swapped', 'declined-leave');
                        if (e.target.value === 'Swap Requested') {
                            cell.classList.add('swap-requested');
                        } else if (e.target.value === 'Swapped') {
                            cell.classList.add('swapped');
                        } else if (e.target.value === 'Declined') {
                            cell.classList.add('declined-leave');
                        }
                        updateShiftScheduleDashboard(shiftScheduleData.filter(shift => shift.shiftDate.startsWith(selectedMonthYear)));
                    });
                    // Apply initial styling for swap status
                    if (agentShiftForDay && agentShiftForDay.swapStatus === 'Swap Requested') {
                        td.classList.add('swap-requested');
                    } else if (agentShiftForDay && agentShiftForDay.swapStatus === 'Swapped') {
                        td.classList.add('swapped');
                    } else if (agentShiftForDay && agentShiftForDay.swapStatus === 'Declined') {
                        td.classList.add('declined-leave');
                    }
                    shiftDetailsGroup.appendChild(swapStatusSelect);

                    td.appendChild(shiftDetailsGroup);
                    tr.appendChild(td);

                    // Manually trigger updateShiftDetailsInTable for initial display
                    updateShiftDetailsInTable(shiftSelect);
                }
                DOM.shiftScheduleTableBody.appendChild(tr);
            });

            updateShiftScheduleDashboard(allShiftsForMonth);
        }

        /**
         * Updates the break, lunch, and total hours display for a shift cell.
         * @param {HTMLSelectElement} shiftSelectElement - The dropdown element for shift time.
         */
        function updateShiftDetailsInTable(shiftSelectElement) {
            const selectedShiftValue = shiftSelectElement.value;
            const parentTd = shiftSelectElement.closest('td');
            const breakSpan = parentTd.querySelector('.break-time');
            const lunchSpan = parentTd.querySelector('.lunch-break');
            const totalHoursSpan = parentTd.querySelector('.total-hours');

            const shiftDetail = SHIFT_DETAILS_MAP.find(s => s.shift === selectedShiftValue);

            if (shiftDetail) {
                breakSpan.textContent = shiftDetail.break;
                lunchSpan.textContent = shiftDetail.lunch;
                totalHoursSpan.textContent = shiftDetail.hours > 0 ? `${shiftDetail.hours} hrs` : '';

                // Apply compliance/overtime styling
                totalHoursSpan.classList.remove('overtime', 'compliant');
                if (shiftDetail.hours > 9) {
                    totalHoursSpan.classList.add('overtime');
                    totalHoursSpan.title = "Potential Overtime";
                } else if (shiftDetail.hours >= 7 && shiftDetail.hours <= 9) {
                    totalHoursSpan.classList.add('compliant');
                    totalHoursSpan.title = "Compliant Hours";
                }
            } else {
                breakSpan.textContent = '';
                lunchSpan.textContent = '';
                totalHoursSpan.textContent = '';
                totalHoursSpan.classList.remove('overtime', 'compliant');
                totalHoursSpan.title = "";
            }
        }


        /**
         * Generates sample monthly shift assignments for demonstration purposes.
         * This data structure will be closer to what you'd store per agent per month.
         * @param {Array<object>} agents - Filtered list of agent user profiles.
         * @returns {Array<object>} Array of objects, each representing an agent's monthly shift assignments.
         */
        function generateSampleMonthlyShiftAssignments(agents) {
            const sampleAssignments = [];
            const year = currentShiftScheduleDate.getFullYear();
            const month = currentShiftScheduleDate.getMonth();
            const numDaysInMonth = new Date(year, month + 1, 0).getDate();

            agents.forEach(agent => {
                for (let day = 1; day <= numDaysInMonth; day++) {
                    const shiftDate = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                    const currentDayOfWeek = new Date(year, month, day).getDay(); // 0 for Sunday, 6 for Saturday

                    let assignedShift = '';
                    let remarks = '';
                    let swapStatus = '';
                    let totalHours = 0;
                    let breakTime = '';
                    let lunchBreak = '';

                    // Prioritize existing in-memory data if available
                    const existingShift = shiftScheduleData.find(s =>
                        s.agentName === agent.fullName && s.shiftDate === shiftDate
                    );

                    if (existingShift) {
                        assignedShift = existingShift.shiftTime;
                        remarks = existingShift.remarks;
                        swapStatus = existingShift.swapStatus;
                        totalHours = existingShift.totalHours;
                        breakTime = existingShift.breakTime;
                        lunchBreak = existingShift.lunchBreak;
                    } else {
                        // Generate random shift if no existing data
                        if (currentDayOfWeek === 0 || currentDayOfWeek === 6) { // Weekends
                            assignedShift = 'Day Off';
                            remarks = 'Weekend Day Off';
                        } else {
                            const randomShiftOption = SHIFT_DETAILS_MAP[Math.floor(Math.random() * (SHIFT_DETAILS_MAP.length - 4))]; // Exclude Day Off, Holiday, Leave, Sick Off from random daily assignment
                            assignedShift = randomShiftOption.shift;
                            breakTime = randomShiftOption.break;
                            lunchBreak = randomShiftOption.lunch;
                            totalHours = randomShiftOption.hours;

                            if (Math.random() < 0.05) { // 5% chance of a pending swap
                                swapStatus = 'Swap Requested';
                                remarks = 'Pending Swap Request';
                            } else if (Math.random() < 0.02) { // 2% chance of an approved swap
                                swapStatus = 'Swapped';
                                remarks = 'Swapped with colleague';
                            } else if (Math.random() < 0.01) { // 1% chance of leave/sick off
                                const leaveType = Math.random() < 0.5 ? 'Leave' : 'Sick Off';
                                assignedShift = leaveType;
                                remarks = `${leaveType} assigned`;
                                breakTime = '';
                                lunchBreak = '';
                                totalHours = 0;
                            }
                        }
                        // Add to in-memory data for future lookups
                        shiftScheduleData.push({
                            agentName: agent.fullName,
                            role: agent.role,
                            secondaryRole: agent.secondaryRole,
                            shiftDate: shiftDate,
                            shiftTime: assignedShift,
                            breakTime: breakTime,
                            lunchBreak: lunchBreak,
                            totalHours: totalHours,
                            remarks: remarks,
                            swapStatus: swapStatus
                        });
                    }
                }
            });
            // Return only shifts for the current month for dashboard calculations
            return shiftScheduleData.filter(s => s.shiftDate.startsWith(currentShiftScheduleDate.toISOString().substring(0, 7)));
        }


        /**
         * Updates the metrics and charts in the Shift Schedule Dashboard section.
         * (Placeholders for actual chart rendering logic)
         * @param {Array<object>} currentMonthShiftData - The shift data for the currently displayed month.
         */
        function updateShiftScheduleDashboard(currentMonthShiftData) {
            let totalShiftsScheduled = 0;
            let totalHoursSum = 0;
            let coverageSupervisors = 0;
            let coverageQAs = 0;
            let pendingSwaps = 0;
            let approvedSwaps = 0;
            let declinedSwaps = 0;

            const teaBreakCounts = {};
            const lunchBreakCounts = {};
            const repetitionAlerts = new Set();

            currentMonthShiftData.forEach(shift => {
                totalShiftsScheduled++;
                totalHoursSum += shift.totalHours;

                const user = Object.values(usersData).find(u => u.fullName === shift.agentName);
                if (user) {
                    if (user.role === 'Supervisor') {
                        coverageSupervisors++;
                    } else if (user.role === 'QA') {
                        coverageQAs++;
                    }
                }

                if (shift.breakTime) {
                    teaBreakCounts[shift.breakTime] = (teaBreakCounts[shift.breakTime] || 0) + 1;
                }
                if (shift.lunchBreak) {
                    lunchBreakCounts[shift.lunchBreak] = (lunchBreakCounts[shift.lunchBreak] || 0) + 1;
                }

                if (shift.swapStatus === 'Swap Requested') {
                    pendingSwaps++;
                } else if (shift.swapStatus === 'Swapped') {
                    approvedSwaps++;
                } else if (shift.swapStatus === 'Declined') {
                    declinedSwaps++;
                }

                // Simple repetition alert: if an agent has the same shift type for > 5 days in a row (dummy logic)
                const agentShifts = currentMonthShiftData.filter(s => s.agentName === shift.agentName && s.shiftTime === shift.shiftTime);
                if (agentShifts.length > 5 && shift.totalHours > 0) { // More than 5 instances of the same shift type in the month
                    repetitionAlerts.add(`${shift.agentName}: Many instances of "${shift.shiftTime}" shift this month.`);
                }
            });

            DOM.totalShiftsScheduled.textContent = totalShiftsScheduled;
            DOM.avgHoursPerShift.textContent = totalShiftsScheduled > 0 ? `${(totalHoursSum / totalShiftsScheduled).toFixed(1)} hrs` : '0';
            DOM.coverageSupervisors.textContent = coverageSupervisors;
            DOM.coverageQAs.textContent = coverageQAs;

            DOM.teaBreakSummary.textContent = Object.entries(teaBreakCounts).map(([time, count]) => `${time} (${count})`).join(', ') || 'N/A';
            DOM.lunchBreakSummary.textContent = Object.entries(lunchBreakCounts).map(([time, count]) => `${time} (${count})`).join(', ') || 'N/A';

            DOM.pendingSwaps.textContent = pendingSwaps;
            DOM.approvedSwaps.textContent = approvedSwaps;
            DOM.declinedSwaps.textContent = declinedSwaps;

            DOM.repetitionAlertsList.innerHTML = '';
            if (repetitionAlerts.size > 0) {
                repetitionAlerts.forEach(alert => {
                    const li = document.createElement('li');
                    li.textContent = alert;
                    DOM.repetitionAlertsList.appendChild(li);
                });
            } else {
                DOM.repetitionAlertsList.innerHTML = '<li>No alerts.</li>';
            }
        }


        // --- Event Listener Initialization ---
        function initializeEventListeners() {
            // Login/Logout
            DOM.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = DOM.loginEmailInput.value;
                const password = DOM.loginPasswordInput.value;
                DOM.loginError.textContent = '';

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    console.log("User logged in successfully.");
                } catch (error) {
                    let errorMessage;
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            errorMessage = 'Invalid email or password.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email format.';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'Your account has been disabled.';
                            break;
                        default:
                            errorMessage = `Login error: ${error.message}`;
                            break;
                    }
                    DOM.loginError.textContent = errorMessage;
                    console.error("Login Error:", error.code, error.message);
                }
            });

            DOM.logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log("User logged out.");
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert("Failed to log out: " + error.message);
                }
            });

            // Navigation
            DOM.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (loggedInUser) {
                        const pageId = link.dataset.page + 'Page';
                        if (link.dataset.page === 'admin' && loggedInUserRole !== 'Admin') {
                            alert("You do not have permission to access the Admin page.");
                            return;
                        }
                        showPage(pageId);
                        window.location.hash = link.dataset.page;
                    } else {
                        alert("Please log in to access the application.");
                    }
                });
            });

            // Attendance Marking Workflow
            DOM.openAttendanceCalendarBtn.addEventListener('click', () => {
                currentCalendarDate = new Date(todayGlobal.getFullYear(), todayGlobal.getMonth(), 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                DOM.calendarModal.style.display = 'flex';
            });

            DOM.selectDateFromCalendarBtn.addEventListener('click', () => {
                if (selectedMarkingDate) {
                    DOM.attendanceDateInput.value = selectedMarkingDate;
                    DOM.modalDateDisplay.textContent = selectedMarkingDate;
                    populateModalAttendanceTable();
                    DOM.calendarModal.style.display = 'none'; // Close calendar
                    DOM.attendanceMarkingModal.style.display = 'flex'; // Open attendance modal
                } else {
                    alert('Please select a date from the calendar.');
                }
            });


            // Calendar Modal
            DOM.closeCalendarModal.addEventListener('click', () => DOM.calendarModal.style.display = 'none');
            DOM.cancelCalendarSelection.addEventListener('click', () => {
                DOM.calendarModal.style.display = 'none';
                selectedMarkingDate = null; // Clear selected date if cancelled
                DOM.attendanceDateInput.value = ''; // Clear date input
            });
            DOM.prevMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });
            DOM.nextMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });

            // Attendance Marking Modal
            DOM.closeAttendanceModal.addEventListener('click', () => DOM.attendanceMarkingModal.style.display = 'none');
            DOM.cancelAttendanceBtn.addEventListener('click', () => DOM.attendanceMarkingModal.style.display = 'none');
            DOM.saveAttendanceBtn.addEventListener('click', saveAttendance);

            // Attendance Overview Table
            DOM.deleteAttendanceDataBtn.addEventListener('click', deleteAttendanceData);
            DOM.exportAttendanceDataBtn.addEventListener('click', exportAttendanceDataToCSV);

            // Leave Tracker
            DOM.prevMonthLeaveBtn.addEventListener('click', () => {
                currentLeaveTrackerDate.setMonth(currentLeaveTrackerDate.getMonth() - 1);
                fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth());
            });
            DOM.nextMonthLeaveBtn.addEventListener('click', () => {
                currentLeaveTrackerDate.setMonth(currentLeaveTrackerDate.getMonth() + 1);
                fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth());
            });

            // Shift Schedule Page - Add Shift Form
            DOM.newShiftAgentName.addEventListener('change', autoFillAgentDetailsForShiftForm);
            DOM.newShiftTime.addEventListener('change', autoFillShiftTimesForShiftForm);
            DOM.addShiftForm.addEventListener('submit', (e) => {
                e.preventDefault();
                DOM.addShiftMessage.style.display = 'none';

                const agentName = DOM.newShiftAgentName.value;
                const shiftDate = DOM.newShiftDate.value;
                const shiftTime = DOM.newShiftTime.value;
                const remarks = DOM.newShiftRemarks.value;
                const swapStatus = DOM.newShiftSwapStatus.value;

                if (!agentName || !shiftDate || !shiftTime) {
                    DOM.addShiftMessage.textContent = 'Agent, Shift Date, and Shift Time are required!';
                    DOM.addShiftMessage.style.color = '#dc3545';
                    DOM.addShiftMessage.style.display = 'block';
                    return;
                }

                const agentProfile = Object.values(usersData).find(u => u.fullName === agentName);
                const shiftDetails = SHIFT_DETAILS_MAP.find(s => s.shift === shiftTime);

                if (!agentProfile || !shiftDetails) {
                    DOM.addShiftMessage.textContent = 'Invalid agent or shift time selected.';
                    DOM.addShiftMessage.style.color = '#dc3545';
                    DOM.addShiftMessage.style.display = 'block';
                    return;
                }

                // Check if a shift already exists for this agent on this date
                const existingShiftIndex = shiftScheduleData.findIndex(s =>
                    s.agentName === agentName && s.shiftDate === shiftDate
                );

                const newShiftEntry = {
                    agentName: agentName,
                    role: agentProfile.role,
                    secondaryRole: agentProfile.secondaryRole,
                    shiftDate: shiftDate,
                    shiftTime: shiftTime,
                    breakTime: shiftDetails.break,
                    lunchBreak: shiftDetails.lunch,
                    totalHours: shiftDetails.hours,
                    remarks: remarks,
                    swapStatus: swapStatus
                };

                if (existingShiftIndex !== -1) {
                    shiftScheduleData[existingShiftIndex] = newShiftEntry;
                    DOM.addShiftMessage.textContent = `Shift for ${agentName} on ${shiftDate} updated successfully (in-memory)!`;
                } else {
                    shiftScheduleData.push(newShiftEntry);
                    DOM.addShiftMessage.textContent = `Shift for ${agentName} on ${shiftDate} added successfully (in-memory)!`;
                }

                DOM.addShiftMessage.style.color = '#28a745';
                DOM.addShiftMessage.style.display = 'block';
                DOM.addShiftForm.reset();
                autoFillAgentDetailsForShiftForm(); // Clear auto-filled fields
                autoFillShiftTimesForShiftForm(); // Clear auto-filled fields

                // Re-render table to show the new/updated shift
                renderShiftScheduleTable();
            });


            // Shift Schedule Page - Monthly Navigation and Filters
            DOM.prevMonthShiftScheduleBtn.addEventListener('click', () => {
                currentShiftScheduleDate.setMonth(currentShiftScheduleDate.getMonth() - 1);
                renderShiftScheduleTable();
            });
            DOM.nextMonthShiftScheduleBtn.addEventListener('click', () => {
                currentShiftScheduleDate.setMonth(currentShiftScheduleDate.getMonth() + 1);
                renderShiftScheduleTable();
            });
            DOM.scheduleRoleFilter.addEventListener('change', renderShiftScheduleTable);

            // Optional: Implement export functionality for PDF
            DOM.exportSchedulePdfBtn.addEventListener('click', () => {
                alert('Export to PDF functionality not yet implemented.');
            });

            // Individual Summary
            DOM.individualSelectSummary.addEventListener('change', (e) => updateIndividualSummary(e.target.value));

            // Dashboard
            DOM.employeeSelect.addEventListener('change', (e) => updateDashboardData(e.target.value));

            // Reports Page
            DOM.generateReportBtn.addEventListener('click', () => {
                const reportType = DOM.reportTypeSelect.value;
                const startDate = DOM.startDateInput.value;
                const endDate = DOM.endDateInput.value;

                if (!startDate || !endDate) {
                    alert('Please select both start and end dates for the report.');
                    return;
                }
                generateReportData(reportType, startDate, endDate);
            });
            DOM.exportReportCsvBtn.addEventListener('click', exportReportToCSV);

            // Admin Add User Form
            DOM.addMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOM.addMemberMessage.style.display = 'none';
                const fullName = DOM.fullNameInput.value.trim();
                const newEmail = DOM.newEmailInput.value.trim();
                const newPassword = DOM.newPasswordInput.value;
                const memberRole = DOM.memberRoleSelect.value;

                if (!fullName || !newEmail || !newPassword || !memberRole) {
                    DOM.addMemberMessage.textContent = 'All fields are required!';
                    DOM.addMemberMessage.style.color = '#dc3545';
                    DOM.addMemberMessage.style.display = 'block';
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(newEmail, newPassword);
                    const newUser = userCredential.user;

                    await db.collection('users').doc(newUser.uid).set({
                        fullName: fullName,
                        email: newEmail,
                        role: memberRole,
                        isActive: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    DOM.addMemberMessage.textContent = `User ${fullName} created successfully!`;
                    DOM.addMemberMessage.style.color = '#28a745';
                    DOM.addMemberMessage.style.display = 'block';
                    DOM.addMemberForm.reset();

                    await fetchAllUsersData();
                    renderStaffList();
                    populateEmployeeSelect();
                    populateIndividualSummarySelect();
                    updateHomeStatistics();
                    updateDashboardData(DOM.employeeSelect.value);
                } catch (error) {
                    let errorMessage = 'Error creating user.';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'The email address is already in use by another account.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password is too weak. Please choose a stronger password.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'The email address is not valid.';
                            break;
                        default:
                            errorMessage = `Error: ${error.message}`;
                            break;
                    }
                    DOM.addMemberMessage.textContent = errorMessage;
                    DOM.addMemberMessage.style.color = '#dc3545';
                    DOM.addMemberMessage.style.display = 'block';
                    console.error("Add User Error:", error.code, error.message);
                }
            });
        }

        // --- DOMContentLoaded and Initial Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Assign DOM elements to the DOM object
            DOM = {
                loginPage: document.getElementById('loginPage'),
                appContainer: document.getElementById('appContainer'),
                loginForm: document.getElementById('loginForm'),
                loginEmailInput: document.getElementById('loginEmail'),
                loginPasswordInput: document.getElementById('loginPassword'),
                loginError: document.getElementById('loginError'),

                loggedInUserName: document.getElementById('loggedInUserName'),
                loggedInUserRoleDisplay: document.getElementById('loggedInUserRole'),
                logoutBtn: document.getElementById('logoutBtn'),
                adminNavLink: document.getElementById('adminNavLink'),
                navLinks: document.querySelectorAll('.main-nav a'),

                homePage: document.getElementById('homePage'),
                statTotalPresent: document.getElementById('statTotalPresent'),
                statTotalStaff: document.getElementById('statTotalStaff'),
                statAgentsOnLeaveWeek: document.getElementById('statAgentsOnLeaveWeek'),
                statAgentsOnSickOffWeek: document.getElementById('statAgentsOnSickOffWeek'),
                staffOnLeaveNames: document.getElementById('staffOnLeaveNames'),
                agentsOnSickOffNames: document.getElementById('agentsOnSickOffNames'),

                attendancePage: document.getElementById('attendancePage'),
                attendanceDateInput: document.getElementById('attendanceDateInput'),
                openAttendanceCalendarBtn: document.getElementById('openAttendanceCalendarBtn'), // Renamed
                attendanceMarkingMessage: document.getElementById('attendanceMarkingMessage'),
                attendanceOverviewTableContainer: document.getElementById('attendanceOverviewTableContainer'),
                deleteAttendanceDataBtn: document.getElementById('deleteAttendanceDataBtn'),
                exportAttendanceDataBtn: document.getElementById('exportAttendanceDataBtn'),

                attendanceMarkingModal: document.getElementById('attendanceMarkingModal'),
                closeAttendanceModal: document.getElementById('closeAttendanceModal'),
                modalDateDisplay: document.getElementById('modalDateDisplay'),
                modalAttendanceTableBody: document.getElementById('modalAttendanceTable').querySelector('tbody'),
                saveAttendanceBtn: document.getElementById('saveAttendanceBtn'),
                cancelAttendanceBtn: document.getElementById('cancelAttendanceBtn'),
                modalErrorMessage: document.getElementById('modalErrorMessage'),

                calendarModal: document.getElementById('calendarModal'),
                closeCalendarModal: document.getElementById('closeCalendarModal'),
                prevMonthBtn: document.getElementById('prevMonthBtn'),
                nextMonthBtn: document.getElementById('nextMonthBtn'),
                currentMonthYear: document.getElementById('currentMonthYear'),
                calendarDaysGrid: document.getElementById('calendarDaysGrid'),
                cancelCalendarSelection: document.getElementById('cancelCalendarSelection'),
                selectDateFromCalendarBtn: document.getElementById('selectDateFromCalendarBtn'), // New button

                leaveTrackerPage: document.getElementById('leaveTrackerPage'),
                prevMonthLeaveBtn: document.getElementById('prevMonthLeaveBtn'),
                nextMonthLeaveBtn: document.getElementById('nextMonthLeaveBtn'),
                currentLeaveMonthYear: document.getElementById('currentLeaveMonthYear'),
                leaveTrackerTableContainer: document.getElementById('leaveTrackerTableContainer'),

                // New Shift Schedule DOM elements
                shiftSchedulePage: document.getElementById('shiftSchedulePage'),
                addShiftForm: document.getElementById('addShiftForm'),
                newShiftAgentName: document.getElementById('newShiftAgentName'),
                newShiftRole: document.getElementById('newShiftRole'),
                newShiftSecondaryRole: document.getElementById('newShiftSecondaryRole'),
                newShiftDate: document.getElementById('newShiftDate'),
                newShiftTime: document.getElementById('newShiftTime'),
                newShiftBreak: document.getElementById('newShiftBreak'),
                newShiftLunch: document.getElementById('newShiftLunch'),
                newShiftRemarks: document.getElementById('newShiftRemarks'),
                newShiftSwapStatus: document.getElementById('newShiftSwapStatus'),
                addShiftMessage: document.getElementById('addShiftMessage'),

                prevMonthShiftScheduleBtn: document.getElementById('prevMonthShiftScheduleBtn'),
                nextMonthShiftScheduleBtn: document.getElementById('nextMonthShiftScheduleBtn'),
                currentShiftScheduleMonthYear: document.getElementById('currentShiftScheduleMonthYear'),
                scheduleRoleFilter: document.getElementById('scheduleRoleFilter'),
                exportSchedulePdfBtn: document.getElementById('exportSchedulePdfBtn'),
                shiftScheduleTableBody: document.getElementById('shiftScheduleTableBody'),
                shiftScheduleTableHead: document.getElementById('shiftScheduleTableHead'), // New for dynamic headers

                totalShiftsScheduled: document.getElementById('totalShiftsScheduled'),
                avgHoursPerShift: document.getElementById('avgHoursPerShift'),
                coverageSupervisors: document.getElementById('coverageSupervisors'),
                coverageQAs: document.getElementById('coverageQAs'),
                teaBreakSummary: document.getElementById('teaBreakSummary'),
                lunchBreakSummary: document.getElementById('lunchBreakSummary'),
                repetitionAlertsList: document.getElementById('repetitionAlertsList'),
                pendingSwaps: document.getElementById('pendingSwaps'),
                approvedSwaps: document.getElementById('approvedSwaps'),
                declinedSwaps: document.getElementById('declinedSwaps'),


                individualSummaryPage: document.getElementById('individualSummaryPage'),
                individualSelectSummary: document.getElementById('individualSelectSummary'),
                summaryWFO: document.getElementById('summaryWFO'),
                summaryWFH: document.getElementById('summaryWFH'),
                summaryLeave: document.getElementById('summaryLeave'),
                summarySickOff: document.getElementById('summarySickOff'),
                summarySignedOff: document.getElementById('summarySignedOff'),
                summaryDayOff: document.getElementById('summaryDayOff'),
                summaryUnpaidLeave: document.getElementById('summaryUnpaidLeave'),
                summaryNCNS: document.getElementById('summaryNCNS'),
                summaryCompassionateLeave: document.getElementById('summaryCompassionateLeave'),
                monthlyWFHWFOChart: document.getElementById('monthlyWFHWFOChart'),

                dashboardPage: document.getElementById('dashboardPage'),
                dashboardStartDate: document.getElementById('dashboardStartDate'),
                employeeSelect: document.getElementById('employeeSelect'),
                dashboardTotalEmployees: document.getElementById('dashboardTotalEmployees'),
                dashboardAbsenceDays: document.getElementById('dashboardAbsenceDays'),
                dashboardUnapprovedLeave: document.getElementById('dashboardUnapprovedLeave'),
                overallAttendanceGaugeFill: document.getElementById('overallAttendanceGaugeFill'),
                overallAttendanceGaugeLabel: document.getElementById('overallAttendanceGaugeLabel'),
                attendanceStatsChart: document.getElementById('attendanceStatsChart'),
                leaveTakenSick: document.getElementById('leaveTakenSick'),
                leaveTakenCasual: document.getElementById('leaveTakenCasual'),
                leaveTakenAnnual: document.getElementById('leaveTakenAnnual'),
                leaveTakenUnpaid: document.getElementById('leaveTakenUnpaid'),
                workingLocationDonutChart: document.getElementById('workingLocationDonutChart'),
                workingLocationDonutLabel: document.getElementById('workingLocationDonutLabel'),
                topEmployeesChart: document.getElementById('topEmployeesChart'),

                reportsPage: document.getElementById('reportsPage'),
                reportTypeSelect: document.getElementById('reportType'),
                startDateInput: document.getElementById('startDate'),
                endDateInput: document.getElementById('endDate'),
                generateReportBtn: document.getElementById('generateReportBtn'),
                exportReportCsvBtn: document.getElementById('exportReportCsvBtn'),
                reportsTableBody: document.getElementById('reportsTableBody'),
                reportTable: document.getElementById('reportTable'),

                adminPage: document.getElementById('adminPage'),
                addMemberForm: document.getElementById('addMemberForm'),
                fullNameInput: document.getElementById('fullName'),
                newEmailInput: document.getElementById('newEmail'),
                newPasswordInput: document.getElementById('newPassword'),
                memberRoleSelect: document.getElementById('memberRole'),
                addMemberMessage: document.getElementById('addMemberMessage'),
                staffListTableBody: document.getElementById('staffListTableBody'),

                // For the schedule month dropdown, it's now part of the DOM object
                scheduleMonth: document.getElementById('scheduleMonth')
            };

            initializeEventListeners();

            // Set current month for shift schedule selector
            // This is done again in setLoggedInState for a fresh load after auth check
            // For now, this ensures it's set on direct page load even before auth
            populateShiftScheduleMonthSelector();


            // Firebase Auth State Listener
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("Firebase Auth State Changed: User is logged in.", user.email);
                    try {
                        const userProfileDoc = await db.collection('users').doc(user.uid).get();
                        if (userProfileDoc.exists) {
                            const userProfile = userProfileDoc.data();
                            setLoggedInState(true, user, userProfile);
                        } else {
                            console.warn("User profile not found in Firestore for UID:", user.uid);
                            alert("Your user profile is incomplete. Please contact administrator.");
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("Error fetching user profile:", error);
                        alert("Error fetching user profile. Please try again.");
                        auth.signOut();
                    }
                } else {
                    console.log("Firebase Auth State Changed: User is logged out.");
                    setLoggedInState(false);
                }
            });

            // Initial load based on hash (if user refreshed while logged in)
            if (window.location.hash && loggedInUser) { // Check loggedInUser after auth state listener might have updated it
                const pageIdFromHash = window.location.hash.substring(1) + 'Page';
                if (DOM[pageIdFromHash]) {
                    showPage(pageIdFromHash);
                }
            } else if (!loggedInUser) {
                setLoggedInState(false);
            }
        });
    </script>
</body>
</html>
