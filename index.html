<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS - Contact Center Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script src="workforceManagement.js"></script>

    <style>
        /* ... (styles remain the same) ... */
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <div class="login-container">
            <h2>AMS Login</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="your.email@example.com" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="********" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="loginError" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="appContainer" class="page">
        <aside class="sidebar">
            <div class="logo">AMS</div>
            <nav class="main-nav">
                <ul>
                    <li><a href="#" data-page="home"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#" data-page="attendance"><i class="fas fa-user-check"></i> Attendance Marking</a></li>
                    <li><a href="#" data-page="leaveTracker"><i class="fas fa-calendar-alt"></i> Leave Tracker</a></li>
                    <li><a href="#" data-page="shiftSchedule"><i class="fas fa-clock"></i> Shift Schedule</a></li> <li><a href="#" data-page="individualSummary"><i class="fas fa-user"></i> Individual Summary</a></li>
                    <li><a href="#" data-page="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="#" data-page="reports"><i class="fas fa-file-alt"></i> Reports</a></li>
                    <li id="adminNavLink" style="display:none;"><a href="#" data-page="admin"><i class="fas fa-user-plus"></i> Admin</a></li>
                </ul>
            </nav>
            <button id="logoutBtn" class="btn btn-secondary logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </aside>

        <main class="main-content">
            <div class="top-system-bar">
                ICEA LION Contact Centre Attendance Management
            </div>
            <header class="app-header">
                <h1>Welcome to Attendance Management System</h1>
                <div class="user-info">
                    <span>Hello, <strong id="loggedInUserName"></strong></span>
                    <span class="user-role" id="loggedInUserRole"></span>
                </div>
            </header>

            <div id="homePage" class="content-module active">
                <h2>Today's Statistics</h2>
                <hr>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Present</h3>
                        <p id="statTotalPresent" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Staff</h3>
                        <p id="statTotalStaff" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Agents on Leave (Week)</h3>
                        <p id="statAgentsOnLeaveWeek" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Agents on Sick Off (Week)</h3>
                        <p id="statAgentsOnSickOffWeek" class="stat-value">0</p>
                    </div>
                </div>

                <h3>Notifications</h3>
                <div class="notifications-list">
                    <div class="notification-item info">
                        <span class="notification-icon"><i class="fas fa-calendar-alt"></i></span>
                        <p>Staff on Leave This Week: <strong id="staffOnLeaveNames">No agents on leave.</strong></p>
                    </div>
                    <div class="notification-item warning">
                        <span class="notification-icon"><i class="fas fa-bed"></i></span>
                        <p>Agents on Sick Off This Week: <strong id="agentsOnSickOffNames">No agents on sick off.</strong></p>
                    </div>
                </div>
            </div>

            <div id="attendancePage" class="content-module">
                <h2>Mark Attendance</h2>
                <hr>
                <div class="mark-attendance-section">
                    <button id="openAttendanceCalendarBtn" class="btn btn-primary"><i class="fas fa-calendar-alt"></i> Select Date</button>
                    <div class="input-group">
                        <label for="attendanceDateInput">Selected Date:</label>
                        <input type="text" id="attendanceDateInput" placeholder="No date selected" readonly>
                    </div>
                    <p id="attendanceMarkingMessage" class="success-message" style="display:none; margin-top:10px;"></p>
                </div>

                <h2 style="margin-top: 40px;">Team Attendance Overview</h2>
                <hr>
                <div class="attendance-table-toolbar">
                    <button id="deleteAttendanceDataBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Delete Data</button>
                    <button id="exportAttendanceDataBtn" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export Data</button>
                </div>
                <div class="attendance-table-container" id="attendanceOverviewTableContainer">
                </div>
                <div class="attendance-status-guide">
                    <h3>Status Key:</h3>
                    <p><span class="status-indicator-guide status-WFO"></span> WFO: Work From Office</p>
                    <p><span class="status-indicator-guide status-WFH"></span> WFH: Work From Home</p>
                    <p><span class="status-indicator-guide status-SO"></span> SO: Signed Off</p>
                    <p><span class="status-indicator-guide status-L"></span> L: Leave (Annual)</p>
                    <p><span class="status-indicator-guide status-DO"></span> DO: Day Off</p>
                    <p><span class="status-indicator-guide status-UL"></span> UL: Unpaid Leave</p>
                    <p><span class="status-indicator-guide status-NCNS"></span> NCNS: No Call No Show</p>
                    <p><span class="status-indicator-guide status-CL"></span> CL: Compassionate Leave</p>
                    <p><span class="status-indicator-guide status-SOF"></span> SOF: Sick Off</p>
                </div>
            </div>

            <div id="leaveTrackerPage" class="content-module">
                <div class="leave-tracker-header">
                    <h2>Leave Tracker</h2>
                    <div>
                        <button id="prevMonthLeaveBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                        <h3 style="display:inline-block; margin: 0 15px;" id="currentLeaveMonthYear"></h3>
                        <button id="nextMonthLeaveBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <hr>
                <div class="leave-tracker-table-container" id="leaveTrackerTableContainer">
                </div>
            </div>

            <div id="shiftSchedulePage" class="content-module">
                <h2>Shift Schedule Management</h2>
                <hr>

                <div class="shift-schedule-controls">
                    <button id="prevMonthShiftScheduleBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                    <h3 style="display:inline-block; margin: 0 15px;" id="currentShiftScheduleMonthYear"></h3>
                    <button id="nextMonthShiftScheduleBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                    <div class="input-group" style="flex-basis: auto; flex-grow: 0; margin-left: auto;">
                        <label for="scheduleRoleFilter">Filter by Role:</label>
                        <select id="scheduleRoleFilter">
                            <option value="">All Roles</option>
                            <option value="Agent">Agent</option>
                            <option value="QA">QA</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Team Leader">Team Leader</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>

                <div class="shift-schedule-table-container">
                    <table class="shift-schedule-table">
                        <thead id="shiftScheduleTableHead">
                            </thead>
                        <tbody id="shiftScheduleTableBody">
                            </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 40px;">Shift & Break Counts for Current Month</h3>
                <hr>
                <div class="shift-counts-table-container">
                    <table class="shift-counts-table" id="shiftCountsTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Item</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody id="shiftCountsTableBody">
                            </tbody>
                    </table>
                </div>

            </div>
            <div id="individualSummaryPage" class="content-module">
                <h2>Individual Attendance Summary</h2>
                <hr>
                <div class="individual-summary-controls">
                    <div class="input-group">
                        <label for="individualSelectSummary">Select Team Member:</label>
                        <select id="individualSelectSummary">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                </div>

                <div class="summary-stats-grid">
                    <div class="summary-stat-card">
                        <h4>Work From Office</h4>
                        <p class="count" id="summaryWFO">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Work From Home</h4>
                        <p class="count" id="summaryWFH">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>On Leave</h4>
                        <p class="count" id="summaryLeave">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>On Sick Off</h4>
                        <p class="count" id="summarySickOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Signed Off</h4>
                        <p class="count" id="summarySignedOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Day Off</h4>
                        <p class="count" id="summaryDayOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Unpaid Leave</h4>
                        <p class="count" id="summaryUnpaidLeave">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>No Call No Show</h4>
                        <p class="count" id="summaryNCNS">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Compassionate Leave</h4>
                        <p class="count" id="summaryCompassionateLeave">0</p>
                    </div>
                </div>

                <div class="individual-summary-chart-container">
                    <h3>WFH vs WFO (Monthly Trend)</h3>
                    <div class="monthly-bar-chart" id="monthlyWFHWFOChart">
                        <p style="text-align: center; width: 100%; margin-top: 50px;">Select an employee to view chart data.</p>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item"><span class="legend-color-box" style="background-color: #007bff;"></span> WFO</div>
                        <div class="legend-item"><span class="legend-color-box" style="background-color: #28a745;"></span> WFH</div>
                    </div>
                </div>
            </div>


            <div id="dashboardPage" class="content-module">
                <h2 style="margin-bottom: 20px;">HR Employees Attendance Dashboard</h2>
                <div class="dashboard-container">
                    <div class="dashboard-header-row">
                        <div class="dashboard-header-card">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <div class="label">Start Date</div>
                                <div class="value" id="dashboardStartDate"></div>
                            </div>
                        </div>
                        <div class="dashboard-header-card employee-name">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="label">Employee Name</div>
                                <select id="employeeSelect" class="value">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-users"></i>
                            <div>
                                <div class="label">Total Employees</div>
                                <div class="value" id="dashboardTotalEmployees">0</div>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-times-circle"></i>
                            <div>
                                <div class="label">Absence Days</div>
                                <div class="value" id="dashboardAbsenceDays">0</div>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-calendar-times"></i>
                            <div>
                                <div class="label">Unapproved Leave</div>
                                <div class="value" id="dashboardUnapprovedLeave">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Attendance Statistics (Last 6 Months)</h3>
                        <div class="bar-chart-container" id="attendanceStatsChart">
                            <p style="text-align: center; width: 100%; margin-top: 50px;">No attendance data yet.</p>
                        </div>
                        <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; font-size:13px; color:#555;">
                            <span class="legend-item"><span class="legend-color-box on-time-bar"></span> Present</span>
                            <span class="legend-item"><span class="legend-color-box late"></span> Late/Partial</span>
                            <span class="legend-item"><span class="legend-color-box absent"></span> Absent</span>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Overall Attendance Percentage</h3>
                        <div class="gauge-container gauge-overall">
                            <div class="gauge">
                                <div class="gauge-fill" id="overallAttendanceGaugeFill"></div>
                            </div>
                            <div class="gauge-label" id="overallAttendanceGaugeLabel">0%</div>
                        </div>
                    </div>

                    <div class="dashboard-card-new">
                        <h3>Leave Taken (Total)</h3>
                        <div class="chart-grid">
                            <div>
                                <div class="value" id="leaveTakenSick">0</div> <div class="label">Sick Off</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenCasual">0</div> <div class="label">Compassionate</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenAnnual">0</div> <div class="label">Annual</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenUnpaid">0</div> <div class="label">Unpaid</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new">
                        <h3>Working Location Distribution</h3>
                        <div class="donut-chart-container" id="workingLocationDonutChart">
                            <div class="donut-chart-center"></div>
                        </div>
                        <div class="donut-chart-label" id="workingLocationDonutLabel">0% Working From Office</div>
                        <div class="donut-legend">
                            <div class="donut-legend-item">
                                <span class="donut-legend-color" style="background-color: #007bff;"></span> Working From Office
                            </div>
                            <div class="donut-legend-item">
                                <span class="donut-legend-color" style="background-color: #28a745;"></span> Working From Home
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Top 5 Employees by Attendance</h3>
                        <div class="top-employees-chart" id="topEmployeesChart">
                            <p style="text-align: center; width: 100%; margin-top: 50px;">No employee data to display.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportsPage" class="content-module">
                <h2>Attendance Reports & Analytics</h2>
                <hr>
                <div class="report-filters">
                    <div class="input-group">
                        <label for="reportType">Report Type:</label>
                        <select id="reportType">
                            <option value="daily">Daily Summary</option>
                            <option value="tardiness">Tardiness Report</option>
                            <option value="absenteeism">Absenteeism Report</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="input-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate">
                    </div>
                    <button id="generateReportBtn" class="btn btn-primary"><i class="fas fa-chart-bar"></i> Generate Report</button>
                    <button id="exportReportCsvBtn" class="btn btn-secondary"><i class="fas fa-download"></i> Export to CSV</button>
                </div>

                <div class="report-results">
                    <h3>Generated Report</h3>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Present (WFO)</th>
                                <th>Present (WFH)</th>
                                <th>On Leave</th>
                                <th>On Sick Off</th>
                                <th>Signed Off</th>
                                <th>Day Off</th>
                                <th>Unpaid Leave</th>
                                <th>No Call No Show</th>
                                <th>Compassionate Leave</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="adminPage" class="content-module">
                <h2>Create System User Account</h2>
                <p>Use this section to create new user accounts that can log in to the Attendance Management System. These users can then be assigned roles and added as staff members to be managed in the attendance register.</p>
                <hr>
                <form id="addMemberForm">
                    <div class="input-group">
                        <label for="fullName">Full Name:</label>
                        <input type="text" id="fullName" placeholder="e.g., Alice Johnson" required>
                    </div>
                    <div class="input-group">
                        <label for="newEmail">Email:</label>
                        <input type="email" id="newEmail" placeholder="e.g., alice@example.com" required>
                    </div>
                    <div class="input-group">
                        <label for="newPassword">Password:</label>
                        <input type="password" id="newPassword" placeholder="********" required>
                    </div>
                    <div class="input-group">
                        <label for="memberRole">Role:</label>
                        <select id="memberRole" required>
                            <option value="">Select Role</option>
                            <option value="Agent">Agent</option>
                            <option value="QA">QA</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Admin">Admin</option>
                            <option value="Team Leader">Team Leader</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> Create System User</button>
                    <p id="addMemberMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                </form>

                <div class="staff-management-section">
                    <h2>Manage Attendance Roster</h2>
                    <p>This section allows you to add and manage staff members. Staff members are the people who appear on the attendance, leave, and shift schedule rosters. They are separate from system users who have login access.</p>
                    <hr>

                    <h3>Add New Staff Member</h3>
                    <form id="addStaffForm">
                        <div class="input-group">
                            <label for="staffFullName">Full Name:</label>
                            <input type="text" id="staffFullName" placeholder="e.g., Bob Williams" required>
                        </div>
                        <div class="input-group">
                            <label for="staffRole">Role:</label>
                            <select id="staffRole" required>
                                <option value="">Select Role</option>
                                <option value="Agent">Agent</option>
                                <option value="QA">QA</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Team Leader">Team Leader</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="staffSecondaryRole">Secondary Role:</label>
                            <select id="staffSecondaryRole">
                                <option value="">None</option>
                                <option value="Inbound">Inbound</option>
                                <option value="Inbound / Email">Inbound / Email</option>
                                <option value="Social Media">Social Media</option>
                                <option value="LiveChat">LiveChat</option>
                                <option value="Sales">Sales</option>
                                <option value="Onboarding">Onboarding</option>
                                <option value="Level 1 Escalations">Level 1 Escalations</option>
                                <option value="Email">Email</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add Staff Member</button>
                        <p id="addStaffMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                    </form>

                    <h3>System Users</h3>
                    <div class="staff-list-table-container">
                        <table class="staff-list-table">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userListTableBody">
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 40px;">Staff Roster</h3>
                    <p>This table contains the staff members who can be selected in the attendance, leave, and shift schedule pages. Inactive staff members will not appear in the main application. You can only delete staff members who are not system users.</p>
                    <div class="staff-list-table-container">
                        <table class="staff-list-table">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Secondary Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffRosterTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="attendanceMarkingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeAttendanceModal">&times;</span>
            <h2>Mark Attendance for <span id="modalDateDisplay"></span></h2>
            <div class="modal-table-container">
                <table id="modalAttendanceTable">
                    <thead>
                        <tr>
                            <th>Staff Name</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="modalAttendanceTableBody">
                    </tbody>
                </table>
            </div>
            <div class="modal-buttons">
                <button id="saveAttendanceBtn" class="btn btn-primary">Save Attendance</button>
                <button id="cancelAttendanceBtn" class="btn btn-secondary">Cancel</button>
                <p id="modalErrorMessage" class="error-message"></p>
            </div>
        </div>
    </div>

    <div id="calendarModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeCalendarModal">&times;</span>
            <div class="calendar-header">
                <button id="prevMonthBtn"><i class="fas fa-chevron-left"></i></button>
                <h3 id="currentMonthYear"></h3>
                <button id="nextMonthBtn"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-weekdays">
                <div>Sun</div>
                <div>Mon</div>
                <div>Tue</div>
                <div>Wed</div>
                <div>Thu</div>
                <div>Fri</div>
                <div>Sat</div>
            </div>
            <div class="calendar-days" id="calendarDaysGrid">
                </div>
            <div class="modal-buttons">
                <button id="selectDateFromCalendarBtn" class="btn btn-primary">Select Date</button>
                <button id="cancelCalendarSelection" class="btn btn-secondary">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig ={
            apiKey: "AIzaSyD9uPdQ7DfrKkOHyzcUnsJx5b2Fm51AdvY",
            authDomain: "attendance-d2f5c.firebaseapp.com",
            projectId: "attendance-d2f5c",
            storageBucket: "attendance-d2f5c.firebasestorage.app",
            messagingSenderId: "275359754293",
            appId: "1:275359754293:web:0fe5aa0f30d57c749ce97c",
            measurementId: "G-PWN5S35KTP"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global Variables / Caches ---
        let loggedInUser = null;
        let loggedInUserRole = 'Agent';
        let usersData = {};
        let staffData = {};
        const attendanceData = {};
        const markedDates = new Set();
        let activeAgents = [];

        const todayGlobal = new Date();

        // --- DOM Element References ---
        let DOM = {};

        // --- Constants and Utility Data ---
        const ATTENDANCE_STATUSES = [
            { value: '', text: 'Select Status', colorClass: '' },
            { value: 'WFO', text: 'Work From Office', colorClass: 'status-WFO' },
            { value: 'WFH', text: 'Work From Home', colorClass: 'status-WFH' },
            { value: 'SO', text: 'Signed Off', colorClass: 'status-SO' },
            { value: 'L', text: 'Leave (Annual)', colorClass: 'status-L' },
            { value: 'DO', text: 'Day Off', colorClass: 'status-DO' },
            { value: 'UL', text: 'Unpaid Leave', colorClass: 'status-UL' },
            { value: 'NCNS', text: 'No Call No Show', colorClass: 'status-NCNS' },
            { value: 'CL', text: 'Compassionate Leave', colorClass: 'status-CL' },
            { value: 'SOF', text: 'Sick Off', colorClass: 'status-SOF' }
        ];

        const ALL_ROLES = ["Agent", "QA", "Supervisor", "Team Leader", "Admin"];
        // The ALL_SECONDARY_ROLES constant is now declared only in workforceManagement.js

        // --- Core Helper Functions ---

        function updateActiveAgentsList() {
            activeAgents = Object.values(staffData)
                .filter(staff => staff.isActive)
                .sort((a, b) => a.fullName.localeCompare(b.fullName));
            console.log("Active agents list updated:", activeAgents.length, "active agents.");
        }

        async function fetchAllUsersData() {
            usersData = {};
            try {
                const usersSnapshot = await db.collection('users').get();
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersData[doc.id] = {
                        uid: doc.id,
                        fullName: userData.fullName,
                        role: userData.role,
                        email: userData.email,
                        isActive: userData.isActive
                    };
                });
                console.log("All system user data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching users from Firestore:", error.code, error.message);
                alert("Critical: Could not load user list from database. Check console and Firebase rules.");
            }
        }

        async function fetchAllStaffData() {
            staffData = {};
            try {
                const staffSnapshot = await db.collection('staff').get();
                staffSnapshot.forEach(doc => {
                    const staffMember = doc.data();
                    staffData[doc.id] = {
                        staffId: doc.id,
                        fullName: staffMember.fullName,
                        role: staffMember.role,
                        secondaryRole: staffMember.secondaryRole,
                        isActive: staffMember.isActive,
                        userId: staffMember.userId || null
                    };
                });
                updateActiveAgentsList();
                console.log("All staff data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching staff from Firestore:", error.code, error.message);
                alert("Critical: Could not load staff list from database. Check console and Firebase rules.");
            }
        }

        async function fetchAttendanceData() {
            for (const key in attendanceData) {
                delete attendanceData[key];
            }
            markedDates.clear();

            try {
                const attendanceSnapshot = await db.collection('attendance').get();
                attendanceSnapshot.forEach(doc => {
                    attendanceData[doc.id] = doc.data();
                    markedDates.add(doc.id);
                });
                console.log("Attendance data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching attendance data:", error);
                alert("Critical: Could not load attendance data. Check console and Firebase rules.");
            }
        }

        function setLoggedInState(loggedIn, user = null, userProfile = null) {
            if (loggedIn && user && userProfile) {
                loggedInUser = user;
                loggedInUserRole = userProfile.role;

                DOM.loginPage.classList.remove('active');
                DOM.appContainer.classList.add('active');

                DOM.loggedInUserName.textContent = userProfile.fullName || user.email;
                DOM.loggedInUserRoleDisplay.textContent = userProfile.role;

                if (loggedInUserRole === 'Admin') {
                    DOM.adminNavLink.style.display = 'list-item';
                } else {
                    DOM.adminNavLink.style.display = 'none';
                }

                const currentPageHash = window.location.hash.substring(1);
                let targetPageId = 'homePage';
                if (currentPageHash && DOM[currentPageHash + 'Page']) {
                    targetPageId = currentPageHash + 'Page';
                }
                showPage(targetPageId);

                if (Object.keys(usersData).length === 0 || Object.keys(staffData).length === 0 || Object.keys(attendanceData).length === 0) {
                    Promise.all([
                        fetchAllUsersData(),
                        fetchAllStaffData(),
                        fetchAttendanceData(),
                        fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth()),
                        fetchShiftScheduleData(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth())
                    ]).then(() => {
                        updateHomeStatistics();
                        populateEmployeeSelect();
                        populateIndividualSummarySelect();
                        updateDashboardData(DOM.employeeSelect.value);
                        renderUserList();
                        renderStaffRoster();
                    }).catch(err => {
                        console.error("Error during initial data fetch:", err);
                        alert("Failed to load initial application data.");
                    });
                } else {
                    updateHomeStatistics();
                    populateEmployeeSelect();
                    populateIndividualSummarySelect();
                    updateDashboardData(DOM.employeeSelect.value);
                    renderUserList();
                    renderStaffRoster();
                    if (DOM.shiftSchedulePage.classList.contains('active')) {
                        fetchShiftScheduleData(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth());
                    }
                }
            } else {
                loggedInUser = null;
                loggedInUserRole = 'Agent';

                DOM.loginPage.classList.add('active');
                DOM.appContainer.classList.remove('active');
                DOM.loginForm.reset();
                DOM.loginError.textContent = '';
                DOM.loggedInUserName.textContent = '';
                DOM.loggedInUserRoleDisplay.textContent = '';
                DOM.adminNavLink.style.display = 'none';
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.content-module').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            DOM.navLinks.forEach(link => {
                if (link.dataset.page === pageId.replace('Page', '')) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            switch (pageId) {
                case 'attendancePage':
                    generateAttendanceOverviewTable();
                    DOM.attendanceDateInput.value = '';
                    DOM.openAttendanceCalendarBtn.disabled = false;
                    selectedMarkingDate = null;
                    break;
                case 'dashboardPage':
                    populateEmployeeSelect();
                    updateDashboardData(DOM.employeeSelect.value);
                    break;
                case 'leaveTrackerPage':
                    fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth());
                    break;
                case 'shiftSchedulePage':
                    fetchShiftScheduleData(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth());
                    break;
                case 'adminPage':
                    renderUserList();
                    renderStaffRoster();
                    break;
                case 'individualSummaryPage':
                    populateIndividualSummarySelect();
                    DOM.summaryWFO.textContent = '0';
                    DOM.summaryWFH.textContent = '0';
                    DOM.summaryLeave.textContent = '0';
                    DOM.summarySickOff.textContent = '0';
                    DOM.summarySignedOff.textContent = '0';
                    DOM.summaryDayOff.textContent = '0';
                    DOM.summaryUnpaidLeave.textContent = '0';
                    DOM.summaryNCNS.textContent = '0';
                    DOM.summaryCompassionateLeave.textContent = '0';
                    DOM.monthlyWFHWFOChart.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 50px;">Select an employee to view chart data.</p>';
                    DOM.individualSelectSummary.value = '';
                    break;
                case 'reportsPage':
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    DOM.startDateInput.value = firstDayOfMonth;
                    DOM.endDateInput.value = lastDayOfMonth;
                    DOM.reportsTableBody.innerHTML = '';
                    break;
                case 'homePage':
                    updateHomeStatistics();
                    break;
            }
        }

        // --- Other functions (unchanged) ---
        // updateHomeStatistics(), renderCalendar(), populateModalAttendanceTable(),
        // saveAttendance(), generateAttendanceOverviewTable(), deleteAttendanceData(),
        // exportAttendanceDataToCSV(), populateEmployeeSelect(), populateIndividualSummarySelect(),
        // updateDashboardData(), renderAttendanceStatsChart(), renderWorkingLocationDonutChart(),
        // renderTopEmployeesChart(), updateIndividualSummary(), renderMonthlyWFHWFOChart(),
        // generateReportData(), renderReportTable(), exportReportToCSV()

        function renderUserList() {
            DOM.userListTableBody.innerHTML = '';
            const sortedUsers = Object.values(usersData).sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (sortedUsers.length === 0) {
                DOM.userListTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No system users found.</td></tr>`;
                return;
            }

            sortedUsers.forEach(user => {
                const tr = document.createElement('tr');
                const statusSelect = document.createElement('select');
                statusSelect.innerHTML = `
                    <option value="true" ${user.isActive ? 'selected' : ''}>Active</option>
                    <option value="false" ${!user.isActive ? 'selected' : ''}>Inactive</option>
                `;
                statusSelect.addEventListener('change', (e) => {
                    toggleUserStatus(user.uid, e.target.value === 'true');
                });

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => {
                    deleteUser(user.uid);
                });

                tr.innerHTML = `
                    <td>${user.fullName}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td></td>
                    <td></td>
                `;
                tr.children[3].appendChild(statusSelect);
                tr.children[4].appendChild(deleteButton);
                DOM.userListTableBody.appendChild(tr);
            });
        }

        function renderStaffRoster() {
            DOM.staffRosterTableBody.innerHTML = '';
            const sortedStaff = Object.values(staffData).sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (sortedStaff.length === 0) {
                DOM.staffRosterTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No staff members found.</td></tr>`;
                return;
            }

            sortedStaff.forEach(staff => {
                const tr = document.createElement('tr');
                const statusSelect = document.createElement('select');
                statusSelect.innerHTML = `
                    <option value="true" ${staff.isActive ? 'selected' : ''}>Active</option>
                    <option value="false" ${!staff.isActive ? 'selected' : ''}>Inactive</option>
                `;
                statusSelect.addEventListener('change', (e) => {
                    toggleStaffStatus(staff.staffId, e.target.value === 'true');
                });
                
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => {
                    deleteStaff(staff.staffId);
                });

                tr.innerHTML = `
                    <td>${staff.fullName}</td>
                    <td>${staff.role}</td>
                    <td>${staff.secondaryRole}</td>
                    <td></td>
                    <td></td>
                `;
                tr.children[3].appendChild(statusSelect);
                tr.children[4].appendChild(deleteButton);
                DOM.staffRosterTableBody.appendChild(tr);
            });
        }
        
        async function toggleUserStatus(uid, isActive) {
            const userToUpdate = usersData[uid];
            if (userToUpdate) {
                if (loggedInUser.uid === uid && !isActive) {
                    alert("You cannot deactivate your own account while logged in.");
                    renderUserList();
                    return;
                }
                try {
                    await db.collection('users').doc(uid).update({ isActive: isActive });
                    usersData[uid].isActive = isActive;
                    renderUserList();
                    alert(`User status for ${userToUpdate.fullName} updated to ${isActive ? 'Active' : 'Inactive'}.`);
                } catch (error) {
                    console.error("Error toggling user status:", error);
                    alert(`Failed to change status for ${userToUpdate.fullName}: ${error.message}`);
                }
            } else {
                alert("User not found or UID is missing.");
            }
        }
        
        async function toggleStaffStatus(staffId, isActive) {
            const staffToUpdate = staffData[staffId];
            if (staffToUpdate) {
                try {
                    await db.collection('staff').doc(staffId).update({ isActive: isActive });
                    staffData[staffId].isActive = isActive;
                    updateActiveAgentsList();
                    renderStaffRoster();
                    alert(`Staff member status for ${staffToUpdate.fullName} updated to ${isActive ? 'Active' : 'Inactive'}.`);
                } catch (error) {
                    console.error("Error toggling staff status:", error);
                    alert(`Failed to change status for ${staffToUpdate.fullName}: ${error.message}`);
                }
            } else {
                alert("Staff member not found.");
            }
        }
        
        async function deleteUser(uid) {
            const userToDelete = usersData[uid];
            if (!userToDelete) {
                alert("User not found.");
                return;
            }
            if (loggedInUser.uid === uid) {
                alert("You cannot delete your own account while logged in.");
                return;
            }
            const confirmDelete = confirm(`Are you sure you want to delete the system user account for ${userToDelete.fullName}? This will permanently remove their login access.`);
            if (!confirmDelete) return;

            try {
                await db.collection('users').doc(uid).delete();
                delete usersData[uid];
                renderUserList();
                alert(`System user account for ${userToDelete.fullName} deleted successfully.`);
            } catch (error) {
                console.error("Error deleting user:", error);
                alert(`Failed to delete user account: ${error.message}`);
            }
        }

        async function deleteStaff(staffId) {
            const staffToDelete = staffData[staffId];
            if (!staffToDelete) {
                alert("Staff member not found.");
                return;
            }
            const confirmDelete = confirm(`Are you sure you want to delete the staff member ${staffToDelete.fullName}? This will also remove them from all attendance, leave, and shift schedule rosters.`);
            if (!confirmDelete) return;

            try {
                const batch = db.batch();
                
                batch.delete(db.collection('staff').doc(staffId));
                
                const attendanceSnapshot = await db.collection('attendance').get();
                attendanceSnapshot.forEach(doc => {
                    const docData = doc.data();
                    if (docData[staffToDelete.fullName]) {
                        const updatedData = { ...docData };
                        delete updatedData[staffToDelete.fullName];
                        if (Object.keys(updatedData).length > 0) {
                            batch.update(db.collection('attendance').doc(doc.id), updatedData);
                        } else {
                            batch.delete(db.collection('attendance').doc(doc.id));
                        }
                    }
                });

                const leavesSnapshot = await db.collection('leaves').get();
                leavesSnapshot.forEach(doc => {
                    const monthDocData = doc.data();
                    if (monthDocData.data && Array.isArray(monthDocData.data)) {
                        const updatedData = monthDocData.data.filter(row => row.Name !== staffToDelete.fullName);
                        if (updatedData.length !== monthDocData.data.length) {
                            if (updatedData.length > 0) {
                                batch.update(db.collection('leaves').doc(doc.id), { data: updatedData });
                            } else {
                                batch.delete(db.collection('leaves').doc(doc.id));
                            }
                        }
                    }
                });
                
                const shiftRostersSnapshot = await db.collection('shiftRosters').get();
                shiftRostersSnapshot.forEach(doc => {
                    const monthRosterData = doc.data();
                    if (monthRosterData.roster && Array.isArray(monthRosterData.roster)) {
                        const updatedRoster = monthRosterData.roster.filter(entry => entry.agentName !== staffToDelete.fullName);
                        if (updatedRoster.length !== monthRosterData.roster.length) {
                            if (updatedRoster.length > 0) {
                                batch.update(db.collection('shiftRosters').doc(doc.id), { roster: updatedRoster });
                            } else {
                                batch.delete(db.collection('shiftRosters').doc(doc.id));
                            }
                        }
                    }
                });
                
                await batch.commit();
                
                delete staffData[staffId];
                updateActiveAgentsList();
                renderStaffRoster();
                alert(`Staff member ${staffToDelete.fullName} and their associated data deleted successfully.`);
                
            } catch (error) {
                console.error("Error deleting staff member:", error);
                alert(`Failed to delete staff member: ${error.message}`);
            }
        }

        // --- Event Listener Initialization ---
        function initializeEventListeners() {
            // Login/Logout
            DOM.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = DOM.loginEmailInput.value;
                const password = DOM.loginPasswordInput.value;
                DOM.loginError.textContent = '';

                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    console.log("User logged in successfully.");
                } catch (error) {
                    let errorMessage;
                    switch (error.code) {
                        case 'auth/user-not-found':
                        case 'auth/wrong-password':
                        case 'auth/invalid-credential':
                            errorMessage = 'Invalid email or password.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'Invalid email format.';
                            break;
                        case 'auth/user-disabled':
                            errorMessage = 'Your account has been disabled.';
                            break;
                        default:
                            errorMessage = `Login error: ${error.message}`;
                            break;
                    }
                    DOM.loginError.textContent = errorMessage;
                    console.error("Login Error:", error.code, error.message);
                }
            });

            DOM.logoutBtn.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                    console.log("User logged out.");
                } catch (error) {
                    console.error("Logout Error:", error);
                    alert("Failed to log out: " + error.message);
                }
            });

            // Navigation
            DOM.navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (loggedInUser) {
                        const pageId = link.dataset.page + 'Page';
                        if (link.dataset.page === 'admin' && loggedInUserRole !== 'Admin') {
                            alert("You do not have permission to access the Admin page.");
                            return;
                        }
                        showPage(pageId);
                        window.location.hash = link.dataset.page;
                    } else {
                        alert("Please log in to access the application.");
                    }
                });
            });

            // Attendance Marking Workflow
            DOM.openAttendanceCalendarBtn.addEventListener('click', () => {
                currentCalendarDate = new Date();
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
                DOM.calendarModal.style.display = 'flex';
            });

            DOM.selectDateFromCalendarBtn.addEventListener('click', () => {
                if (selectedMarkingDate) {
                    DOM.attendanceDateInput.value = selectedMarkingDate;
                    DOM.modalDateDisplay.textContent = selectedMarkingDate;
                    populateModalAttendanceTable();
                    DOM.calendarModal.style.display = 'none';
                    DOM.attendanceMarkingModal.style.display = 'flex';
                } else {
                    alert('Please select a date from the calendar.');
                }
            });


            // Calendar Modal
            DOM.closeCalendarModal.addEventListener('click', () => DOM.calendarModal.style.display = 'none');
            DOM.cancelCalendarSelection.addEventListener('click', () => {
                DOM.calendarModal.style.display = 'none';
                selectedMarkingDate = null;
                DOM.attendanceDateInput.value = '';
            });
            DOM.prevMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });
            DOM.nextMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar(currentCalendarDate.getFullYear(), currentCalendarDate.getMonth());
            });

            // Attendance Marking Modal
            DOM.closeAttendanceModal.addEventListener('click', () => DOM.attendanceMarkingModal.style.display = 'none');
            DOM.cancelAttendanceBtn.addEventListener('click', () => DOM.attendanceMarkingModal.style.display = 'none');
            DOM.saveAttendanceBtn.addEventListener('click', saveAttendance);

            // Attendance Overview Table
            DOM.deleteAttendanceDataBtn.addEventListener('click', deleteAttendanceData);
            DOM.exportAttendanceDataBtn.addEventListener('click', exportAttendanceDataToCSV);

            // Individual Summary
            DOM.individualSelectSummary.addEventListener('change', (e) => updateIndividualSummary(e.target.value));

            // Dashboard
            DOM.employeeSelect.addEventListener('change', (e) => updateDashboardData(e.target.value));

            // Reports Page
            DOM.generateReportBtn.addEventListener('click', () => {
                const reportType = DOM.reportTypeSelect.value;
                const startDate = DOM.startDateInput.value;
                const endDate = DOM.endDateInput.value;

                if (!startDate || !endDate) {
                    alert('Please select both start and end dates for the report.');
                    return;
                }
                generateReportData(reportType, startDate, endDate);
            });
            DOM.exportReportCsvBtn.addEventListener('click', exportReportToCSV);

            // Admin Add User Form
            DOM.addMemberForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOM.addMemberMessage.style.display = 'none';
                const fullName = DOM.fullNameInput.value.trim();
                const newEmail = DOM.newEmailInput.value.trim();
                const newPassword = DOM.newPasswordInput.value;
                const memberRole = DOM.memberRoleSelect.value;

                if (!fullName || !newEmail || !newPassword || !memberRole) {
                    DOM.addMemberMessage.textContent = 'All fields are required!';
                    DOM.addMemberMessage.style.color = '#dc3545';
                    DOM.addMemberMessage.style.display = 'block';
                    return;
                }

                try {
                    const userCredential = await auth.createUserWithEmailAndPassword(newEmail, newPassword);
                    const newUser = userCredential.user;

                    await db.collection('users').doc(newUser.uid).set({
                        fullName: fullName,
                        email: newEmail,
                        role: memberRole,
                        isActive: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    DOM.addMemberMessage.textContent = `User ${fullName} created successfully!`;
                    DOM.addMemberMessage.style.color = '#28a745';
                    DOM.addMemberMessage.style.display = 'block';
                    DOM.addMemberForm.reset();

                    await fetchAllUsersData();
                    renderUserList();
                } catch (error) {
                    let errorMessage = 'Error creating user.';
                    switch (error.code) {
                        case 'auth/email-already-in-use':
                            errorMessage = 'The email address is already in use by another account.';
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'Password is too weak. Please choose a stronger password.';
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'The email address is not valid.';
                            break;
                        default:
                            errorMessage = `Error: ${error.message}`;
                            break;
                    }
                    DOM.addMemberMessage.textContent = errorMessage;
                    DOM.addMemberMessage.style.color = '#dc3545';
                    DOM.addMemberMessage.style.display = 'block';
                    console.error("Add User Error:", error.code, error.message);
                }
            });
            
            // New event listener for adding staff members
            DOM.addStaffForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOM.addStaffMessage.style.display = 'none';
                const fullName = DOM.staffFullNameInput.value.trim();
                const role = DOM.staffRoleSelect.value;
                const secondaryRole = DOM.staffSecondaryRoleSelect.value;

                if (!fullName || !role) {
                    DOM.addStaffMessage.textContent = 'Full Name and Role are required!';
                    DOM.addStaffMessage.style.color = '#dc3545';
                    DOM.addStaffMessage.style.display = 'block';
                    return;
                }

                try {
                    await db.collection('staff').add({
                        fullName: fullName,
                        role: role,
                        secondaryRole: secondaryRole || 'None',
                        isActive: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    DOM.addStaffMessage.textContent = `Staff member ${fullName} added successfully!`;
                    DOM.addStaffMessage.style.color = '#28a745';
                    DOM.addStaffMessage.style.display = 'block';
                    DOM.addStaffForm.reset();
                    
                    await fetchAllStaffData();
                    renderStaffRoster();
                } catch (error) {
                    console.error("Error adding staff member:", error);
                    DOM.addStaffMessage.textContent = `Error adding staff member: ${error.message}`;
                    DOM.addStaffMessage.style.color = '#dc3545';
                    DOM.addStaffMessage.style.display = 'block';
                }
            });
            
            // The event listeners for Shift Schedule and Leave Tracker are now in workforceManagement.js
        }

        // --- DOMContentLoaded and Initial Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Assign DOM elements to the DOM object
            DOM = {
                loginPage: document.getElementById('loginPage'),
                appContainer: document.getElementById('appContainer'),
                loginForm: document.getElementById('loginForm'),
                loginEmailInput: document.getElementById('loginEmail'),
                loginPasswordInput: document.getElementById('loginPassword'),
                loginError: document.getElementById('loginError'),

                loggedInUserName: document.getElementById('loggedInUserName'),
                loggedInUserRoleDisplay: document.getElementById('loggedInUserRole'),
                logoutBtn: document.getElementById('logoutBtn'),
                adminNavLink: document.getElementById('adminNavLink'),
                navLinks: document.querySelectorAll('.main-nav a'),

                homePage: document.getElementById('homePage'),
                statTotalPresent: document.getElementById('statTotalPresent'),
                statTotalStaff: document.getElementById('statTotalStaff'),
                statAgentsOnLeaveWeek: document.getElementById('statAgentsOnLeaveWeek'),
                statAgentsOnSickOffWeek: document.getElementById('statAgentsOnSickOffWeek'),
                staffOnLeaveNames: document.getElementById('staffOnLeaveNames'),
                agentsOnSickOffNames: document.getElementById('agentsOnSickOffNames'),

                attendancePage: document.getElementById('attendancePage'),
                attendanceDateInput: document.getElementById('attendanceDateInput'),
                openAttendanceCalendarBtn: document.getElementById('openAttendanceCalendarBtn'),
                attendanceMarkingMessage: document.getElementById('attendanceMarkingMessage'),
                attendanceOverviewTableContainer: document.getElementById('attendanceOverviewTableContainer'),
                deleteAttendanceDataBtn: document.getElementById('deleteAttendanceDataBtn'),
                exportAttendanceDataBtn: document.getElementById('exportAttendanceDataBtn'),

                attendanceMarkingModal: document.getElementById('attendanceMarkingModal'),
                closeAttendanceModal: document.getElementById('closeAttendanceModal'),
                modalDateDisplay: document.getElementById('modalDateDisplay'),
                modalAttendanceTableBody: document.getElementById('modalAttendanceTable').querySelector('tbody'),
                saveAttendanceBtn: document.getElementById('saveAttendanceBtn'),
                cancelAttendanceBtn: document.getElementById('cancelAttendanceBtn'),
                modalErrorMessage: document.getElementById('modalErrorMessage'),

                calendarModal: document.getElementById('calendarModal'),
                closeCalendarModal: document.getElementById('closeCalendarModal'),
                prevMonthBtn: document.getElementById('prevMonthBtn'),
                nextMonthBtn: document.getElementById('nextMonthBtn'),
                currentMonthYear: document.getElementById('currentMonthYear'),
                calendarDaysGrid: document.getElementById('calendarDaysGrid'),
                cancelCalendarSelection: document.getElementById('cancelCalendarSelection'),
                selectDateFromCalendarBtn: document.getElementById('selectDateFromCalendarBtn'),

                leaveTrackerPage: document.getElementById('leaveTrackerPage'),
                prevMonthLeaveBtn: document.getElementById('prevMonthLeaveBtn'),
                nextMonthLeaveBtn: document.getElementById('nextMonthLeaveBtn'),
                currentLeaveMonthYear: document.getElementById('currentLeaveMonthYear'),
                leaveTrackerTableContainer: document.getElementById('leaveTrackerTableContainer'),

                shiftSchedulePage: document.getElementById('shiftSchedulePage'),
                prevMonthShiftScheduleBtn: document.getElementById('prevMonthShiftScheduleBtn'),
                nextMonthShiftScheduleBtn: document.getElementById('nextMonthShiftScheduleBtn'),
                currentShiftScheduleMonthYear: document.getElementById('currentShiftScheduleMonthYear'),
                scheduleRoleFilter: document.getElementById('scheduleRoleFilter'),
                shiftScheduleTableBody: document.getElementById('shiftScheduleTableBody'),
                shiftScheduleTableHead: document.getElementById('shiftScheduleTableHead'),
                shiftCountsTable: document.getElementById('shiftCountsTable'),
                shiftCountsTableBody: document.getElementById('shiftCountsTableBody'),


                individualSummaryPage: document.getElementById('individualSummaryPage'),
                individualSelectSummary: document.getElementById('individualSelectSummary'),
                summaryWFO: document.getElementById('summaryWFO'),
                summaryWFH: document.getElementById('summaryWFH'),
                summaryLeave: document.getElementById('summaryLeave'),
                summarySickOff: document.getElementById('summarySickOff'),
                summarySignedOff: document.getElementById('summarySignedOff'),
                summaryDayOff: document.getElementById('summaryDayOff'),
                summaryUnpaidLeave: document.getElementById('summaryUnpaidLeave'),
                summaryNCNS: document.getElementById('summaryNCNS'),
                summaryCompassionateLeave: document.getElementById('summaryCompassionateLeave'),
                monthlyWFHWFOChart: document.getElementById('monthlyWFHWFOChart'),

                dashboardPage: document.getElementById('dashboardPage'),
                dashboardStartDate: document.getElementById('dashboardStartDate'),
                employeeSelect: document.getElementById('employeeSelect'),
                dashboardTotalEmployees: document.getElementById('dashboardTotalEmployees'),
                dashboardAbsenceDays: document.getElementById('dashboardAbsenceDays'),
                dashboardUnapprovedLeave: document.getElementById('dashboardUnapprovedLeave'),
                overallAttendanceGaugeFill: document.getElementById('overallAttendanceGaugeFill'),
                overallAttendanceGaugeLabel: document.getElementById('overallAttendanceGaugeLabel'),
                attendanceStatsChart: document.getElementById('attendanceStatsChart'),
                leaveTakenSick: document.getElementById('leaveTakenSick'),
                leaveTakenCasual: document.getElementById('leaveTakenCasual'),
                leaveTakenAnnual: document.getElementById('leaveTakenAnnual'),
                leaveTakenUnpaid: document.getElementById('leaveTakenUnpaid'),
                workingLocationDonutChart: document.getElementById('workingLocationDonutChart'),
                workingLocationDonutLabel: document.getElementById('workingLocationDonutLabel'),
                topEmployeesChart: document.getElementById('topEmployeesChart'),

                reportsPage: document.getElementById('reportsPage'),
                reportTypeSelect: document.getElementById('reportType'),
                startDateInput: document.getElementById('startDate'),
                endDateInput: document.getElementById('endDate'),
                generateReportBtn: document.getElementById('generateReportBtn'),
                exportReportCsvBtn: document.getElementById('exportReportCsvBtn'),
                reportsTableBody: document.getElementById('reportsTableBody'),
                reportTable: document.getElementById('reportTable'),

                adminPage: document.getElementById('adminPage'),
                addMemberForm: document.getElementById('addMemberForm'),
                fullNameInput: document.getElementById('fullName'),
                newEmailInput: document.getElementById('newEmail'),
                newPasswordInput: document.getElementById('newPassword'),
                memberRoleSelect: document.getElementById('memberRole'),
                addMemberMessage: document.getElementById('addMemberMessage'),
                userListTableBody: document.getElementById('userListTableBody'),
                
                addStaffForm: document.getElementById('addStaffForm'),
                staffFullNameInput: document.getElementById('staffFullName'),
                staffRoleSelect: document.getElementById('staffRole'),
                staffSecondaryRoleSelect: document.getElementById('staffSecondaryRole'),
                addStaffMessage: document.getElementById('addStaffMessage'),
                staffRosterTableBody: document.getElementById('staffRosterTableBody'),
            };

            initializeEventListeners();
            initializeWorkforceEventListeners();
            
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log("Firebase Auth State Changed: User is logged in.", user.email);
                    try {
                        const userProfileDoc = await db.collection('users').doc(user.uid).get();
                        if (userProfileDoc.exists) {
                            const userProfile = userProfileDoc.data();
                            setLoggedInState(true, user, userProfile);
                        } else {
                            console.warn("User profile not found in Firestore for UID:", user.uid);
                            alert("Your user profile is incomplete. Please contact administrator.");
                            auth.signOut();
                        }
                    } catch (error) {
                        console.error("Error fetching user profile:", error);
                        alert("Error fetching user profile. Please try again.");
                        auth.signOut();
                    }
                } else {
                    console.log("Firebase Auth State Changed: User is logged out.");
                    setLoggedInState(false);
                }
            });
        });
    </script>
</body>
</html>
