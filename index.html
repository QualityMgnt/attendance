<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMS - Contact Center Attendance</title>
    <link href="https://fonts.googleapis.com/css2?family=Garamond:wght@400;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <script src="workforceManagement.js"></script>

    <style>
        /* Basic styles for demonstration, ideally these would be in style.css */
        body {
            font-family: 'Garamond', serif;
            margin: 0;
            background-color: #f4f7f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }

        /* Login page specific background color */
        #loginPage.active {
            background-color: #800080;
        }

        /* Re-apply Poppins to specific elements where it enhances readability (e.g., buttons, smaller text) */
        .btn, .main-nav a, .input-group label, .input-group input, .input-group select, .stat-card h3, .user-role, .dashboard-header-card .label, .dashboard-header-card .value, .dashboard-section-title, .dashboard-card-new h3, .gauge-label, .bar-chart-month-labels div, .chart-grid .label, .donut-chart-label, .donut-legend-item, .employee-bar-item, .summary-stat-card h4, .summary-stat-card .count, .monthly-bar-label, .chart-legend {
            font-family: 'Poppins', sans-serif;
        }


        .page {
            display: none;
            width: 100%;
            height: 100vh;
        }

        .page.active {
            display: flex;
        }

        /* Login Container */
        .login-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 380px;
            max-width: 90%;
            margin: auto;
        }

        .login-container h2 {
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .input-group input[type="email"],
        .input-group input[type="password"],
        .input-group input[type="text"],
        .input-group select,
        .input-group input[type="date"],
        .input-group input[type="time"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        .input-group input:focus,
        .input-group select:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
        }

        .btn-primary {
            background-color: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn-sm {
            padding: 8px 15px;
            font-size: 14px;
        }

        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
        }

        .success-message {
            color: #28a745;
            margin-top: 15px;
            font-size: 14px;
            text-align: center;
        }

        /* App Container Layout */
        .app-container {
            display: flex;
            width: 100%;
            max-width: 1400px;
            height: 100vh;
            background-color: #fff;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: #800080;
            color: white;
            padding: 25px 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        }

        .sidebar .logo {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 40px;
            color: white;
        }

        .main-nav ul {
            list-style: none;
            padding: 0;
            width: 100%;
        }

        .main-nav li {
            margin-bottom: 10px;
        }

        .main-nav a {
            display: flex;
            align-items: center;
            color: #ecf0f1;
            text-decoration: none;
            padding: 15px 30px;
            font-size: 17px;
            transition: background-color 0.3s, color 0.3s;
        }

        .main-nav a i {
            margin-right: 15px;
            font-size: 20px;
        }

        .main-nav a:hover,
        .main-nav a.active {
            background-color: #9932CC;
            color: #ffffff;
            border-left: 5px solid #007bff;
            padding-left: 25px;
        }

        .logout-btn {
            margin-top: auto;
            width: 80%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logout-btn i {
            margin-right: 10px;
        }


        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
        }

        .top-system-bar {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            font-size: 28px;
            font-weight: 500;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .app-header {
            background-color: #ffffff;
            padding: 25px 30px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .app-header h1 {
            margin: 0;
            font-size: 26px;
            color: #2c3e50;
            font-weight: 600;
        }

        .user-info {
            font-size: 16px;
            color: #555;
        }

        .user-info strong {
            color: #2c3e50;
            margin-right: 5px;
        }

        .user-role {
            background-color: #e9ecef;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
            color: #6c757d;
        }

        .content-module {
            padding: 30px;
            flex-grow: 1;
            overflow-y: auto;
            display: none;
        }

        .content-module.active {
            display: block;
        }

        .content-module h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 24px;
            font-weight: 600;
        }

        .content-module hr {
            border: 0;
            height: 1px;
            background-color: #eee;
            margin-bottom: 25px;
        }

        /* Home Page Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .stat-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card h3 {
            color: #007bff;
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .stat-value {
            font-size: 42px;
            font-weight: 700;
            color: #2c3e50;
            margin: 0;
        }

        /* Notifications */
        .notifications-list {
            margin-top: 20px;
        }

        .notification-item {
            background-color: #ffffff;
            border-left: 5px solid;
            padding: 15px 20px;
            margin-bottom: 12px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s;
        }

        .notification-item:hover {
            transform: translateY(-2px);
        }

        .notification-item.success { border-color: #28a745; }
        .notification-item.info { border-color: #17a2b8; }
        .notification-item.warning { border-color: #ffc107; }
        .notification-item.danger { border-color: #dc3545; }

        .notification-icon {
            font-size: 24px;
            margin-right: 15px;
            line-height: 1;
        }

        .notification-item.success .notification-icon { color: #28a745; }
        .notification-item.info .notification-icon { color: #17a2b8; }
        .notification-item.warning .notification-icon { color: #ffc107; }
        .notification-item.danger .notification-icon { color: #dc3545; }

        .notification-item p {
            margin: 0;
            color: #495057;
            line-height: 1.4;
        }

        /* Styles for Attendance Marking Section */
        .mark-attendance-section {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .mark-attendance-section .input-group {
            margin-bottom: 0;
            flex-grow: 1;
        }

        /* Modal Styles (General for both attendance and calendar) */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            padding-top: 50px;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            position: relative;
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 15px;
            right: 25px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .modal-content h2 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 22px;
        }

        .modal-table-container {
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
            flex-grow: 1;
        }

        #modalAttendanceTable {
            width: 100%;
            border-collapse: collapse;
        }

        #modalAttendanceTable th,
        #modalAttendanceTable td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            text-align: left;
        }

        #modalAttendanceTable th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 5;
        }

        #modalAttendanceTable td:last-child select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        .modal-buttons {
            text-align: right;
            margin-top: 20px;
        }
        .modal-buttons .btn {
            margin-left: 10px;
        }

        /* Calendar Modal Specific Styles */
        #calendarModal .modal-content {
            max-width: 400px;
            padding: 20px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .calendar-header button {
            background: none;
            border: 1px solid #ccc;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        .calendar-header button:hover {
            background-color: #e9ecef;
        }

        .calendar-header h3 {
            margin: 0;
            font-size: 20px;
            color: #2c3e50;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .calendar-weekdays div {
            padding: 8px 0;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            text-align: center;
        }

        .calendar-day {
            padding: 10px 0;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            font-weight: 500;
            color: #495057;
        }

        .calendar-day:hover:not(.empty):not(.disabled):not(.selected) {
            background-color: #e9ecef;
        }

        .calendar-day.empty {
            visibility: hidden;
        }

        .calendar-day.today {
            background-color: #007bff;
            color: white;
            font-weight: 700;
        }

        .calendar-day.selected {
            background-color: #28a745;
            color: white;
            font-weight: 700;
        }

        .calendar-day.disabled {
            background-color: #f0f0f0;
            color: #a0a0a0;
            cursor: not-allowed;
            text-decoration: line-through;
        }


        /* Toolbar for Attendance Table */
        .attendance-table-toolbar {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
        }

        /* Attendance Table */
        .attendance-table-container {
            overflow-x: auto;
            margin-bottom: 30px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .attendance-overview-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1000px;
        }

        .attendance-overview-table th,
        .attendance-overview-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }

        .attendance-overview-table th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .attendance-overview-table td:last-child,
        .attendance-overview-table th:last-child {
            border-right: none;
        }

        .attendance-overview-table tr:last-child td {
            border-bottom: none;
        }

        .attendance-overview-table tbody tr:hover {
            background-color: #f1f1f1;
        }

        .attendance-cell {
            position: relative;
            padding: 0;
            background-color: #fcfcfc;
        }

        .attendance-status-select {
            width: 100%;
            height: 100%;
            padding: 8px 10px;
            border: none;
            background-color: transparent;
            font-size: 15px;
            color: #333;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
            outline: none;
        }


        /* Status Guide */
        .attendance-status-guide {
            background-color: #f1f7fe;
            border: 1px solid #d0e7ff;
            padding: 20px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            margin-top: 20px;
        }

        .attendance-status-guide h3 {
            width: 100%;
            margin-top: 0;
            margin-bottom: 15px;
            color: #007bff;
            font-size: 18px;
        }

        .attendance-status-guide p {
            margin: 0;
            display: flex;
            align-items: center;
            color: #555;
            font-size: 15px;
        }

        .status-indicator-guide {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-right: 8px;
            display: inline-block;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* Status Colors for table cells and guide */
        .status-WFO { background-color: #28a745; color: white; }
        .status-WFH { background-color: #17a2b8; color: white; }
        .status-SO { background-color: #6f42c1; color: white; }
        .status-L { background-color: #ffc107; color: #333; }
        .status-DO { background-color: #6c757d; color: white; }
        .status-UL { background-color: #dc3545; color: white; }
        .status-NCNS { background-color: #fd7e14; color: white; }
        .status-CL { background-color: #20c997; color: white; }
        .status-SOF { background-color: #dc3545; color: white; }


        /* Dashboard Styles (New) */
        .dashboard-container {
            padding: 20px;
            background-color: #f4f7f6;
            display: grid;
            gap: 2mm;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            align-items: start;
        }

        .dashboard-header-row {
            grid-column: 1 / -1;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }

        .dashboard-header-card {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 200px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        .dashboard-header-card.employee-name {
            background-color: #28a745;
        }

        .dashboard-header-card i {
            font-size: 30px;
        }

        .dashboard-header-card div {
            display: flex;
            flex-direction: column;
        }

        .dashboard-header-card .label {
            font-size: 14px;
            opacity: 0.8;
        }

        .dashboard-header-card .value {
            font-size: 22px;
            font-weight: 600;
        }

        .dashboard-header-card select {
            background-color: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            flex-grow: 1;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23ffffff%22%20d%3D%22M287%2C197.9c-3.2%2C3.2-8.3%2C3.2-11.5%2C0L146.2%2C68.9L16.9%2C197.9c-3.2%2C3.2-8.3%2C3.2-11.5%2C0c-3.2-3.2-3.2-8.3%2C0-11.5l135.5-135.5c3.2-3.2%2C8.3-3.2%2C11.5%2C0l135.5%2C135.5C290.2%2C189.6%2C290.2%2C194.7%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 10px top 50%;
            background-size: 12px auto;
        }

        .dashboard-header-card select option {
            background-color: #28a745;
            color: white;
        }

        .dashboard-section-title {
            grid-column: 1 / -1;
            font-size: 22px;
            color: #2c3e50;
            margin-top: 10px;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .dashboard-card-new {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
        }

        .dashboard-card-new h3 {
            color: #2c3e50;
            font-size: 18px;
            margin-top: 0;
            margin-bottom: 15px;
            font-weight: 600;
        }

        /* Gauge styles (simplified static representation) */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            margin-bottom: 15px;
        }

        .gauge {
            width: 100px;
            height: 50px;
            border-radius: 100px 100px 0 0;
            border: 5px solid #e0e0e0;
            border-bottom: none;
            position: relative;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .gauge-fill {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform-origin: bottom center;
            transition: transform 0.5s ease-in-out;
            background-color: #007bff;
            border-radius: 100px 100px 0 0;
        }

        .gauge-label {
            font-size: 14px;
            color: #555;
            margin-top: 5px;
        }

        /* Specific gauge colors */
        .gauge-overall .gauge-fill { background-color: #007bff; }


        /* Bar Chart styles (simplified static representation) */
        .bar-chart-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            gap: 5px;
            height: 200px;
            padding-top: 10px;
            position: relative;
        }

        .bar-chart-month-labels {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
            color: #777;
            margin-top: 10px;
            border-top: 1px solid #eee;
            padding-top: 5px;
        }

        .bar-chart-month-labels > div {
            flex: 1;
            text-align: center;
        }

        .bar-group {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            border-left: 1px solid #eee;
            padding-left: 5px;
        }

        .bar {
            width: 15px;
            background-color: #007bff;
            margin: 0 2px;
            transition: height 0.3s ease;
            position: relative;
        }

        .bar.late { background-color: #dc3545; }
        .bar.absent { background-color: #ffc107; }
        .bar.on-time-bar { background-color: #007bff; }


        /* Specific chart layouts */
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }
        .chart-grid > div {
            text-align: center;
        }
        .chart-grid .value {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }
        .chart-grid .label {
            font-size: 14px;
            color: #6c757d;
        }

        /* Donut Chart (simplified static representation) */
        .donut-chart-container {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            /* background will be set dynamically by JS */
            margin: 0 auto 15px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
        }
        .donut-chart-center {
            position: absolute;
            width: 70px;
            height: 70px;
            background-color: #fff;
            border-radius: 50%;
        }
        .donut-chart-label {
            font-size: 14px;
            color: #555;
            text-align: center;
        }
        .donut-legend {
            display: flex;
            flex-direction: column;
            gap: 5px;
            font-size: 14px;
            margin-top: 10px;
        }
        .donut-legend-item {
            display: flex;
            align-items: center;
        }
        .donut-legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
        }

        /* Top Employees Bar Chart */
        .top-employees-chart {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            padding-top: 10px;
        }
        .employee-bar-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            font-size: 15px;
            color: #495057;
        }
        .employee-name-label {
            width: 100px;
            text-align: right;
            margin-right: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .employee-bar-track {
            flex-grow: 1;
            height: 15px;
            background-color: #e9ecef;
            border-radius: 8px;
            width: 0%;
            transition: width 0.5s ease-out;
        }
        .employee-bar-value {
            margin-left: 10px;
            font-weight: 600;
            color: #2c3e50;
            min-width: 30px;
        }


        /* Leave Tracker Specific Styles */
        .leave-tracker-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .leave-tracker-header h3 {
            margin: 0;
            font-size: 22px;
            color: #2c3e50;
        }

        .leave-tracker-table-container {
            overflow-x: auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
        }

        .leave-planner-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 1200px;
        }

        .leave-planner-table th,
        .leave-planner-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 5px;
            text-align: center;
            white-space: nowrap;
            position: relative;
        }

        .leave-planner-table thead th {
            background-color: #f0f0f0;
            font-weight: 600;
            color: #333;
            position: sticky;
            top: 0;
            z-index: 2;
        }

        .leave-planner-table tbody td {
            background-color: #fff;
            color: #555;
        }

        .leave-planner-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .leave-planner-table td:first-child,
        .leave-planner-table td:nth-child(2),
        .leave-planner-table td:nth-child(3),
        .leave-planner-table td:nth-child(4) {
            text-align: left;
            padding-left: 10px;
            font-weight: 500;
            background-color: #e9f5ff;
            position: sticky;
            left: 0;
            z-index: 1;
        }
        .leave-planner-table th:first-child,
        .leave-planner-table th:nth-child(2),
        .leave-planner-table th:nth-child(3),
        .leave-planner-table th:nth-child(4) {
            text-align: left;
            padding-left: 10px;
            background-color: #d0e7ff;
            position: sticky;
            left: 0;
            z-index: 3;
        }

        /* Specific styling for 'L' cells */
        .leave-planner-table td.pending-leave { background-color: #ffeeba; }
        .leave-planner-table td.approved-leave { background-color: #c3e6cb; }
        .leave-planner-table td.declined-leave { background-color: #f8d7da; }
        .leave-planner-table td.pending-leave,
        .leave-planner-table td.approved-leave,
        .leave-planner-table td.declined-leave {
            font-weight: bold;
        }


        /* Leave Approval Overlay */
        .leave-approval-overlay {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            display: none; /* Hide by default */
            gap: 10px;
            font-size: 13px;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            pointer-events: auto;
        }
        .leave-approval-overlay button {
            background: none;
            border: 1px solid white;
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .leave-approval-overlay button:hover {
            background-color: white;
            color: #000;
        }
        .leave-approval-overlay .approve-btn { border-color: #28a745; color: #28a45; }
        .leave-approval-overlay .approve-btn:hover { background-color: #28a745; color: white; }
        .leave-approval-overlay .decline-btn { border-color: #dc3545; color: #dc3545; }
        .leave-approval-overlay .decline-btn:hover { background-color: #dc3545; color: white; }


        /* Admin Staff Management */
        .staff-management-section {
            margin-top: 40px;
        }

        .staff-management-section h3 {
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        #addStaffForm .input-group {
            display: inline-block;
            width: 250px;
            margin-right: 15px;
            vertical-align: top;
        }
        
        #addStaffForm .input-group:last-of-type {
            margin-right: 0;
        }

        #addStaffForm button {
            margin-top: 30px;
        }

        .staff-list-table-container {
            overflow-x: auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
            margin-top: 20px;
        }

        .staff-list-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        .staff-list-table th,
        .staff-list-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
        }

        .staff-list-table th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
        }

        .staff-list-table td select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .staff-list-table td .btn {
            padding: 5px 10px;
            font-size: 14px;
            margin-left: 5px;
        }
        .staff-status-active { color: #28a745; font-weight: 600;}
        .staff-status-inactive { color: #dc3545; font-weight: 600;}
        .user-list-table th:first-child,
        .user-list-table td:first-child,
        .user-list-table th:nth-child(2),
        .user-list-table td:nth-child(2) {
            position: sticky;
            left: 0;
            background-color: #f0f0f0;
            z-index: 1;
        }
        .user-list-table td {
            background-color: #fff;
        }
        .user-list-table th {
            background-color: #e9ecef;
        }


        /* Individual Summary Page */
        .individual-summary-controls {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .individual-summary-controls .input-group {
            margin-bottom: 0;
            flex-grow: 1;
        }

        .summary-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-stat-card {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        .summary-stat-card h4 {
            margin: 0;
            font-size: 16px;
            color: #555;
        }
        .summary-stat-card .count {
            font-size: 36px;
            font-weight: 700;
            color: #2c3e50;
            margin-top: 10px;
        }

        .individual-summary-chart-container {
            background-color: #ffffff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .individual-summary-chart-container h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 20px;
        }
        .monthly-bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            width: 100%;
            height: 200px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            gap: 10px;
        }
        .monthly-bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
            justify-content: flex-end;
            flex: 1;
        }
        .monthly-bar {
            width: 25px;
            margin-bottom: 2px;
            transition: height 0.3s ease-out;
        }
        .monthly-bar.wfo { background-color: #007bff; }
        .monthly-bar.wfh { background-color: #28a745; }
        .monthly-bar-label {
            font-size: 12px;
            color: #777;
            margin-top: 5px;
            text-align: center;
        }
        .chart-legend {
            display: flex;
            gap: 20px;
            margin-top: 20px;
            font-size: 14px;
        }
        .legend-item {
            display: flex;
            align-items: center;
        }
        .legend-color-box {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 8px;
        }

        .report-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .report-filters .input-group {
            margin-bottom: 0;
            flex-basis: 180px;
            flex-grow: 1;
        }

        .report-filters button {
            align-self: flex-end;
            padding: 10px 20px;
            height: fit-content;
        }

        .report-results table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .report-results th,
        .report-results td {
            border: 1px solid #eee;
            padding: 12px 15px;
            text-align: left;
        }

        .report-results th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
        }

        .report-results tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .report-results tbody tr:hover {
            background-color: #f1f1f1;
        }

        /* Shift Schedule Specific Styles */
        .shift-schedule-controls {
            display: flex;
            align-items: flex-end;
            gap: 20px;
            margin-bottom: 30px;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            flex-wrap: wrap;
        }

        .shift-schedule-controls .input-group {
            margin-bottom: 0;
            flex-grow: 1;
            min-width: 150px;
        }

        .shift-schedule-table-container {
            overflow-x: auto;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
            margin-bottom: 30px;
        }

        .shift-schedule-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
            min-width: 800px;
        }

        .shift-schedule-table th,
        .shift-schedule-table td {
            border: 1px solid #e0e0e0;
            padding: 10px;
            text-align: left;
            white-space: nowrap;
        }

        /* Fixed left columns */
        .shift-schedule-table th:nth-child(1),
        .shift-schedule-table td:nth-child(1) {
            position: sticky;
            left: 0;
            z-index: 4;
            background-color: #f0f0f0;
            width: 50px;
            text-align: center;
        }
        .shift-schedule-table td:nth-child(1) {
            background-color: #fff;
        }

        .shift-schedule-table th:nth-child(2),
        .shift-schedule-table td:nth-child(2) {
            position: sticky;
            left: 50px;
            z-index: 4;
            background-color: #f0f0f0;
            width: 150px;
        }
        .shift-schedule-table td:nth-child(2) {
            background-color: #fff;
        }

        .shift-schedule-table th:nth-child(3),
        .shift-schedule-table td:nth-child(3) {
            position: sticky;
            left: 200px;
            z-index: 4;
            background-color: #f0f0f0;
            width: 120px;
        }
        .shift-schedule-table td:nth-child(3) {
            background-color: #fff;
        }
        .shift-schedule-table th:nth-child(4),
        .shift-schedule-table td:nth-child(4) {
            position: sticky;
            left: 320px;
            z-index: 4;
            background-color: #f0f0f0;
            width: 150px;
        }
        .shift-schedule-table td:nth-child(4) {
            background-color: #fff;
        }

        .shift-schedule-table thead th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
            padding: 8px 10px;
            font-size: 15px;
            border-color: #2980b9;
        }

        .shift-schedule-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        .shift-schedule-table td select {
            font-size: 13px;
            padding: 2px 5px;
            border-radius: 3px;
            display: block;
            width: 100%;
            box-sizing: border-box;
            text-align: left;
            border: 1px solid #ccc;
            background-color: #fdfdfd;
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23000000%22%20d%3D%22M287%2C197.9c-3.2%2C3.2-8.3%2C3.2-11.5%2C0L146.2%2C68.9L16.9%2C197.9c-3.2%2C3.2-8.3%2C3.2-11.5%2C0c-3.2-3.2-3.2-8.3%2C0-11.5l135.5-135.5c3.2-3.2%2C8.3-3.2%2C11.5%2C0l135.5%2C135.5C290.2%2C189.6%2C290.2%2C194.7%2C287%2C197.9z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 5px top 50%;
            background-size: 8px auto;
        }

        .shift-schedule-table td .break-display,
        .shift-schedule-table td .lunch-display {
            font-size: 13px;
            padding: 2px 5px;
            display: block;
            white-space: nowrap;
            color: #555;
            background-color: #f7f7f7;
            border: 1px solid #eee;
            border-radius: 3px;
            box-sizing: border-box;
        }

        .shift-schedule-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .shift-schedule-dashboard .dashboard-card-new {
            min-height: 200px;
        }

        /* New table for shift counts */
        .shift-counts-table-container {
            margin-top: 30px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            padding: 15px;
            overflow-x: auto;
        }

        .shift-counts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 15px;
        }

        .shift-counts-table th,
        .shift-counts-table td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
        }

        .shift-counts-table th {
            background-color: #e9ecef;
            color: #343a40;
            font-weight: 600;
        }
        .shift-counts-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>

    <div id="loginPage" class="page active">
        <div class="login-container">
            <h2>AMS Login</h2>
            <form id="loginForm">
                <div class="input-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" placeholder="your.email@example.com" required>
                </div>
                <div class="input-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" placeholder="********" required>
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
                <p id="loginError" class="error-message"></p>
            </form>
        </div>
    </div>

    <div id="appContainer" class="page">
        <aside class="sidebar">
            <div class="logo">AMS</div>
            <nav class="main-nav">
                <ul>
                    <li><a href="#" data-page="home"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#" data-page="attendance"><i class="fas fa-user-check"></i> Attendance Marking</a></li>
                    <li><a href="#" data-page="leaveTracker"><i class="fas fa-calendar-alt"></i> Leave Tracker</a></li>
                    <li><a href="#" data-page="shiftSchedule"><i class="fas fa-clock"></i> Shift Schedule</a></li> <li><a href="#" data-page="individualSummary"><i class="fas fa-user"></i> Individual Summary</a></li>
                    <li><a href="#" data-page="dashboard"><i class="fas fa-chart-line"></i> Dashboard</a></li>
                    <li><a href="#" data-page="reports"><i class="fas fa-file-alt"></i> Reports</a></li>
                    <li id="adminNavLink" style="display:none;"><a href="#" data-page="admin"><i class="fas fa-user-plus"></i> Admin</a></li>
                </ul>
            </nav>
            <button id="logoutBtn" class="btn btn-secondary logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</button>
        </aside>

        <main class="main-content">
            <div class="top-system-bar">
                ICEA LION Contact Centre Attendance Management
            </div>
            <header class="app-header">
                <h1>Welcome to Attendance Management System</h1>
                <div class="user-info">
                    <span>Hello, <strong id="loggedInUserName"></strong></span>
                    <span class="user-role" id="loggedInUserRole"></span>
                </div>
            </header>

            <div id="homePage" class="content-module active">
                <h2>Today's Statistics</h2>
                <hr>
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Present</h3>
                        <p id="statTotalPresent" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Total Staff</h3>
                        <p id="statTotalStaff" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Agents on Leave (Week)</h3>
                        <p id="statAgentsOnLeaveWeek" class="stat-value">0</p>
                    </div>
                    <div class="stat-card">
                        <h3>Agents on Sick Off (Week)</h3>
                        <p id="statAgentsOnSickOffWeek" class="stat-value">0</p>
                    </div>
                </div>

                <h3>Notifications</h3>
                <div class="notifications-list">
                    <div class="notification-item info">
                        <span class="notification-icon"><i class="fas fa-calendar-alt"></i></span>
                        <p>Staff on Leave This Week: <strong id="staffOnLeaveNames">No agents on leave.</strong></p>
                    </div>
                    <div class="notification-item warning">
                        <span class="notification-icon"><i class="fas fa-bed"></i></span>
                        <p>Agents on Sick Off This Week: <strong id="agentsOnSickOffNames">No agents on sick off.</strong></p>
                    </div>
                </div>
            </div>

            <div id="attendancePage" class="content-module">
                <h2>Mark Attendance</h2>
                <hr>
                <div class="mark-attendance-section">
                    <button id="openAttendanceCalendarBtn" class="btn btn-primary"><i class="fas fa-calendar-alt"></i> Select Date</button>
                    <div class="input-group">
                        <label for="attendanceDateInput">Selected Date:</label>
                        <input type="text" id="attendanceDateInput" placeholder="No date selected" readonly>
                    </div>
                    <p id="attendanceMarkingMessage" class="success-message" style="display:none; margin-top:10px;"></p>
                </div>

                <h2 style="margin-top: 40px;">Team Attendance Overview</h2>
                <hr>
                <div class="attendance-table-toolbar">
                    <button id="deleteAttendanceDataBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Delete Data</button>
                    <button id="exportAttendanceDataBtn" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export Data</button>
                </div>
                <div class="attendance-table-container" id="attendanceOverviewTableContainer">
                </div>
                <div class="attendance-status-guide">
                    <h3>Status Key:</h3>
                    <p><span class="status-indicator-guide status-WFO"></span> WFO: Work From Office</p>
                    <p><span class="status-indicator-guide status-WFH"></span> WFH: Work From Home</p>
                    <p><span class="status-indicator-guide status-SO"></span> SO: Signed Off</p>
                    <p><span class="status-indicator-guide status-L"></span> L: Leave (Annual)</p>
                    <p><span class="status-indicator-guide status-DO"></span> DO: Day Off</p>
                    <p><span class="status-indicator-guide status-UL"></span> UL: Unpaid Leave</p>
                    <p><span class="status-indicator-guide status-NCNS"></span> NCNS: No Call No Show</p>
                    <p><span class="status-indicator-guide status-CL"></span> CL: Compassionate Leave</p>
                    <p><span class="status-indicator-guide status-SOF"></span> SOF: Sick Off</p>
                </div>
            </div>

            <div id="leaveTrackerPage" class="content-module">
                <div class="leave-tracker-header">
                    <h2>Leave Tracker</h2>
                    <div>
                        <button id="prevMonthLeaveBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                        <h3 style="display:inline-block; margin: 0 15px;" id="currentLeaveMonthYear"></h3>
                        <button id="nextMonthLeaveBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
                <hr>
                <div class="leave-tracker-table-container" id="leaveTrackerTableContainer">
                </div>
            </div>

            <div id="shiftSchedulePage" class="content-module">
                <h2>Shift Schedule Management</h2>
                <hr>

                <div class="shift-schedule-controls">
                    <button id="prevMonthShiftScheduleBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-left"></i></button>
                    <h3 style="display:inline-block; margin: 0 15px;" id="currentShiftScheduleMonthYear"></h3>
                    <button id="nextMonthShiftScheduleBtn" class="btn btn-secondary btn-sm"><i class="fas fa-chevron-right"></i></button>
                    <div class="input-group" style="flex-basis: auto; flex-grow: 0; margin-left: auto;">
                        <label for="scheduleRoleFilter">Filter by Role:</label>
                        <select id="scheduleRoleFilter">
                            <option value="">All Roles</option>
                            <option value="Agent">Agent</option>
                            <option value="QA">QA</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Team Leader">Team Leader</option>
                            <option value="Admin">Admin</option>
                        </select>
                    </div>
                </div>

                <div class="shift-schedule-table-container">
                    <table class="shift-schedule-table">
                        <thead id="shiftScheduleTableHead">
                            </thead>
                        <tbody id="shiftScheduleTableBody">
                            </tbody>
                    </table>
                </div>

                <h3 style="margin-top: 40px;">Shift & Break Counts for Current Month</h3>
                <hr>
                <div class="shift-counts-table-container">
                    <table class="shift-counts-table" id="shiftCountsTable">
                        <thead>
                            <tr>
                                <th>Category</th>
                                <th>Item</th>
                                <th>Count</th>
                            </tr>
                        </thead>
                        <tbody id="shiftCountsTableBody">
                            </tbody>
                    </table>
                </div>

            </div>
            <div id="individualSummaryPage" class="content-module">
                <h2>Individual Attendance Summary</h2>
                <hr>
                <div class="individual-summary-controls">
                    <div class="input-group">
                        <label for="individualSelectSummary">Select Team Member:</label>
                        <select id="individualSelectSummary">
                            <option value="">Select Employee</option>
                        </select>
                    </div>
                </div>

                <div class="summary-stats-grid">
                    <div class="summary-stat-card">
                        <h4>Work From Office</h4>
                        <p class="count" id="summaryWFO">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Work From Home</h4>
                        <p class="count" id="summaryWFH">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>On Leave</h4>
                        <p class="count" id="summaryLeave">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>On Sick Off</h4>
                        <p class="count" id="summarySickOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Signed Off</h4>
                        <p class="count" id="summarySignedOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Day Off</h4>
                        <p class="count" id="summaryDayOff">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Unpaid Leave</h4>
                        <p class="count" id="summaryUnpaidLeave">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>No Call No Show</h4>
                        <p class="count" id="summaryNCNS">0</p>
                    </div>
                    <div class="summary-stat-card">
                        <h4>Compassionate Leave</h4>
                        <p class="count" id="summaryCompassionateLeave">0</p>
                    </div>
                </div>

                <div class="individual-summary-chart-container">
                    <h3>WFH vs WFO (Monthly Trend)</h3>
                    <div class="monthly-bar-chart" id="monthlyWFHWFOChart">
                        <p style="text-align: center; width: 100%; margin-top: 50px;">Select an employee to view chart data.</p>
                    </div>
                    <div class="chart-legend">
                        <div class="legend-item"><span class="legend-color-box" style="background-color: #007bff;"></span> WFO</div>
                        <div class="legend-item"><span class="legend-color-box" style="background-color: #28a745;"></span> WFH</div>
                    </div>
                </div>
            </div>


            <div id="dashboardPage" class="content-module">
                <h2 style="margin-bottom: 20px;">HR Employees Attendance Dashboard</h2>
                <div class="dashboard-container">
                    <div class="dashboard-header-row">
                        <div class="dashboard-header-card">
                            <i class="fas fa-calendar-alt"></i>
                            <div>
                                <div class="label">Start Date</div>
                                <div class="value" id="dashboardStartDate"></div>
                            </div>
                        </div>
                        <div class="dashboard-header-card employee-name">
                            <i class="fas fa-user"></i>
                            <div>
                                <div class="label">Employee Name</div>
                                <select id="employeeSelect" class="value">
                                    <option value="">All Employees</option>
                                </select>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-users"></i>
                            <div>
                                <div class="label">Total Employees</div>
                                <div class="value" id="dashboardTotalEmployees">0</div>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-times-circle"></i>
                            <div>
                                <div class="label">Absence Days</div>
                                <div class="value" id="dashboardAbsenceDays">0</div>
                            </div>
                        </div>
                        <div class="dashboard-header-card">
                            <i class="fas fa-calendar-times"></i>
                            <div>
                                <div class="label">Unapproved Leave</div>
                                <div class="value" id="dashboardUnapprovedLeave">0</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Attendance Statistics (Last 6 Months)</h3>
                        <div class="bar-chart-container" id="attendanceStatsChart">
                            <p style="text-align: center; width: 100%; margin-top: 50px;">No attendance data yet.</p>
                        </div>
                        <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; font-size:13px; color:#555;">
                            <span class="legend-item"><span class="legend-color-box on-time-bar"></span> Present</span>
                            <span class="legend-item"><span class="legend-color-box late"></span> Late/Partial</span>
                            <span class="legend-item"><span class="legend-color-box absent"></span> Absent</span>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Overall Attendance Percentage</h3>
                        <div class="gauge-container gauge-overall">
                            <div class="gauge">
                                <div class="gauge-fill" id="overallAttendanceGaugeFill"></div>
                            </div>
                            <div class="gauge-label" id="overallAttendanceGaugeLabel">0%</div>
                        </div>
                    </div>

                    <div class="dashboard-card-new">
                        <h3>Leave Taken (Total)</h3>
                        <div class="chart-grid">
                            <div>
                                <div class="value" id="leaveTakenSick">0</div> <div class="label">Sick Off</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenCasual">0</div> <div class="label">Compassionate</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenAnnual">0</div> <div class="label">Annual</div>
                            </div>
                            <div>
                                <div class="value" id="leaveTakenUnpaid">0</div> <div class="label">Unpaid</div>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new">
                        <h3>Working Location Distribution</h3>
                        <div class="donut-chart-container" id="workingLocationDonutChart">
                            <div class="donut-chart-center"></div>
                        </div>
                        <div class="donut-chart-label" id="workingLocationDonutLabel">0% Working From Office</div>
                        <div class="donut-legend">
                            <div class="donut-legend-item">
                                <span class="donut-legend-color" style="background-color: #007bff;"></span> Working From Office
                            </div>
                            <div class="donut-legend-item">
                                <span class="donut-legend-color" style="background-color: #28a745;"></span> Working From Home
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-card-new" style="grid-column: span 2;">
                        <h3>Top 5 Employees by Attendance</h3>
                        <div class="top-employees-chart" id="topEmployeesChart">
                            <p style="text-align: center; width: 100%; margin-top: 50px;">No employee data to display.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="reportsPage" class="content-module">
                <h2>Attendance Reports & Analytics</h2>
                <hr>
                <div class="report-filters">
                    <div class="input-group">
                        <label for="reportType">Report Type:</label>
                        <select id="reportType">
                            <option value="daily">Daily Summary</option>
                            <option value="tardiness">Tardiness Report</option>
                            <option value="absenteeism">Absenteeism Report</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="startDate">Start Date:</label>
                        <input type="date" id="startDate">
                    </div>
                    <div class="input-group">
                        <label for="endDate">End Date:</label>
                        <input type="date" id="endDate">
                    </div>
                    <button id="generateReportBtn" class="btn btn-primary"><i class="fas fa-chart-bar"></i> Generate Report</button>
                    <button id="exportReportCsvBtn" class="btn btn-secondary"><i class="fas fa-download"></i> Export to CSV</button>
                </div>

                <div class="report-results">
                    <h3>Generated Report</h3>
                    <table id="reportTable">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Present (WFO)</th>
                                <th>Present (WFH)</th>
                                <th>On Leave</th>
                                <th>On Sick Off</th>
                                <th>Signed Off</th>
                                <th>Day Off</th>
                                <th>Unpaid Leave</th>
                                <th>No Call No Show</th>
                                <th>Compassionate Leave</th>
                            </tr>
                        </thead>
                        <tbody id="reportsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="adminPage" class="content-module">
                <h2>Create System User Account</h2>
                <p>Use this section to create new user accounts that can log in to the Attendance Management System. These users can then be assigned roles and added as staff members to be managed in the attendance register.</p>
                <hr>
                <form id="addMemberForm">
                    <div class="input-group">
                        <label for="fullName">Full Name:</label>
                        <input type="text" id="fullName" placeholder="e.g., Alice Johnson" required>
                    </div>
                    <div class="input-group">
                        <label for="newEmail">Email:</label>
                        <input type="email" id="newEmail" placeholder="e.g., alice@example.com" required>
                    </div>
                    <div class="input-group">
                        <label for="newPassword">Password:</label>
                        <input type="password" id="newPassword" placeholder="********" required>
                    </div>
                    <div class="input-group">
                        <label for="memberRole">Role:</label>
                        <select id="memberRole" required>
                            <option value="">Select Role</option>
                            <option value="Agent">Agent</option>
                            <option value="QA">QA</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Admin">Admin</option>
                            <option value="Team Leader">Team Leader</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary"><i class="fas fa-user-plus"></i> Create System User</button>
                    <p id="addMemberMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                </form>

                <div class="staff-management-section">
                    <h2>Manage Attendance Roster</h2>
                    <p>This section allows you to add and manage staff members. Staff members are the people who appear on the attendance, leave, and shift schedule rosters. They are separate from system users who have login access.</p>
                    <hr>

                    <h3>Add New Staff Member</h3>
                    <form id="addStaffForm">
                        <div class="input-group">
                            <label for="staffFullName">Full Name:</label>
                            <input type="text" id="staffFullName" placeholder="e.g., Bob Williams" required>
                        </div>
                        <div class="input-group">
                            <label for="staffRole">Role:</label>
                            <select id="staffRole" required>
                                <option value="">Select Role</option>
                                <option value="Agent">Agent</option>
                                <option value="QA">QA</option>
                                <option value="Supervisor">Supervisor</option>
                                <option value="Team Leader">Team Leader</option>
                                <option value="Admin">Admin</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="staffSecondaryRole">Secondary Role:</label>
                            <select id="staffSecondaryRole">
                                <option value="">None</option>
                                <option value="Inbound">Inbound</option>
                                <option value="Inbound / Email">Inbound / Email</option>
                                <option value="Social Media">Social Media</option>
                                <option value="LiveChat">LiveChat</option>
                                <option value="Sales">Sales</option>
                                <option value="Onboarding">Onboarding</option>
                                <option value="Level 1 Escalations">Level 1 Escalations</option>
                                <option value="Email">Email</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-plus-circle"></i> Add Staff Member</button>
                        <p id="addStaffMessage" class="success-message" style="display:none; margin-top:15px;"></p>
                    </form>

                    <h3>System Users</h3>
                    <div class="staff-list-table-container">
                        <table class="staff-list-table">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="userListTableBody">
                            </tbody>
                        </table>
                    </div>

                    <h3 style="margin-top: 40px;">Staff Roster</h3>
                    <p>This table contains the staff members who can be selected in the attendance, leave, and shift schedule pages. Inactive staff members will not appear in the main application. You can only delete staff members who are not system users.</p>
                    <div class="staff-list-table-container">
                        <table class="staff-list-table">
                            <thead>
                                <tr>
                                    <th>Full Name</th>
                                    <th>Role</th>
                                    <th>Secondary Role</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="staffRosterTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="attendanceMarkingModal" class="modal">
        </div>

    <div id="calendarModal" class="modal">
        </div>

    <script>
        // Firebase Configuration (REPLACE WITH YOUR ACTUAL CONFIG)
        const firebaseConfig ={
            apiKey: "AIzaSyD9uPdQ7DfrKkOHyzcUnsJx5b2Fm51AdvY",
            authDomain: "attendance-d2f5c.firebaseapp.com",
            projectId: "attendance-d2f5c",
            storageBucket: "attendance-d2f5c.firebasestorage.app",
            messagingSenderId: "275359754293",
            appId: "1:275359754293:web:0fe5aa0f30d57c749ce97c",
            measurementId: "G-PWN5S35KTP"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- Global Variables / Caches ---
        let loggedInUser = null;
        let loggedInUserRole = 'Agent';
        let usersData = {};
        let staffData = {}; // New cache for staff members
        const attendanceData = {};
        const markedDates = new Set();
        let activeAgents = []; // Now based on `staffData`

        const todayGlobal = new Date();

        // --- DOM Element References ---
        let DOM = {};

        // --- Constants and Utility Data ---
        const ATTENDANCE_STATUSES = [
            { value: '', text: 'Select Status', colorClass: '' },
            { value: 'WFO', text: 'Work From Office', colorClass: 'status-WFO' },
            { value: 'WFH', text: 'Work From Home', colorClass: 'status-WFH' },
            { value: 'SO', text: 'Signed Off', colorClass: 'status-SO' },
            { value: 'L', text: 'Leave (Annual)', colorClass: 'status-L' },
            { value: 'DO', text: 'Day Off', colorClass: 'status-DO' },
            { value: 'UL', text: 'Unpaid Leave', colorClass: 'status-UL' },
            { value: 'NCNS', text: 'No Call No Show', colorClass: 'status-NCNS' },
            { value: 'CL', text: 'Compassionate Leave', colorClass: 'status-CL' },
            { value: 'SOF', text: 'Sick Off', colorClass: 'status-SOF' }
        ];

        const ALL_ROLES = ["Agent", "QA", "Supervisor", "Team Leader", "Admin"];
        const ALL_SECONDARY_ROLES = ['Inbound', 'Inbound / Email', 'Social Media', 'LiveChat', 'Sales', 'Onboarding', 'Level 1 Escalations', 'Email', 'None'];

        // --- Core Helper Functions ---

        function updateActiveAgentsList() {
            activeAgents = Object.values(staffData)
                .filter(staff => staff.isActive)
                .sort((a, b) => a.fullName.localeCompare(b.fullName));
            console.log("Active agents list updated:", activeAgents.length, "active agents.");
        }

        async function fetchAllUsersData() {
            usersData = {};
            try {
                const usersSnapshot = await db.collection('users').get();
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersData[doc.id] = { // Use doc.id (UID) as the key
                        uid: doc.id,
                        fullName: userData.fullName,
                        role: userData.role,
                        email: userData.email,
                        isActive: userData.isActive
                    };
                });
                console.log("All system user data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching users from Firestore:", error.code, error.message);
                alert("Critical: Could not load user list from database. Check console and Firebase rules.");
            }
        }

        async function fetchAllStaffData() {
            staffData = {};
            try {
                const staffSnapshot = await db.collection('staff').get();
                staffSnapshot.forEach(doc => {
                    const staffMember = doc.data();
                    staffData[doc.id] = {
                        staffId: doc.id,
                        fullName: staffMember.fullName,
                        role: staffMember.role,
                        secondaryRole: staffMember.secondaryRole,
                        isActive: staffMember.isActive,
                        // If you link staff to a user, you'd add the user's UID here
                        userId: staffMember.userId || null 
                    };
                });
                updateActiveAgentsList();
                console.log("All staff data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching staff from Firestore:", error.code, error.message);
                alert("Critical: Could not load staff list from database. Check console and Firebase rules.");
            }
        }

        async function fetchAttendanceData() {
            for (const key in attendanceData) {
                delete attendanceData[key];
            }
            markedDates.clear();

            try {
                const attendanceSnapshot = await db.collection('attendance').get();
                attendanceSnapshot.forEach(doc => {
                    attendanceData[doc.id] = doc.data();
                    markedDates.add(doc.id);
                });
                console.log("Attendance data loaded from Firestore.");
            } catch (error) {
                console.error("Error fetching attendance data:", error);
                alert("Critical: Could not load attendance data. Check console and Firebase rules.");
            }
        }

        function setLoggedInState(loggedIn, user = null, userProfile = null) {
            if (loggedIn && user && userProfile) {
                loggedInUser = user;
                loggedInUserRole = userProfile.role;

                DOM.loginPage.classList.remove('active');
                DOM.appContainer.classList.add('active');

                DOM.loggedInUserName.textContent = userProfile.fullName || user.email;
                DOM.loggedInUserRoleDisplay.textContent = userProfile.role;

                if (loggedInUserRole === 'Admin') {
                    DOM.adminNavLink.style.display = 'list-item';
                } else {
                    DOM.adminNavLink.style.display = 'none';
                }

                const currentPageHash = window.location.hash.substring(1);
                let targetPageId = 'homePage';
                if (currentPageHash && DOM[currentPageHash + 'Page']) {
                    targetPageId = currentPageHash + 'Page';
                }
                showPage(targetPageId);

                if (Object.keys(usersData).length === 0 || Object.keys(staffData).length === 0 || Object.keys(attendanceData).length === 0) {
                    Promise.all([
                        fetchAllUsersData(),
                        fetchAllStaffData(),
                        fetchAttendanceData(),
                        fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth()),
                        fetchShiftScheduleData(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth())
                    ]).then(() => {
                        updateHomeStatistics();
                        populateEmployeeSelect();
                        populateIndividualSummarySelect();
                        updateDashboardData(DOM.employeeSelect.value);
                        renderUserList();
                        renderStaffRoster();
                    }).catch(err => {
                        console.error("Error during initial data fetch:", err);
                        alert("Failed to load initial application data.");
                    });
                } else {
                    updateHomeStatistics();
                    populateEmployeeSelect();
                    populateIndividualSummarySelect();
                    updateDashboardData(DOM.employeeSelect.value);
                    renderUserList();
                    renderStaffRoster();
                    if (DOM.shiftSchedulePage.classList.contains('active')) {
                        fetchShiftScheduleData(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth());
                    }
                }
            } else {
                loggedInUser = null;
                loggedInUserRole = 'Agent';

                DOM.loginPage.classList.add('active');
                DOM.appContainer.classList.remove('active');
                DOM.loginForm.reset();
                DOM.loginError.textContent = '';
                DOM.loggedInUserName.textContent = '';
                DOM.loggedInUserRoleDisplay.textContent = '';
                DOM.adminNavLink.style.display = 'none';
            }
        }

        function showPage(pageId) {
            document.querySelectorAll('.content-module').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');

            DOM.navLinks.forEach(link => {
                if (link.dataset.page === pageId.replace('Page', '')) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });

            switch (pageId) {
                case 'attendancePage':
                    generateAttendanceOverviewTable();
                    DOM.attendanceDateInput.value = '';
                    DOM.openAttendanceCalendarBtn.disabled = false;
                    selectedMarkingDate = null;
                    break;
                case 'dashboardPage':
                    populateEmployeeSelect();
                    updateDashboardData(DOM.employeeSelect.value);
                    break;
                case 'leaveTrackerPage':
                    fetchLeaveData(currentLeaveTrackerDate.getFullYear(), currentLeaveTrackerDate.getMonth());
                    break;
                case 'shiftSchedulePage':
                    fetchShiftScheduleData(currentShiftScheduleDate.getFullYear(), currentShiftScheduleDate.getMonth());
                    break;
                case 'adminPage':
                    renderUserList();
                    renderStaffRoster();
                    break;
                case 'individualSummaryPage':
                    populateIndividualSummarySelect();
                    DOM.summaryWFO.textContent = '0';
                    DOM.summaryWFH.textContent = '0';
                    DOM.summaryLeave.textContent = '0';
                    DOM.summarySickOff.textContent = '0';
                    DOM.summarySignedOff.textContent = '0';
                    DOM.summaryDayOff.textContent = '0';
                    DOM.summaryUnpaidLeave.textContent = '0';
                    DOM.summaryNCNS.textContent = '0';
                    DOM.summaryCompassionateLeave.textContent = '0';
                    DOM.monthlyWFHWFOChart.innerHTML = '<p style="text-align: center; width: 100%; margin-top: 50px;">Select an employee to view chart data.</p>';
                    DOM.individualSelectSummary.value = '';
                    break;
                case 'reportsPage':
                    const today = new Date();
                    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
                    DOM.startDateInput.value = firstDayOfMonth;
                    DOM.endDateInput.value = lastDayOfMonth;
                    DOM.reportsTableBody.innerHTML = '';
                    break;
                case 'homePage':
                    updateHomeStatistics();
                    break;
            }
        }

        // --- Other functions (unchanged) ---
        // updateHomeStatistics(), renderCalendar(), populateModalAttendanceTable(),
        // saveAttendance(), generateAttendanceOverviewTable(), deleteAttendanceData(),
        // exportAttendanceDataToCSV(), populateEmployeeSelect(), populateIndividualSummarySelect(),
        // updateDashboardData(), renderAttendanceStatsChart(), renderWorkingLocationDonutChart(),
        // renderTopEmployeesChart(), updateIndividualSummary(), renderMonthlyWFHWFOChart(),
        // generateReportData(), renderReportTable(), exportReportToCSV()
        
        function renderUserList() {
            DOM.userListTableBody.innerHTML = '';
            const sortedUsers = Object.values(usersData).sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (sortedUsers.length === 0) {
                DOM.userListTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No system users found.</td></tr>`;
                return;
            }

            sortedUsers.forEach(user => {
                const tr = document.createElement('tr');
                const statusSelect = document.createElement('select');
                statusSelect.innerHTML = `
                    <option value="true" ${user.isActive ? 'selected' : ''}>Active</option>
                    <option value="false" ${!user.isActive ? 'selected' : ''}>Inactive</option>
                `;
                statusSelect.addEventListener('change', (e) => {
                    toggleUserStatus(user.uid, e.target.value === 'true');
                });

                const deleteButton = document.createElement('button');
                deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => {
                    deleteUser(user.uid);
                });

                tr.innerHTML = `
                    <td>${user.fullName}</td>
                    <td>${user.email}</td>
                    <td>${user.role}</td>
                    <td></td>
                    <td></td>
                `;
                tr.children[3].appendChild(statusSelect);
                tr.children[4].appendChild(deleteButton);
                DOM.userListTableBody.appendChild(tr);
            });
        }
        
        function renderStaffRoster() {
            DOM.staffRosterTableBody.innerHTML = '';
            const sortedStaff = Object.values(staffData).sort((a, b) => a.fullName.localeCompare(b.fullName));

            if (sortedStaff.length === 0) {
                DOM.staffRosterTableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No staff members found.</td></tr>`;
                return;
            }

            sortedStaff.forEach(staff => {
                const tr = document.createElement('tr');
                const statusSelect = document.createElement('select');
                statusSelect.innerHTML = `
                    <option value="true" ${staff.isActive ? 'selected' : ''}>Active</option>
                    <option value="false" ${!staff.isActive ? 'selected' : ''}>Inactive</option>
                `;
                statusSelect.addEventListener('change', (e) => {
                    toggleStaffStatus(staff.staffId, e.target.value === 'true');
                });
                
                const deleteButton = document.createElement('button');
                deleteButton.classList.add('btn', 'btn-danger', 'btn-sm');
                deleteButton.textContent = 'Delete';
                deleteButton.addEventListener('click', () => {
                    deleteStaff(staff.staffId);
                });

                tr.innerHTML = `
                    <td>${staff.fullName}</td>
                    <td>${staff.role}</td>
                    <td>${staff.secondaryRole}</td>
                    <td></td>
                    <td></td>
                `;
                tr.children[3].appendChild(statusSelect);
                tr.children[4].appendChild(deleteButton);
                DOM.staffRosterTableBody.appendChild(tr);
            });
        }
        
        async function toggleUserStatus(uid, isActive) {
            const userToUpdate = usersData[uid];
            if (userToUpdate) {
                if (loggedInUser.uid === uid && !isActive) {
                    alert("You cannot deactivate your own account while logged in.");
                    renderUserList();
                    return;
                }
                try {
                    await db.collection('users').doc(uid).update({ isActive: isActive });
                    usersData[uid].isActive = isActive;
                    renderUserList();
                    alert(`User status for ${userToUpdate.fullName} updated to ${isActive ? 'Active' : 'Inactive'}.`);
                } catch (error) {
                    console.error("Error toggling user status:", error);
                    alert(`Failed to change status for ${userToUpdate.fullName}: ${error.message}`);
                }
            } else {
                alert("User not found or UID is missing.");
            }
        }
        
        async function toggleStaffStatus(staffId, isActive) {
            const staffToUpdate = staffData[staffId];
            if (staffToUpdate) {
                try {
                    await db.collection('staff').doc(staffId).update({ isActive: isActive });
                    staffData[staffId].isActive = isActive;
                    updateActiveAgentsList();
                    renderStaffRoster();
                    alert(`Staff member status for ${staffToUpdate.fullName} updated to ${isActive ? 'Active' : 'Inactive'}.`);
                } catch (error) {
                    console.error("Error toggling staff status:", error);
                    alert(`Failed to change status for ${staffToUpdate.fullName}: ${error.message}`);
                }
            } else {
                alert("Staff member not found.");
            }
        }
        
        async function deleteUser(uid) {
            const userToDelete = usersData[uid];
            if (!userToDelete) {
                alert("User not found.");
                return;
            }
            if (loggedInUser.uid === uid) {
                alert("You cannot delete your own account while logged in.");
                return;
            }
            const confirmDelete = confirm(`Are you sure you want to delete the system user account for ${userToDelete.fullName}? This will permanently remove their login access.`);
            if (!confirmDelete) return;

            try {
                // Deleting user auth account is complex and best done via Cloud Functions.
                // For this example, we just delete the user's profile from Firestore.
                await db.collection('users').doc(uid).delete();
                delete usersData[uid];
                renderUserList();
                alert(`System user account for ${userToDelete.fullName} deleted successfully.`);
            } catch (error) {
                console.error("Error deleting user:", error);
                alert(`Failed to delete user account: ${error.message}`);
            }
        }

        async function deleteStaff(staffId) {
            const staffToDelete = staffData[staffId];
            if (!staffToDelete) {
                alert("Staff member not found.");
                return;
            }
            const confirmDelete = confirm(`Are you sure you want to delete the staff member ${staffToDelete.fullName}? This will also remove them from all attendance, leave, and shift schedule rosters.`);
            if (!confirmDelete) return;

            try {
                const batch = db.batch();
                
                // 1. Delete staff document
                batch.delete(db.collection('staff').doc(staffId));
                
                // 2. Remove from attendance records
                const attendanceSnapshot = await db.collection('attendance').get();
                attendanceSnapshot.forEach(doc => {
                    const docData = doc.data();
                    if (docData[staffToDelete.fullName]) {
                        const updatedData = { ...docData };
                        delete updatedData[staffToDelete.fullName];
                        if (Object.keys(updatedData).length > 0) {
                            batch.update(db.collection('attendance').doc(doc.id), updatedData);
                        } else {
                            batch.delete(db.collection('attendance').doc(doc.id));
                        }
                    }
                });

                // 3. Remove from leave records
                const leavesSnapshot = await db.collection('leaves').get();
                leavesSnapshot.forEach(doc => {
                    const monthDocData = doc.data();
                    if (monthDocData.data && Array.isArray(monthDocData.data)) {
                        const updatedData = monthDocData.data.filter(row => row.Name !== staffToDelete.fullName);
                        if (updatedData.length !== monthDocData.data.length) {
                            if (updatedData.length > 0) {
                                batch.update(db.collection('leaves').doc(doc.id), { data: updatedData });
                            } else {
                                batch.delete(db.collection('leaves').doc(doc.id));
                            }
                        }
                    }
                });
                
                // 4. Remove from shift schedule records
                const shiftRostersSnapshot = await db.collection('shiftRosters').get();
                shiftRostersSnapshot.forEach(doc => {
                    const monthRosterData = doc.data();
                    if (monthRosterData.roster && Array.isArray(monthRosterData.roster)) {
                        const updatedRoster = monthRosterData.roster.filter(entry => entry.agentName !== staffToDelete.fullName);
                        if (updatedRoster.length !== monthRosterData.roster.length) {
                            if (updatedRoster.length > 0) {
                                batch.update(db.collection('shiftRosters').doc(doc.id), { roster: updatedRoster });
                            } else {
                                batch.delete(db.collection('shiftRosters').doc(doc.id));
                            }
                        }
                    }
                });
                
                await batch.commit();
                
                delete staffData[staffId];
                updateActiveAgentsList();
                renderStaffRoster();
                alert(`Staff member ${staffToDelete.fullName} and their associated data deleted successfully.`);
                
            } catch (error) {
                console.error("Error deleting staff member:", error);
                alert(`Failed to delete staff member: ${error.message}`);
            }
        }

        // --- Event Listener Initialization ---
        function initializeEventListeners() {
            // ... (login, logout, navigation, attendance, etc. event listeners remain the same) ...
            
            // New event listener for adding staff members
            DOM.addStaffForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                DOM.addStaffMessage.style.display = 'none';
                const fullName = DOM.staffFullNameInput.value.trim();
                const role = DOM.staffRoleSelect.value;
                const secondaryRole = DOM.staffSecondaryRoleSelect.value;

                if (!fullName || !role) {
                    DOM.addStaffMessage.textContent = 'Full Name and Role are required!';
                    DOM.addStaffMessage.style.color = '#dc3545';
                    DOM.addStaffMessage.style.display = 'block';
                    return;
                }

                try {
                    await db.collection('staff').add({
                        fullName: fullName,
                        role: role,
                        secondaryRole: secondaryRole || 'None',
                        isActive: true,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    DOM.addStaffMessage.textContent = `Staff member ${fullName} added successfully!`;
                    DOM.addStaffMessage.style.color = '#28a745';
                    DOM.addStaffMessage.style.display = 'block';
                    DOM.addStaffForm.reset();
                    
                    await fetchAllStaffData();
                    renderStaffRoster();
                } catch (error) {
                    console.error("Error adding staff member:", error);
                    DOM.addStaffMessage.textContent = `Error adding staff member: ${error.message}`;
                    DOM.addStaffMessage.style.color = '#dc3545';
                    DOM.addStaffMessage.style.display = 'block';
                }
            });
            
            // ... (rest of the event listeners) ...
        }

        // --- DOMContentLoaded and Initial Setup ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Assign DOM elements to the DOM object
            DOM = {
                // ... (existing DOM elements) ...
                
                // Admin Page Elements
                addMemberForm: document.getElementById('addMemberForm'),
                fullNameInput: document.getElementById('fullName'),
                newEmailInput: document.getElementById('newEmail'),
                newPasswordInput: document.getElementById('newPassword'),
                memberRoleSelect: document.getElementById('memberRole'),
                addMemberMessage: document.getElementById('addMemberMessage'),
                userListTableBody: document.getElementById('userListTableBody'),
                
                addStaffForm: document.getElementById('addStaffForm'),
                staffFullNameInput: document.getElementById('staffFullName'),
                staffRoleSelect: document.getElementById('staffRole'),
                staffSecondaryRoleSelect: document.getElementById('staffSecondaryRole'),
                addStaffMessage: document.getElementById('addStaffMessage'),
                staffRosterTableBody: document.getElementById('staffRosterTableBody'),
                
                // ... (rest of the DOM elements) ...
            };

            initializeEventListeners();
            initializeWorkforceEventListeners(); // Initialize new event listeners
            // ... (Firebase Auth State Listener) ...
        });
    </script>
</body>
</html>
